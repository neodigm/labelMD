var app=angular.module("app",["ngRoute","ngCookies","ngSanitize","ngAnimate","ui.bootstrap","pascalprecht.translate","ui.router","ngStorage","focus-if","angular-simple-sidebar","ngTouch","cfp.hotkeys","ngProgress"]);app.run(function($state,$rootScope,$window,ApplicationFactory,SessionFactory,HooksFactory,$http){$rootScope.apiPath=applicationDefaults.eGainChatApiPath;var locale=ApplicationFactory.GetUrlParameter("locale");$window.HooksFactory=HooksFactory;$rootScope.locale=locale?ApplicationFactory.GetCaseSensitiveLocale(locale):"en-US";ApplicationFactory.SendMultiSubDomainSupportConfigToParent();if(ApplicationFactory.isPoppedOut()){ApplicationFactory.PersistToParentStorage("egPopoutWindow","true","session")}ApplicationFactory.ValidateApplicationState().then(function(isValid){ApplicationFactory.InitializeApplicationState();if(isValid){processChatData($rootScope,$state,$window,ApplicationFactory,SessionFactory,$http)}else{$state.go("chat.error")}},function(){})});var processChatData=function($rootScope,$state,$window,ApplicationFactory,SessionFactory,$http){var isSmallDevice=ApplicationFactory.CheckMobile();var egChatSessionId=ApplicationFactory.GetUrlParameter("egSessionId");var egLastRequestId=ApplicationFactory.GetUrlParameter("egLastRequestId");var isVAEnabled=ApplicationFactory.GetUrlParameter("VAEnabled")==="true"?true:false;var egVASessionId=ApplicationFactory.GetUrlParameter("VASessionId");var egVANodeId=ApplicationFactory.GetUrlParameter("VANodeId");var egVAActive=ApplicationFactory.GetUrlParameter("VAActive")==="true"?true:false;var egVAEscalated=ApplicationFactory.GetUrlParameter("VAEscalated")==="true"?true:false;var egOffRecordBtnState=ApplicationFactory.GetUrlParameter("egOffRecordBtnState")==="true"?true:false;var isChatAttachmentEnabled=ApplicationFactory.GetUrlParameter("isChatAttachmentEnabled");var parentLostWhileChatInProgressInPopout=ApplicationFactory.GetUrlParameter("parentLost")==="true";if(true===ApplicationFactory.IsDocked()||true===ApplicationFactory.isPoppedOut()){ApplicationFactory.RetrieveFromParentStorage("egSessionId",processChat)}else{processChat()}function processChat(data){if(data){egChatSessionId=data}var isNewChat=egChatSessionId===null||egLastRequestId===null;ApplicationFactory.GetXEgainSessionIDOnLoad();if(true===ApplicationFactory.isPoppedOut()){var saveSessionId=ApplicationFactory.RetrieveFromStorage("egSessionId","session");if(saveSessionId&&saveSessionId===egChatSessionId){isNewChat=true}}else if(true===ApplicationFactory.IsUndocked()){egChatSessionId=ApplicationFactory.GetParameterFromUrlOrStorage("egSessionId");egLastRequestId=ApplicationFactory.GetCookie("egain-last-success-request-id");egLastRequestId=egLastRequestId?""+(parseInt(egLastRequestId)+1):null;var isInProgressFlagInLocal=ApplicationFactory.GetParameterFromUrlOrStorage("isUnDockedChatInProgress")=="true";egOffRecordBtnState=ApplicationFactory.GetParameterFromUrlOrStorage("egOffRecordBtnState")==="true"?true:false;isChatAttachmentEnabled=ApplicationFactory.GetParameterFromUrlOrStorage("isChatAttachmentEnabled");isNewChat=egChatSessionId===null||egLastRequestId===null;if(isInProgressFlagInLocal){isNewChat=true}}if(egVASessionId){isNewChat=false}$rootScope.isSmallDevice=isSmallDevice;$rootScope.isDocked=ApplicationFactory.IsDocked();$rootScope.isLargeDevice=!$rootScope.isSmallDevice;if(isNewChat){if(!true===ApplicationFactory.IsUndocked()){SessionFactory.ClearSessionState()}if(isVAEnabled){$state.go("launch-va",{launchVA:true})}else{$state.go("launch-chat",{launchChat:true})}}else{if(egVAActive||egVAEscalated){SessionFactory.SetVASessionId(egVASessionId);SessionFactory.SetVANodeId(egVANodeId)}if(egVAActive){$state.go("attach")}else if(true===parentLostWhileChatInProgressInPopout){isSessionStillActive(egChatSessionId,$http,$state,SessionFactory)}else{var chatSessionData={sessionID:egChatSessionId,lastRequestId:egLastRequestId,OffRecordBtnState:egOffRecordBtnState};SessionFactory.SetSessionState(chatSessionData,egLastRequestId);$state.go("attach")}if(isChatAttachmentEnabled){SessionFactory.SetChatTransferredFlag(true);SessionFactory.SetChatAttachmentEnabledFlag(isChatAttachmentEnabled==="true")}else{SessionFactory.SetChatTransferredFlag(false)}}}};var isSessionStillActive=function(chatId,$http,$state,SessionFactory){if(chatId){var req={method:"POST",url:applicationDefaults.eGainChatApiPath+"/egain/chat/entrypoint/transcript",data:{sid:chatId},headers:{Accept:"application/json","Content-Type":"application/json"}};$http(req).then(function(response){},function(error){if("400-115"===error.data.code){SessionFactory.ClearSessionState();$state.go("launch-chat",{launchChat:true})}})}};app.config(function($stateProvider){var services={ApplicationFactory:"ApplicationFactory",ConfigFactory:"ConfigFactory",ConnectionFactory:"ConnectionFactory",CustomerFactory:"CustomerFactory",ChatHeaderFactory:"ChatHeaderFactory",SessionFactory:"SessionFactory",VideoFactory:"VideoFactory",AttachmentFactory:"AttachmentFactory"};$stateProvider.state("launch-va",{templateUrl:applicationDefaults.eGainContextPath+"pages/va-landing/va-landing.html",resolve:services,params:{launchVA:false}}).state("launch-chat",{templateUrl:applicationDefaults.eGainContextPath+"pages/chat-landing/chat-landing.html",resolve:services,params:{launchChat:false,nextChatState:null}}).state("chat",{templateUrl:applicationDefaults.eGainContextPath+"pages/chat-main/chat-main.html",resolve:services,params:{currentLocale:applicationDefaults.eGainChatDefaultLocale,entryPointId:applicationDefaults.eGainChatEntryPointId}}).state("initialize",{templateUrl:applicationDefaults.eGainContextPath+"pages/chat-initialize/chat-initialize.html",resolve:services,params:{currentLocale:applicationDefaults.eGainChatDefaultLocale,entryPointId:applicationDefaults.eGainChatEntryPointId}}).state("attach",{templateUrl:applicationDefaults.eGainContextPath+"pages/chat-attach/chat-attach.html",resolve:services}).state("chat.pre-chat",{templateUrl:applicationDefaults.eGainContextPath+"pages/pre-chat/pre-chat.html",params:{VAEscalated:false,VAShowPreChat:false}}).state("chat.interaction",{templateUrl:applicationDefaults.eGainContextPath+"pages/interaction/interaction.html",params:{attachedChat:false,chatConnectionInfo:null}}).state("chat.post-chat",{templateUrl:applicationDefaults.eGainContextPath+"pages/post-chat/post-chat.html"}).state("chat.thank-you",{templateUrl:applicationDefaults.eGainContextPath+"pages/thanks-message/thanks-message.html"}).state("chat.deflection",{templateUrl:applicationDefaults.eGainContextPath+"pages/chat-deflection/chat-deflection.html",params:{customer:{},oneTagCustomerInfo:{}}}).state("chat.deflection.escalation-results",{template:"<div ng-include=\"'components/escalation-search-results-list/escalation-search-results-list.html'\"></div>"}).state("chat.deflection.article",{template:"<div ng-include=\"'components/article-content/article-content.html'\"></div>",params:{articleId:null,searchTerm:null}}).state("chat.chat-unavailable",{templateUrl:applicationDefaults.eGainContextPath+"pages/chat-unavailable/chat-unavailable.html",params:{condition:null}}).state("chat.error",{templateUrl:applicationDefaults.eGainContextPath+"pages/error/error.html",params:{errorCode:null,errorMsg:null}})}).config(["$translateProvider",function($translateProvider){$translateProvider.useStaticFilesLoader({prefix:applicationDefaults.eGainContextPath+"l10n/",suffix:".json"});$translateProvider.preferredLanguage(applicationDefaults.eGainChatDefaultLocale);$translateProvider.useSanitizeValueStrategy("sceParameters")}]).config(["$sessionStorageProvider",function($sessionStorageProvider){}]).config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("HttpInterceptorFactory")}]).config(["$compileProvider",function($compileProvider){$compileProvider.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|blob):|data:image\//);$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|blob|mailto):|data:image\//)}]);app.directive("egChatLaunchButton",["$state","$stateParams","$rootScope","ApplicationFactory","VAFactory",function($state,$stateParams,$rootScope,ApplicationFactory,VAFactory){return{link:function($scope,$element,attrs){$element.ready(function(){if(!$rootScope.isSmallDevice){var lout;$element.bind("mouseover",function(event,data){$element.addClass("egain-hover");clearTimeout(lout);lout=setTimeout(function(){var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_LAUNCH_HOVER","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize)},0)});$element.bind("mouseout",function(event,data){$element.removeClass("egain-hover");clearTimeout(lout);lout=setTimeout(function(){var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_LAUNCH_HOVER_OUT","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize)},800)})}var launchButtonHandler=function(event,data){event.preventDefault();var enableTrackerMsg=ApplicationFactory.CreatePayload("NOTIFY","EG_ENABLE_TRACKER","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(enableTrackerMsg);if($stateParams.launchVA){VAFactory.SetVAActive(true);if(ApplicationFactory.GetUrlParameter("proactiveDockedOffer")==="1"){var acceptEventData={};acceptEventData={reason:ApplicationFactory.GetUrlParameter("reason"),bannerid:ApplicationFactory.GetUrlParameter("bannerid"),ruleId:ApplicationFactory.GetUrlParameter("ruleId"),interactionId:ApplicationFactory.GetUrlParameter("interactionId"),proactiveDocked:"1"};ApplicationFactory.PostMessageToParent(acceptEventData)}$state.go("chat.interaction")}else{ApplicationFactory.initializeChat();if($scope.page.OnetagFailure===true){$state.go("chat.error",{errorCode:"ONETAG_FAILURE"});return}if(ApplicationFactory.GetUrlParameter("proactiveDockedOffer")==="1"){var acceptEventData={};acceptEventData={reason:ApplicationFactory.GetUrlParameter("reason"),bannerid:ApplicationFactory.GetUrlParameter("bannerid"),ruleId:ApplicationFactory.GetUrlParameter("ruleId"),interactionId:ApplicationFactory.GetUrlParameter("interactionId"),proactiveDocked:"1"};ApplicationFactory.PostMessageToParent(acceptEventData)}}};if(!$rootScope.isSmallDevice){var launchButtonInputs=$element[0].querySelector(".chat-launch-input-container");if(launchButtonInputs){angular.element(launchButtonInputs).bind("click",launchButtonHandler)}$element.bind("keydown",function(event){var code=event.keyCode||event.which;if(code===13){launchButtonHandler(event)}})}else{$element.bind("click",launchButtonHandler)}})},restrict:"A"}}]);app.directive("egToolbar",["$window","$filter","$rootScope","$timeout","ConnectionFactory","ConfigFactory","TranscriptFactory","VideoFactory","ApplicationFactory",function($window,$filter,$rootScope,$timeout,ConnectionFactory,ConfigFactory,TranscriptFactory,VideoFactory,ApplicationFactory){function download(data,filename,type){if(MobileInterface){MobileInterface.SaveTranscript(data)}else{var a=document.createElement("a"),file=new Blob([data],{type:type});if(window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(file,filename)}else if(ApplicationFactory.IsVisitorIOSPhone()||ApplicationFactory.IsVisitorIOSTablet()){if(navigator.userAgent.indexOf("FxiOS")>-1){var reader=new FileReader;var url=[window.location.protocol,"//",window.location.host,applicationDefaults.eGainChatApiPath,"/templates/chat/",ApplicationFactory.GetUrlParameter("templateName"),"/transcript/blank.html"].join("");var transcriptWindow=window.open(url);reader.onloadend=function(e){transcriptWindow.document.write(data);transcriptWindow.document.close()};reader.readAsDataURL(file)}else{var reader=new FileReader;var transcriptWindow=window.open();reader.onloadend=function(e){var url=reader.result.replace(/^data:[^;]*;/,"data:text/html;");transcriptWindow.location.href=url};reader.readAsDataURL(file)}}else{var url=URL.createObjectURL(file);a.href=url;a.download=filename;document.body.appendChild(a);a.click();setTimeout(function(){document.body.removeChild(a);window.URL.revokeObjectURL(url)},50)}}}function getTranscript(){var content=new Array;return TranscriptFactory.GetTranscript().then(function(transcriptContent){content.push(transcriptContent);content.push("</body></html>");var transcriptContent=content.join(" ");var parser=new DOMParser;var transcriptDoc=parser.parseFromString(transcriptContent,"text/html");var chatMessagesStr=transcriptDoc.getElementById("chatMessages").innerHTML;chatMessagesStr=chatMessagesStr.replace(/onclick\s*=\s*[\"\'].*?[\"\']/gi,"");chatMessagesStr=chatMessagesStr.replace(/<script.*?\/script>/gi,"");chatMessagesStr=chatMessagesStr.replace(/<a.*?>/gi,"<u>");chatMessagesStr=chatMessagesStr.replace(/<\/a>/gi," </u>");transcriptDoc.getElementById("chatMessages").innerHTML=chatMessagesStr;return transcriptDoc.documentElement.innerHTML})}function saveTranscript(){getTranscript().then(function(contentVal){var div=document.createElement("div");div.setAttribute("id","chatTranscript");div.innerHTML=contentVal;var x=div.getElementsByTagName("img");var protocol=document.location.protocol;var hostname=document.location.hostname;var baseUrl=protocol+"//"+hostname;for(var i=0;i<x.length;i++){var url=div.getElementsByTagName("img").item(i).getAttribute("src");url=ApplicationFactory.addBaseURL(url,baseUrl);div.getElementsByTagName("img").item(i).setAttribute("src",url)}contentVal=div.innerHTML;var sysdate=$filter("date")(new Date,"MMMdd_yyyy_hhmma");download(contentVal,"transcript_"+sysdate+".htm","html")})}return{link:function(scope,$element,attrs){var knowledgeBaseUrl=ConfigFactory.GetChatConfigurations().KnowledgeBaseUrl;var knowledgeBaseUrlTarget=ConfigFactory.GetChatConfigurations().KnowledgeBaseUrlTarget;$element.bind("click",function(event,data){var elementId=event.target.id;if(""===elementId){elementId=event.target.parentElement?event.target.parentElement.id:""}if(elementId==="egain-save-transcript"){event.preventDefault();scope.page.menuexpanded=false;var oneTagEventInfo=ConnectionFactory.GetConnection().connected?{EventName:"ChatMenuButton",ButtonDesc:"Save"}:{EventName:"ChatSurveyMenuButton",ButtonDesc:"Save-Transcript"};eGainOneTagUtil.pushChatEvent("uac",oneTagEventInfo);saveTranscript()}if(elementId==="egain-faq"){var subject=$rootScope.subject?$rootScope.subject:"";event.preventDefault();var oneTagEventInfo=ConnectionFactory.GetConnection().connected?{EventName:"ChatMenuButton",ButtonDesc:"FAQ"}:{EventName:"ChatSurveyMenuButton",ButtonDesc:"FAQ"};eGainOneTagUtil.pushChatEvent("uac",oneTagEventInfo);scope.page.menuexpanded=false;if(knowledgeBaseUrl&&knowledgeBaseUrl.length>0){var isDocked=ApplicationFactory.IsDocked();var url="";if(knowledgeBaseUrl.indexOf("<search_text>")!=-1){url=knowledgeBaseUrl.replace("<search_text>",encodeURIComponent(subject))}else{url=knowledgeBaseUrl}var target=knowledgeBaseUrlTarget;switch(target){case"_new":$window.open(url);break;case"_parent":if(isDocked){parent.window.location.href=url}else{if(window.opener){window.opener.location.href=url}}break;default:$window.open(url);break}}}if(elementId==="egain-off-record"){event.preventDefault();var oneTagEventInfo={EventName:"ChatOffRecord"};eGainOneTagUtil.pushChatEvent("uac",oneTagEventInfo);scope.offRecord=!scope.offRecord;scope.addRemoveToolbarButton("offRecord",false);scope.addRemoveToolbarButton("onRecord",true);scope.enableAttachmentLink(true);scope.$apply()}if(elementId==="egain-on-record"){event.preventDefault();scope.offRecord=!scope.offRecord;scope.addRemoveToolbarButton("offRecord",true);scope.addRemoveToolbarButton("onRecord",false);scope.enableAttachmentLink(false);scope.$apply()}if(elementId==="egain-video-chat"){event.preventDefault();VideoFactory.VideoClick()}if(elementId==="egain-audio-chat"){event.preventDefault();VideoFactory.AudioClick()}})},restrict:"AEC"}}]);app.directive("closelink",["$window","ApplicationFactory","ConnectionFactory","SessionFactory","VAFactory","hotkeys",function($window,ApplicationFactory,ConnectionFactory,SessionFactory,VAFactory,hotkeys){return{link:function($scope,$element,attrs){var confirmMessage="";ApplicationFactory.Translate("APP.EG_CONFIRM_CLOSE_CHAT").then(function(result){confirmMessage=result});var endChat=function(element){if(ConnectionFactory.GetConnection().connected){if(element){var closeBtn=angular.element(element);if(closeBtn){closeBtn.addClass("disabled")}}ConnectionFactory.IsNetworkConnectionActive().then(function(response){if(false===response){ConnectionFactory.ShowConnectionErrorMessage();return}if(closeBtn&&true===closeBtn.hasClass("disabled")){closeBtn.removeClass("disabled")}if(confirm(confirmMessage)){$window.clearInterval($window.myIntervalId);eGainOneTagUtil.pushChatEvent("uac",{EventName:"ChatExit","Termination-Initiation":"User"});ConnectionFactory.EndChat()}})}else if(VAFactory.IsVAActive()){if(confirm(confirmMessage)){SessionFactory.ClearSessionState();ApplicationFactory.ResetChat();if(!ApplicationFactory.IsDocked()){$window.close()}}}else{SessionFactory.ClearSessionState();ApplicationFactory.ResetChat();if(!ApplicationFactory.IsDocked()){$window.close()}}};hotkeys.add({combo:"esc",description:"Close chat",callback:function(){endChat()}});$element.on("click",function(){if(MobileInterface){MobileInterface.SendCloseButtonClicked()}endChat(this)})},restrict:"A"}}]);app.directive("messagesubmit",["$rootScope","$timeout","ApplicationFactory","ConfigFactory","VAFactory",function($rootScope,$timeout,ApplicationFactory,ConfigFactory,VAFactory){return{restrict:"A",link:function($scope,$element,$attrs){$scope.isCustomerTyping=false;var chatConfig=ConfigFactory.GetChatConfigurations();var setTypingStatus=function(){$timeout(function(){try{var maxCharacterCount=chatConfig.MaxMessageSize;var currentCount=0;currentCount=$scope.customerMessage.length;var remainderCount=maxCharacterCount-currentCount;if(remainderCount<=50){$scope.showTypingStatus=true;$scope.characterCountRemaining=remainderCount}else{$scope.showTypingStatus=false}}catch(error){}},0)};$element.bind("keydown",function(event){var code=event.keyCode||event.which;if(!VAFactory.IsVAActive()){if($scope.scp.customerTypingTimer){$timeout.cancel($scope.scp.customerTypingTimer);$scope.scp.customerTypingTimer=null}else{$scope.sendCustomerStartTypingStatus();$scope.isCustomerTyping=true}$scope.scp.customerTypingTimer=$timeout(function(){if($scope.scp.customerTypingTimer){$scope.sendCustomerStopTypingStatus()}$scope.scp.customerTypingTimer=null},chatConfig.CustomerNoTypingTimeout)}if(code===13&&!event.shiftKey){event.preventDefault();$scope.$apply(function(){$scope.processAndSendMessage(event)})}if(code===9){$scope.focusTextArea=false}setTypingStatus()});var chatWindow=angular.element(document.querySelector("#egain-chat-overlay"));var is_landscape=false;var updateView=function(){is_landscape=screen.height<screen.width;if(is_landscape){chatWindow.addClass("message-edit-wrapper")}else{chatWindow.removeClass("message-edit-wrapper")}};$element.bind("focus",function(event){$scope.isEditiorFocussed=true;setTypingStatus();if($rootScope.isSmallDevice){updateView();window.addEventListener("resize",updateView,false)}});$element.bind("blur",function(event){$scope.isEditiorFocussed=false;if($rootScope.isSmallDevice){chatWindow.removeClass("message-edit-wrapper");window.removeEventListener("resize",updateView,false)}});$element.bind("keyup",function(event){});if($rootScope.isLargeDevice){$element.ready(function(){$element[0].focus()})}}}}]);app.directive("egLoginParams",["$timeout","$filter","ConfigFactory",function($timeout,$filter,ConfigFactory){return{restrict:"A",link:function($scope,$element,$attrs){if($scope.$last){$scope.preChatForm.loaded=true}}}}]);app.directive("egFormInput",["$timeout","$rootScope","ApplicationFactory",function($timeout,$rootScope,ApplicationFactory){return{restrict:"A",scope:{submitEnter:"=",egFormInput:"="},link:function($scope,$element,$attrs){if($attrs.checkOnLoad==="true"){$scope.$watch("isReady",function(newValue,oldValue){if(newValue===true){$timeout(function(){try{$scope.countAttr=$element.val().length}catch(error){}})}})}if($rootScope.isSmallDevice){var isAndroid=false;if(ApplicationFactory.IsVisitorAndroid()){isAndroid=true}var is_landscape=false;var chatWindow=angular.element(document.querySelector("#egain-chat-overlay"));var $el=$element[0];var doneBtn=angular.element($el.parentNode.getElementsByClassName("egain-done-btn")[0]);var updateView=function(){if(isAndroid){is_landscape=screen.height<screen.width}else{is_landscape=!(window.innerHeight>window.innerWidth)}if(is_landscape){chatWindow.addClass("form-edit-wrapper");angular.element($el.parentNode).addClass("edit-wrapper");document.body.scrollTop=document.documentElement.scrollTop=0}else{chatWindow.removeClass("form-edit-wrapper");angular.element($el.parentNode).removeClass("edit-wrapper")}};$element.bind("focus",function(){updateView();window.addEventListener("resize",updateView,false)});doneBtn.bind("click",function(){chatWindow.removeClass("form-edit-wrapper");window.removeEventListener("resize",updateView,false);angular.element($el.parentNode).removeClass("edit-wrapper")});$element.bind("blur",function(event){chatWindow.removeClass("form-edit-wrapper");window.removeEventListener("resize",updateView,false);angular.element($el.parentNode).removeClass("edit-wrapper")})}$element.bind("keydown",function(event){if($scope.egFormInput&&$scope.egFormInput.error){$scope.$apply(function(){$scope.egFormInput.error=false})}if(event.keyCode==13&&!event.shiftKey){event.preventDefault();$scope.submitEnter=true;$scope.$apply();return false}})}}}]);app.directive("egChatTranscript",["$window","MessageFactory","AttachmentFactory","VideoFactory",function($window,MessageFactory,AttachmentFactory,VideoFactory){return{link:function(scope,element,attrs){scope.page.isScrolledToBottom=function(){var contentDiv=document.querySelector(".egain-chat-content");if(Math.round(contentDiv.scrollHeight-contentDiv.offsetHeight)-Math.round(contentDiv.scrollTop)<=1){return true}return false};scope.page.scrollToBottom=function(){var contentDiv=document.querySelector(".egain-chat-content");if(contentDiv){contentDiv.scrollTop=contentDiv.scrollHeight;scope.page.showNewMessageSign=false}};scope.page.isScrollingOn=function(){var contentDiv=document.querySelector(".egain-chat-content");return contentDiv.scrollHeight>contentDiv.clientHeight};element.on("click",function(event){if(event.target.id==="egcb_join_link"){event.preventDefault();var aTag=event.target;var sessionId=event.target.getAttribute("egcb-sessionid");var winName=event.target.getAttribute("egcb-winname");var href=event.target.getAttribute("egcb-href");var templateLocale=new RegExp("[\\?&]locale=([^&#]*)").exec(document.location.href);var locale=templateLocale==null?"en_US":decodeURIComponent(templateLocale[1].replace(/-/g,"_"));event.target.getAttribute("target",winName);if(scope.page.eGainDockedChatCb&&scope.page.eGainDockedChatCb.openCobrowseWindow){scope.page.eGainDockedChatCb.openCobrowseWindow(href,winName,sessionId,locale)}}else if(event.target.getAttribute("egainElement")==="video"){event.preventDefault();var userId=event.target.getAttribute("egainUserId");var avmode=event.target.getAttribute("egainAVMode");var eventAction=event.target.getAttribute("egainAction");eventAction=eventAction?eventAction.toLowerCase():"";switch(eventAction){case"accept":{VideoFactory.AcceptVideoChat(userId,avmode);break}case"reject":{VideoFactory.DeclineVideoChat(userId,avmode);break}}}else if(event.target.id==="va-text"){event.preventDefault();var message=event.target.href;var offset=-1;if(message){offset=message.indexOf("javascript:doReply")}if(offset>=0){var offset2=message.indexOf(")");if(offset2>offset){message=message.substring(offset+20,offset2-1);MessageFactory.SendMessageToAgent(message);document.querySelector("#egain-chat-message-input-horizontal textarea").focus()}}}else if(event.target.id==="eg-attachment-link"){event.preventDefault();AttachmentFactory.GetArticleAttachment(event.target.getAttribute("eg-attachment-id"))}else if(event.target.nodeName==="A"){event.preventDefault();var ele=angular.element(event.target);var url=ele.attr("href");if(url&&"string"===typeof url&&"#"!==url){$window.open(url,"eGainChat")}}})}}}]);app.directive("scrollBottom",["$timeout",function($timeout){function link($scope,$element,attrs){$element.on("click",function(){$timeout(function(){var elem=document.getElementsByClassName(attrs.scrollWindow)[0];elem.scrollTop=elem.scrollHeight},0)})}return{link:link,scope:{scrollBottom:"="},restrict:"A"}}]);app.directive("egStatusBar",function($timeout){function link(scope,element,attrs){var transcriptElement;element.ready(function(){transcriptElement=document.querySelector(".egain-chat-content");scope.isScrolledToBottom=function(){if(Math.round(transcriptElement.scrollHeight-transcriptElement.offsetHeight)-Math.round(transcriptElement.scrollTop)<=1){return true}return false};scope.$watch("page.showNewMessageSign",function(newValue,oldValue){if(newValue){angular.element(transcriptElement).on("scroll",function(){var ifTranscriptScrolledToBottom=scope.isScrolledToBottom();if(ifTranscriptScrolledToBottom&&scope.page.showNewMessageSign){scope.page.showNewMessageSign=false;scope.$apply()}})}else{angular.element(transcriptElement).off("scroll")}})})}return{link:link,restrict:"A"}});app.directive("egSearchresultArticleLink",["$state",function($state){return{restrict:"A",link:function(scope,element,attrs){element.on("click",function(){var oneTagEventInfo={EventName:"ChatKBSearchView",ArticleId:scope.article.id,Rank:this.getAttribute("index")?parseInt(this.getAttribute("index"))+1:0};eGainOneTagUtil.pushChatEvent("uac",oneTagEventInfo);$state.go("chat.deflection.article",{articleId:scope.article.id,searchTerm:scope.searchTerm});scope.$apply()})}}}]);app.directive("egCallbackLink",["$window","ApplicationFactory",function($window,ApplicationFactory){return{link:function($scope,$element,attrs){$element.on("click",function(){if($scope.contactOption.url!=null&&$scope.contactOption.url!==""){if($scope.contactOption.url.toLowerCase().indexOf("mailto:")===0){ApplicationFactory.SetMailLinkClicked(true);setTimeout(function(){ApplicationFactory.SetMailLinkClicked(false)},10)}else $window.open($scope.contactOption.url)}})},restrict:"A"}}]);app.directive("egMinimizeWindow",["$state","$rootScope","ApplicationFactory","MessageFactory","GHFactory",function($state,$rootScope,ApplicationFactory,MessageFactory,GHFactory){return{link:function($scope,$element,attrs){var chatWindow=angular.element(document.querySelector("#egain-chat-overlay"));var chatHeader=angular.element(document.querySelector("#egain-chat-header-small"));$scope.$watch("page.visible",function(newValue){if(newValue){$scope.chatWindowHeight=chatWindow[0].offsetHeight}});var rebuildScrollbar=function(e){if(typeof $scope.page.scrollToBottom!=="undefined"){$scope.page.scrollToBottom()}e.target.removeEventListener("transitionend",rebuildScrollbar)};$scope.$watch("page.minimized",function(newValue,oldValue){if(newValue==true){if(oldValue!==true){chatWindow.css("transition","height .5s")}chatWindow.removeClass("egain-maximized");chatWindow.addClass("egain-minimized");var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_MINIMIZE","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize);ApplicationFactory.PersistToParentStorage("egChatWindowState",$scope.page.minimized)}if(newValue==false){if(oldValue!==false){chatWindow.css("transition","height .5s")}var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_MAXIMIZE","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize);chatWindow.removeClass("egain-minimized");chatWindow.addClass("egain-maximized");if(GHFactory.GetGHActive()){GHFactory.ExpandGHWindow(false)}else if(GHFactory.GetGHActive()===false){GHFactory.CollapseGHWindow(false)}if(angular.equals($state.current.name,"chat.interaction")&&oldValue==true){document.querySelector("#egain-chat-overlay").addEventListener("transitionend",rebuildScrollbar)}if($scope.page.badgeCount>0){$scope.page.badgeCount=0;MessageFactory.SetBadgeCount($scope.page.badgeCount)}ApplicationFactory.PersistToParentStorage("egChatWindowState",$scope.page.minimized)}});var savedWindowState=ApplicationFactory.GetUrlParameter("egChatWindowState");$scope.page.minimized=angular.equals("true",savedWindowState)?true:false},restrict:"A"}}]);app.directive("egResizeDiv",[function(){return{link:function($scope,$element,attrs){$scope.$watchGroup(["page.ready","page.headerLoaded"],function(newValues,oldValues){if(newValues[0]&&newValues[1]){$scope.page.visible=true;removeWaitElement()}})},restrict:"A"}}]);app.directive("egHeader",[function(){return{link:function($scope,$element,attrs){$element.ready(function(){$scope.page.progressbar.setParent($element[0])})},restrict:"A"}}]);app.directive("egOffRecordBtn",["$translate","ApplicationFactory","MessageFactory",function($translate,ApplicationFactory,MessageFactory){return{link:function($scope,$element,attrs){var offRecordMsg="";var onRecordMsg="";$translate(["APP.EG_OFF_RECORD","APP.EG_ON_RECORD"]).then(function(translations){offRecordMsg=translations["APP.EG_OFF_RECORD"];onRecordMsg=translations["APP.EG_ON_RECORD"]});$scope.$watch("offRecord",function(newValue,oldValue){if(newValue===true&&oldValue===false){MessageFactory.SendSystemMessage(offRecordMsg,"offrecord");MessageFactory.SetOffRecordFlag(true);ApplicationFactory.PersistToParentStorage("egOffRecordBtnState",true)}else if(newValue===false&&oldValue===true){MessageFactory.SetOffRecordFlag(false);MessageFactory.SendSystemMessage(onRecordMsg,"onrecord");ApplicationFactory.PersistToParentStorage("egOffRecordBtnState",false)}})},restrict:"A"}}]);app.directive("egArticleContent",["$state","$window","$timeout",function($state,$window,$timeout){return{restrict:"AC",link:function(scope,el,attr){scope.$watch("page.ready",function(newValue){if(newValue){$timeout(function(){angular.element(document.querySelector("#egain-chat-article-content")).find("a").on("click",function(e){e.preventDefault();var a=document.createElement("a");a.href=e.currentTarget.href;a.hostname;if(!(document.location.host==a.hostname)){$window.open(e.currentTarget.href,"_blank","toolbar=yes, scrollbars=yes, resizable=yes, top=60, left=500, width=600, height=600")}else{scope.page.previousArticles.push(scope.article.id);$state.go("chat.deflection.article",{articleId:e.target.id});scope.$apply()}})})}})}}}]);app.directive("egPopoutWindow",["$window","ApplicationFactory","SessionFactory",function($window,ApplicationFactory,SessionFactory){return{link:function($scope,$element,attrs){$element.on("click",function(){ApplicationFactory.isPopoutButtonClicked(true);var p=ApplicationFactory.CreatePayload("POPOUT","POPOUT_START","","EGLV_DOCK_POPOUT");p.compatible={isRelayImplementedInTemplate:true};ApplicationFactory.PostMessageToParent(p,"*")})},restrict:"A"}}]);app.directive("egDragDrop",["$timeout","$filter","AttachmentFactory","ApplicationFactory",function($timeout,$filter,AttachmentFactory,ApplicationFactory){return{restrict:"A",link:function($scope,$element,$attrs){$element.ready(function(){function dragEnterLeave(evt){evt.stopPropagation();evt.preventDefault();$scope.$apply(function(){$scope.dropText="";$scope.dropClass=""})}$element.bind("dragenter",dragEnterLeave);$element.bind("dragleave",dragEnterLeave);$element.bind("dragover",function(evt){evt.stopPropagation();evt.preventDefault()});$element.bind("drop",function(event,data){event.stopPropagation();event.preventDefault();$scope.$apply(function(){$scope.dropText="";$scope.dropClass=""});var files=event.dataTransfer.files;if(files.length>0&&(ApplicationFactory.isDescendent("egain-chat-content",event.target)||ApplicationFactory.isDescendent("egain-chat-header-small",event.target)||ApplicationFactory.isDescendent("egain-chat-alternate-engagement-options",event.target))){$scope.$apply(function(){$scope.files=[];for(var i=0;i<files.length;i++){$scope.files.push(files[i])}AttachmentFactory.ValidateAttachmentFiles($scope.files,true);
})}})})}}}]);app.directive("egPagePushMessage",["$window","$timeout",function($window,$timeout){return{restrict:"A",link:function($scope,$element,$attrs){$timeout(function(){var anchorElements=$element.find("a");if(anchorElements&&anchorElements.length&&0<anchorElements.length){var url=null;var ele=null;var isURLAvailable=false;for(var i=0;i<anchorElements.length;i++){ele=anchorElements[i]?angular.element(anchorElements[i]):null;url=ele&&ele.attr("href")?ele.attr("href"):null;if(url&&"string"===typeof url){isURLAvailable=true;break}}if(true===isURLAvailable){$window.open(url,"eGainChat")}}})}}}]);app.directive("egSurveyInputField",["$rootScope","$timeout",function($rootScope,$timeout){return{link:function($scope,$element,attrs){if($rootScope.isSmallDevice){var chatWindow=angular.element(document.querySelector("#egain-chat-overlay"));var is_landscape=false;var $el=$element[0];var doneBtn=angular.element($el.parentNode.getElementsByClassName("egain-done-btn")[0]);var updateView=function(){is_landscape=screen.height<screen.width;if(is_landscape){chatWindow.addClass("input-edit-wrapper");angular.element($el.parentNode).addClass("edit-wrapper")}else{chatWindow.removeClass("input-edit-wrapper");angular.element($el.parentNode).removeClass("edit-wrapper")}};$element.bind("focus",function(event){updateView();window.addEventListener("resize",updateView,false)});doneBtn.bind("click",function(){chatWindow.removeClass("input-edit-wrapper");window.removeEventListener("resize",updateView,false);angular.element($el.parentNode).removeClass("edit-wrapper")});$element.bind("blur",function(event){chatWindow.removeClass("input-edit-wrapper");window.removeEventListener("resize",updateView,false);angular.element($el.parentNode).removeClass("edit-wrapper")})}$element.bind("keydown",function(event){$timeout(function(){$scope.question.showCharacterCount=true;try{var maxCharacterCount=attrs.maxlength?attrs.maxlength:2e3;var currentCount=0;currentCount=$scope.question.answer.length;var remainderCount=maxCharacterCount-currentCount;$scope.question.characterCount=remainderCount}catch(error){}})})},restrict:"A"}}]);app.directive("keyNavigation",function(){return{link:function($scope,$element){$element.bind("keydown",function(event){var focusNextChild=function(currentChild){if(position>=0){currentMessageBubble.tabIndex=-1;currentMessageBubble.blur()}var el;if(currentChild&&currentChild.length>0){if(currentChild[0].className.indexOf("system")>-1){el=currentChild[0]}else{el=currentChild.children().children()[1]}}if(el){el.focus();el.tabIndex=0}};var code=event.keyCode||event.which;if(code===38||code===40){event.preventDefault();var siblings=$element.parent().children();var position=-1;var currentMessageBubble;var isPreviousMessageAttachment=false;var isNextMessageAttachment=false;var isCurrentMessageAttachment=false;if(angular.element($element.children())[0].className.indexOf("system")>-1){currentMessageBubble=$element.children()[0]}else{currentMessageBubble=$element.children().children().children()[1];if(angular.element(currentMessageBubble).children()[0].className.indexOf("attachmentImageDiv")>-1){isCurrentMessageAttachment=true}}for(var i=0;i<siblings.length;i++){if(siblings[i]===$element[0]){position=i;break}}if(code===40){var bubble=angular.element(siblings[position+1]).children().children().children().children();if(bubble[2]&&bubble[2].className.indexOf("attachmentImageDiv")>-1){isNextMessageAttachment=true}var nextMessageBubble;if(siblings.length>position+1){if(angular.element(siblings[position+1]).children().length>0&&angular.element(siblings[position+1]).children()[0].className.indexOf("system")>-1){nextMessageBubble=angular.element(siblings[position+1]).children()[0]}else{nextMessageBubble=angular.element(siblings[position+1]).children().children().children()}}var flag=true;var checkNextAttachmentBubble=true;if(isCurrentMessageAttachment){checkNextAttachmentBubble=false;var buttons=angular.element(currentMessageBubble).children().children().children().children();var downloadImage=angular.element(angular.element(currentMessageBubble).children().children()[0]).children().children()[0];if(buttons&&buttons.length===3){if(buttons[2].tabIndex===-1){nextMessageBubble=currentMessageBubble}if(buttons[1].tabIndex===0){buttons[1].tabIndex=-1;buttons[1].blur();buttons[2].tabIndex=0;buttons[2].focus()}else if(buttons[2].tabIndex===0&&nextMessageBubble){buttons[2].tabIndex=-1;buttons[2].blur();if(isNextMessageAttachment){checkNextAttachmentBubble=true}else{nextMessageBubble[1].focus();nextMessageBubble[1].tabIndex=0}}else if(downloadImage.tabIndex===0){downloadImage.tabIndex=-1;downloadImage.blur();buttons[1].tabIndex=0;buttons[1].focus()}}else if(downloadImage){if(downloadImage.tabIndex===0&&nextMessageBubble){downloadImage.tabIndex=-1;downloadImage.blur();nextMessageBubble.tabIndex=0;nextMessageBubble.focus()}else{downloadImage.tabIndex=0;downloadImage.focus();currentMessageBubble.blur();currentMessageBubble.tabIndex=-1}}flag=false}if(isNextMessageAttachment&&nextMessageBubble&&checkNextAttachmentBubble){var buttons=angular.element(nextMessageBubble).children().children().children().children();var downloadImage=angular.element(angular.element(nextMessageBubble).children().children()[0]).children().children()[0];if(buttons&&buttons.length===3){if(buttons[1].tabIndex===0){buttons[1].tabIndex=-1;buttons[1].blur();buttons[2].tabIndex=0;buttons[2].focus()}else if(buttons[2].tabIndex===0){buttons[2].tabIndex=-1;buttons[2].blur();nextMessageBubble.focus();nextMessageBubble.tabIndex=0}else if(downloadImage.tabIndex===0){downloadImage.tabIndex=-1;downloadImage.blur();buttons[1].tabIndex=0;buttons[1].focus()}else{downloadImage.tabIndex=0;downloadImage.focus();currentMessageBubble.tabIndex=-1;currentMessageBubble.blur()}}else if(downloadImage){if(downloadImage.tabIndex===0){downloadImage.tabIndex=-1;downloadImage.blur();currentMessageBubble.tabIndex=-1;currentMessageBubble.blur()}else{downloadImage.tabIndex=0;downloadImage.focus();angular.element(nextMessageBubble.children().children()[0]).children().children()[0].focus();angular.element(nextMessageBubble.children().children()[0]).children().children()[0].tabIndex=0}}flag=false}if(flag){var currentChild=angular.element(siblings[position+1]).children();if(currentChild&&currentChild.length>0){focusNextChild(currentChild)}}}else if(code===38){var bubble=angular.element(siblings[position-1]).children().children().children().children();if(bubble[2]&&bubble[2].className.indexOf("attachmentImageDiv")>-1){isPreviousMessageAttachment=true}var previousMessageBubble;if(angular.element(siblings[position-1]).children().length>0&&angular.element(siblings[position-1]).children()[0].className.indexOf("system")>-1){previousMessageBubble=angular.element(siblings[position-1]).children()[0]}else{previousMessageBubble=angular.element(siblings[position-1]).children().children().children()[1]}var flag=true;var checkPreviousAttachmentBubble=true;if(isCurrentMessageAttachment){checkPreviousAttachmentBubble=false;var buttons=angular.element(currentMessageBubble).children().children().children().children();var downloadImage=angular.element(angular.element(currentMessageBubble).children().children()[0]).children().children()[0];if(buttons&&buttons.length===3){if(buttons[1].tabIndex===0){buttons[1].tabIndex=-1;buttons[1].blur();downloadImage.tabIndex=0;downloadImage.focus()}else if(buttons[2].tabIndex===0){buttons[2].tabIndex=-1;buttons[2].blur();buttons[1].tabIndex=0;buttons[1].focus()}else if(downloadImage.tabIndex===0&&previousMessageBubble){downloadImage.tabIndex=-1;downloadImage.blur();if(isPreviousMessageAttachment){checkPreviousAttachmentBubble=true}else{previousMessageBubble.focus();previousMessageBubble.tabIndex=0}}flag=false}else if(downloadImage){if(downloadImage.tabIndex===0){downloadImage.tabIndex=-1;downloadImage.blur();previousMessageBubble.focus();previousMessageBubble.tabIndex=0}else{downloadImage.tabIndex=0;downloadImage.focus()}}}if(isPreviousMessageAttachment&&previousMessageBubble&&checkPreviousAttachmentBubble){var buttons=angular.element(previousMessageBubble).children().children().children().children();var downloadImage=angular.element(angular.element(previousMessageBubble).children().children()[0]).children().children()[0];if(buttons&&buttons.length===3){if(buttons[1].tabIndex===0){buttons[1].tabIndex=-1;buttons[1].blur();downloadImage.tabIndex=0;downloadImage.focus()}else if(buttons[2].tabIndex===0){buttons[2].tabIndex=-1;buttons[2].blur();buttons[1].tabIndex=0;buttons[1].focus()}else if(downloadImage.tabIndex===0){downloadImage.tabIndex=-1;downloadImage.blur();previousMessageBubble.focus();previousMessageBubble.tabIndex=0}else{currentMessageBubble.tabIndex=-1;currentMessageBubble.blur();buttons[2].tabIndex=0;buttons[2].focus()}flag=false}else if(downloadImage){if(downloadImage.tabIndex===0){downloadImage.tabIndex=-1;downloadImage.blur();previousMessageBubble.focus();previousMessageBubble.tabIndex=0}else{downloadImage.tabIndex=0;downloadImage.focus()}}}if(flag){var currentChild=angular.element(siblings[position-1]).children();if(currentChild&&currentChild.length>0){focusNextChild(currentChild)}}}}})}}});app.directive("focus",function($timeout){return{restrict:"A",link:function(scope,element,attrs){var params=scope.$eval(attrs.focus);if(params.index===0){$timeout(function(){angular.element(element)[0].focus()},1e3)}}}});app.directive("focusStar",function($timeout){return{restrict:"A",link:function(scope,element,attrs){var params=scope.$eval(attrs.focusStar);if(params.index===0){$timeout(function(){angular.element(element).find("span")[0].focus()},1e3)}}}});(function(){"use strict";angular.module("pascalprecht.translate").directive("ariaTranslate",ariaTranslateDirectiveFactory);function ariaTranslateDirectiveFactory($rootScope,$translate){return{link:link,priority:-1};function link(scope,element,attrs){scope.off={};scope.off.$translateChangeSuccess=$rootScope.$on("$translateChangeSuccess",translateAriaLabel);scope.off.$translateRefreshEnd=$rootScope.$on("$translateRefreshEnd",translateAriaLabel);translateAriaLabel();function setAriaLabel(value){attrs.$set("ariaLabel",value)}function translateAriaLabel(){var translationId=attrs.ariaTranslate;var translation=$translate.instant(translationId);setAriaLabel(translation||translationId);if(translation!==translationId){scope.off.$translateRefreshEnd()}}}}})(window.angular);app.filter("toTrusted",function($sce){return function(htmlCode){return $sce.trustAsHtml(htmlCode)}});app.filter("highlightArticle",function($sce){return function(origText,characterRanges){if(!angular.isDefined(characterRanges)||!angular.isDefined(characterRanges.length)){return $sce.trustAsHtml(origText)}else{var newSnippet=[];var currentCRIndex=0;for(var i=0;i<origText.length;i++){var CR=characterRanges[currentCRIndex];if(angular.isDefined(CR)){if(i===CR.firstPos)newSnippet.push('<span class="egain-highlighted-content">');newSnippet.push(origText.charAt(i));if(i===CR.lastPos-1){newSnippet.push("</span>");if(characterRanges.length>currentCRIndex+1){currentCRIndex++}}}}var highlightedText=newSnippet.join("");return $sce.trustAsHtml(highlightedText)}}});app.filter("nospace",function(){return function(value){return!value?"":value.replace(/<br ?\/?>/g,"").replace(/&nbsp;/g,"").trim()}});