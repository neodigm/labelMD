app.controller("AlternateContactOptionsController",["$scope","ConfigFactory",function($scope,ConfigFactory){$scope.alternateContactOptions=ConfigFactory.GetChatConfigurations().CallBackParams;$scope.page.ready=true}]);app.controller("AlternateEngagementOptionsController",["$scope","$translate","$timeout","ConfigFactory",function($scope,$translate,$timeout,ConfigFactory){$scope.alternateEngagementOptions=ConfigFactory.GetChatConfigurations().AlternateEngmtParams;$scope.page.ready=true;var showAlternateEngagementOptions,hideAlternateEngagementOptions;$translate(["APP.EG_ALTERNATE_ENGAGEMENT_OPTIONS_SHOW","APP.EG_ALTERNATE_ENGAGEMENT_OPTIONS_HIDE"]).then(function(translations){showAlternateEngagementOptions=translations["APP.EG_ALTERNATE_ENGAGEMENT_OPTIONS_SHOW"];hideAlternateEngagementOptions=translations["APP.EG_ALTERNATE_ENGAGEMENT_OPTIONS_HIDE"];$scope.title=hideAlternateEngagementOptions});$scope.$watch("hideDetails",function(newValue,oldValue){if(newValue===true){$scope.page.showAlternateEngagementCollapsed=true;$timeout(function(){$scope.page.scrollToBottom();$scope.title=showAlternateEngagementOptions},400)}else if(newValue===false){$scope.page.showAlternateEngagementCollapsed=false;if(typeof $scope.page.scrollToBottom!=="undefined"){$timeout(function(){$scope.page.scrollToBottom();$scope.title=hideAlternateEngagementOptions},500)}}})}]);app.controller("ArticleContentController",["$scope","$stateParams","$sce","$rootScope","ChatService","ConfigFactory",function($scope,$stateParams,$sce,$rootScope,ChatService,ConfigFactory){$scope.page.progressbar.start();$scope.articleHasEditions=false;$scope.ghArticle=false;$scope.articleAttributes=["name,content,contentText"];$scope.articleId=$stateParams.articleId;var getElementsByClassName=function(node,classname){var a=[];var re=new RegExp("(^| )"+classname+"( |$)");var els=node.getElementsByTagName("*");for(var i=0,j=els.length;i<j;i++)if(re.test(els[i].className))a.push(els[i]);return a};var chatConfig=ConfigFactory.GetChatConfigurations();var portalId=chatConfig.DeflectionPortalId?chatConfig.DeflectionPortalId:"";var xEgainSession=$scope.deflection.sessionId?$scope.deflection.sessionId:"";$scope.page.searchTerm=$stateParams.searchTerm;ChatService.GetArticle(portalId,"customer",xEgainSession,$scope.articleId,$scope.articleAttributes).then(function(response){if(response.isErrorPresent){}else{if(angular.equals(response.returnData.articleType,1)){$scope.article=response.returnData;$scope.ghArticle=true;$scope.page.ready=true}else{$scope.article=response.returnData;$scope.highlightSearchTerms=false;if($scope.highlightSearchTerms&&$scope.article.textMetadata){var highlightMetadata=$scope.article.textMetadata.highlightMetadata;for(var i=0;i<highlightMetadata.length;i++){if(angular.equals(highlightMetadata[i].attributeName,"content")&&highlightMetadata[i].characterRange.length>0){var snippetCRs=highlightMetadata[i].characterRange}}if(angular.isDefined(snippetCRs)){$scope.article.highlightRange=snippetCRs}if($scope.highlightSearchTerms){$scope.article.content=highlightArticle($scope.article.content,$scope.article.highlightRange)}}var articleContentXml=angular.element("<div>"+$scope.article.content+"</div>");angular.forEach(getElementsByClassName(articleContentXml[0],"eGainArticleLink"),function(link){if(link.href){link.setAttribute("id",link.getAttribute("articleId"))}});$scope.article.content=$sce.trustAsHtml(articleContentXml[0].innerHTML);if(angular.isDefined(response.returnData.articleEditions.edition)&&response.returnData.articleEditions.edition.length>1){$scope.currentEditionId=response.returnData.articleEditions.edition[0].id;$scope.articleHasEditions=true}else{$scope.articleHasEditions=false}var oneTagEventInfo={EventName:"ChatKBArticleShow",ArticleId:$scope.article.id,ArticleName:$scope.article.name,Language:$rootScope.locale};eGainOneTagUtil.pushChatEvent("aac",oneTagEventInfo);$scope.page.ready=true}$scope.deflection.article=$scope.article;$scope.page.backButtonEnabled=true;$scope.page.progressbar.complete()}});var highlightArticle=function(origText,characterRanges){if(!angular.isDefined(characterRanges)||!angular.isDefined(characterRanges.length)){return origText}else{var newSnippet=[];var currentCRIndex=0;for(var i=0;i<origText.length;i++){var CR=characterRanges[currentCRIndex];if(angular.isDefined(CR)){if(i===CR.firstPos)newSnippet.push('<span class="egain-highlighted-content">');newSnippet.push(origText.charAt(i));if(i===CR.lastPos-1){newSnippet.push("</span>");if(characterRanges.length>currentCRIndex+1){currentCRIndex++}}}}var highlightedText=newSnippet.join("");return highlightedText}}}]);app.controller("ArticleToolbarController",["$scope","$state","ChatService","ConnectionFactory",function($scope,$state,ChatService,ConnectionFactory){$scope.$watch("page.ready",function(newValue,oldValue){if(newValue){$scope.article=$scope.deflection.article}})}]);app.controller("AttachmentReviewController",["$scope","$uibModalInstance","AttachmentFactory",function($scope,$uibModalInstance,AttachmentFactory){$scope.$on("application_service_validated_dropped_attachments",function(){$uibModalInstance.dismiss()});$scope.sendFiles=function(){$scope.submitted=true;var validFiles=[];angular.forEach($scope.droppedAttachmentQueue,function(file){if(!file.invalidFile){validFiles.push(file)}});AttachmentFactory.SendCustomerAttachmentNotification(validFiles);$uibModalInstance.dismiss()};$scope.closeAttachmentDialog=function(){$scope.attachmentCnt.valid=0;$uibModalInstance.dismiss()};$scope.cleanUpFileList=function(){$scope.droppedAttachmentQueue=[];$uibModalInstance.dismiss()};$scope.skipFileUploadForIndex=function(fileIndex,attachment){if(attachment.invalidFile==false){$scope.attachmentCnt.valid--}$scope.droppedAttachmentQueue.splice(fileIndex,1)};$scope.getAttachmentSizeUnit=function(bytes){return AttachmentFactory.GetAttachmentSizeUnit(bytes)}}]);app.controller("AttachmentController",["$scope","$uibModalInstance","AttachmentFactory",function($scope,$uibModalInstance,AttachmentFactory){$scope.selectedAttachmentQueue=[];$scope.attachmentCnt={valid:0,invalid:0};$scope.$on("application_service_validated_selected_attachments",function(evt,tempAttachments){$scope.selectedAttachmentQueue=$scope.selectedAttachmentQueue.concat(tempAttachments.attachmentQueue);$scope.attachmentCnt.valid+=tempAttachments.validCount;angular.element(document.getElementById("filesToUpload"))[0].value=""});$scope.$on("application_service_validated_dropped_attachments",function(evt,tempAttachments){angular.forEach(tempAttachments.attachmentQueue,function(file){if(file.invalidFile){$scope.attachmentCnt.valid=0;$uibModalInstance.dismiss()}})});$scope.attachFile=function(element){if($scope.selectedAttachmentQueue[$scope.selectedAttachmentQueue.length-1]&&$scope.selectedAttachmentQueue[$scope.selectedAttachmentQueue.length-1].maxNumberValidationFailed){$scope.selectedAttachmentQueue.splice($scope.selectedAttachmentQueue.length-1,1)}AttachmentFactory.ValidateAttachmentFiles(element.files,false,$scope.selectedAttachmentQueue.length)};$scope.sendFiles=function(){$scope.submitted=true;var validFiles=[];angular.forEach($scope.selectedAttachmentQueue,function(file){if(!file.invalidFile){validFiles.push(file)}});AttachmentFactory.SendCustomerAttachmentNotification(validFiles)};$scope.$on("application_service_attachment_notification_sent_event",function(evt,data){if(data.status==="failed"){$scope.$apply(function(){$scope.error=true})}else{if($uibModalInstance.opened){$uibModalInstance.dismiss()}}});$scope.closeAttachmentDialog=function(){$scope.attachmentCnt.valid=0;$uibModalInstance.dismiss()};$scope.cleanUpFileList=function(){$scope.selectedAttachmentQueue=[];$scope.closeAttachmentDialog()};$scope.skipFileUploadForIndex=function(fileIndex,attachment){if(attachment.invalidFile==false){$scope.attachmentCnt.valid--}$scope.selectedAttachmentQueue.splice(fileIndex,1)};$scope.getAttachmentSizeUnit=function(bytes){return AttachmentFactory.GetAttachmentSizeUnit(bytes)}}]);app.controller("ChatAttachController",["$scope","$window","ConnectionFactory","ApplicationFactory",function($scope,$window,ConnectionFactory,ApplicationFactory){ConnectionFactory.AttachToChat()}]);app.controller("ChatInitializeController",["$scope","$state","ApplicationFactory",function($scope,$state,ApplicationFactory){var entryPoint=ApplicationFactory.GetEntryPointId();var customLaunchButtonClicked="true"===ApplicationFactory.GetUrlParameter("chatLaunched")?true:false;var launchButtonSkipped=true;var initializeChat=function(){$scope.$on("application_service_chat_initialized_success_event",function(evt,response){onChatInitialized(response)});ApplicationFactory.Chat(entryPoint)};var onChatInitialized=function(response){if(response.isOneTagOff){proceedToChat(response)}else if(response.oneTagAId&&response.oneTagServerDomainName){initializeOnetag(response);proceedToChat(response)}else{if(initializeChat){$state.go("chat.error",{errorCode:"ONETAG_FAILURE"})}else{$scope.page.OnetagFailure=true}}};var initializeOnetag=function(response){eGainOneTagUtil.disableTracker();eGainOneTagUtil.loadOneTag(response)};var proceedToChat=function(response){var available=response.checkEligibility.responseType;if(launchButtonSkipped){if(available===0){$state.go("chat.pre-chat")}else if(available===1){$state.go("chat.chat-unavailable",{condition:"OFF_HOURS"})}else if(available===2){$state.go("chat.chat-unavailable",{condition:"MAX_QUEUE_DEPTH_EXCEEDED"})}}else{if(available===0){$scope.page.chatAvailable=true}else if(available===1){$scope.page.eligibilityResponse="OFF_HOURS";$scope.page.chatAvailable=false}else if(available===2){$scope.page.eligibilityResponse="MAX_QUEUE_DEPTH_EXCEEDED";$scope.page.chatAvailable=false}}};$scope.$on("application_service_start_chat_initialize",function(evt,data){initializeChat()});if(ApplicationFactory.IsDocked()===false||customLaunchButtonClicked){initializeChat()}}]);app.controller("ChatUnavailableMessageController",["$scope",function($scope){$scope.page.ready=true}]);app.controller("CobrowseController",["$scope","$window","ApplicationFactory","ConnectionFactory","SessionFactory",function($scope,$window,ApplicationFactory,ConnectionFactory,SessionFactory){$scope.page.ready=true;$scope.cobrowseInvites=SessionFactory.GetCobrowseSessionState().cobrowseInvites;$scope.page.eGainDockedChatCb={};$scope.page.eGainDockedChatCb.openCobrowseWindow=function(url,cbWndName,cbSessionId,locale){if($scope.cobrowseInvites[cbSessionId]){if(angular.equals("OPENED",$scope.cobrowseInvites[cbSessionId]["status"])){ApplicationFactory.Translate("APP.EG_COBROWSE_SESSION_OPENED").then(function(result){alert(result)})}else if(angular.equals("CLOSED",$scope.cobrowseInvites[cbSessionId]["status"])){ApplicationFactory.Translate("APP.EG_COBROWSE_SESSION_TERMINATED").then(function(result){alert(result)})}else{var sid=ConnectionFactory.GetConnection().sessionID;var egActId="";if(sid){egActId=sid.substr(0,sid.indexOf("_"))}if(url&&url.length>0){var delimiter=url.indexOf("?")>0?"&":"?";url=url+delimiter+"cbLocale="+locale}var isDocked=ApplicationFactory.IsDocked();var isPoppedOut=ApplicationFactory.isPoppedOut();var openCobrowseURLInParentWindow=true===isDocked||true===isPoppedOut&&$window.opener&&!$window.opener.closed;if(true===openCobrowseURLInParentWindow){if(url&&url.length>0){ApplicationFactory.PersistToStorage("egActId",egActId);ApplicationFactory.PersistToStorage("cbAutoSessionId",cbSessionId)}else{var postMessageDataObj={cbAutostart:true,egActId:egActId,cbAutoSessionId:cbSessionId,cbLocale:locale};ApplicationFactory.PersistToParentStorage("cbData",postMessageDataObj,"session")}var p=ApplicationFactory.CreatePayload("NOTIFY","COBROWSE_REQUEST",url,"EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(p,"*")}else{if(url&&url.length>0){ApplicationFactory.PersistToStorage("egActId",egActId);ApplicationFactory.PersistToStorage("cbAutoSessionId",cbSessionId);$window.open(url,"eGainCobrowse")}else{}}$scope.cobrowseInvites[cbSessionId]["status"]="OPENED";SessionFactory.SaveCobrowseSessionState($scope.cobrowseInvites)}}};$scope.page.eGainDockedChatCb.stopCobrowse=function(cbSessionId){$scope.cobrowseInvites[cbSessionId]["status"]="CLOSED";SessionFactory.SaveCobrowseSessionState($scope.cobrowseInvites)};$scope.$on("application_service_cobrowse_invite_received_event",function(evt,data){$scope.cobrowseInvites[data.Session]={action:data.Action,customerName:data.CustomerName,status:"NEW"};SessionFactory.SaveCobrowseSessionState($scope.cobrowseInvites)});$scope.$on("application_service_chat_connection_completion_event",function(){var p=ApplicationFactory.CreatePayload("NOTIFY","COBROWSE_END_REQUEST","endsession","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(p,"*")});$window.addEventListener("message",function(event){try{var cbData=JSON.parse(event.data);if(cbData.caller==="EGLV_DOCK_CALLER_COBROWSE_STOP"){var cbDataValue=cbData.value;$scope.cobrowseInvites[cbDataValue]["status"]="CLOSED";SessionFactory.SaveCobrowseSessionState($scope.cobrowseInvites)}}catch(exception){}})}]);app.controller("ChatErrorMessageController",["$scope","$stateParams","ApplicationFactory",function($scope,$stateParams,ApplicationFactory){var errorCode=$stateParams.errorCode;var errorMsg=$stateParams.errorMsg;if(errorCode){if(angular.equals("DUPLICATE_SESSION",$stateParams.errorCode)){ApplicationFactory.Translate("APP.EG_DUPLICATE_SESSION_MSG").then(function(result){$scope.errorMessage=result})}else if(angular.equals("CONNECT_FAIL",$stateParams.errorCode)){ApplicationFactory.Translate("APP.EG_CONNECTION_FAILURE").then(function(result){$scope.errorMessage=result})}else if(angular.equals("ONETAG_FAILURE",$stateParams.errorCode)){ApplicationFactory.Translate("APP.EG_ONE_TAG_FAILURE").then(function(result){$scope.errorMessage=result})}else{ApplicationFactory.Translate("APP.EG_SESSION_CREATION_FAILURE",{errorCode:$stateParams.errorCode}).then(function(result){$scope.errorMessage=result})}$scope.page.ready=true;$scope.page.progressbar.complete()}else if(errorMsg){$scope.errorMessage=errorMsg;$scope.page.ready=true;$scope.page.progressbar.complete()}else{$scope.page.hide=true}}]);app.controller("EscalationSearchController",["$scope","$stateParams","$rootScope","ConfigFactory","ChatService","ApplicationFactory","VAFactory",function($scope,$stateParams,$rootScope,ConfigFactory,ChatService,ApplicationFactory,VAFactory){$scope.deflection.showSendEscalationMessage=false;var chatConfig=ConfigFactory.GetChatConfigurations();var portalId=chatConfig.DeflectionPortalId?chatConfig.DeflectionPortalId:"";var ssApiPath=chatConfig.DeflectionApiPath?chatConfig.DeflectionApiPath:"";$rootScope.ssApiPath=$rootScope.apiPath;if(ssApiPath){$rootScope.ssApiPath=ssApiPath}if($scope.deflection.articles===null){ApplicationFactory.RetrieveFromParentStorage("X-egain-session",onEscalationSessionReceiveFromParent,"session");if(VAFactory.IsVAEscalated()){$scope.deflection.wait=true}}else{$scope.page.ready=true;$scope.searchTerm=$scope.page.searchTerm;$scope.deflection.showSendEscalationMessage=true}function onEscalationSessionReceiveFromParent(response){var xEgainSession=response;if(xEgainSession===null){ChatService.InitiateSession(portalId,"customer").then(function(responseData){if(responseData.isErrorPresent){$scope.startChat()}else{$scope.xEgainSession=responseData.xEgainSession;searchForEscalationArticles(chatConfig)}})}else{$scope.xEgainSession=JSON.parse(xEgainSession);searchForEscalationArticles(chatConfig)}}var searchForEscalationArticles=function(chatConfig){var portalId=chatConfig.DeflectionPortalId?chatConfig.DeflectionPortalId:"";var attributes=chatConfig.AttributesForDeflection?chatConfig.AttributesForDeflection:["description","name"];var resultSize=chatConfig.NumberOfDeflectionArticlesToShow?chatConfig.NumberOfDeflectionArticlesToShow:5;$scope.isErrorPresent=false;$scope.more_articles=[];var xEgainSession=$scope.xEgainSession;var customer=$stateParams.customer;var subject="";var name="";var phone="";var emailAddress="";if(angular.isDefined(customer)){angular.forEach(customer.CustomerParameters,function(value,key){if(angular.equals("subject",value.eGainAttribute)){subject=ApplicationFactory.MaskMessage(value.eGainValue)}if(angular.equals("full_name",value.eGainAttribute)){name=value.eGainValue}if(angular.equals("email_address",value.eGainAttribute)){emailAddress=value.eGainValue}if(angular.equals("phone_number",value.eGainAttribute)){phone=value.eGainValue}})}var description=subject;$scope.searchTerm=subject;$scope.page.searchTerm=$scope.searchTerm;var oneTagEventInfo={EventName:"ChatKBSearchSubmit","Search-term":$scope.searchTerm};eGainOneTagUtil.pushChatEvent("aac",oneTagEventInfo);ChatService.SearchPriorToEscalation(portalId,xEgainSession,ApplicationFactory.GetUrlParameter("entryPointId"),subject,description,name,emailAddress,phone,attributes,resultSize,resultSize).then(function(results){if(results.isErrorPresent){$scope.startChat()}else{if(results.pagingInfo.count===0){$scope.startChat()}else{$scope.deflection.articles=processResults(results.returnData);$scope.pagingInfo=results.pagingInfo;$scope.deflection.sessionId=results.xEgainSession;xEgainSession=$scope.deflection.sessionId;var oneTagEventInfo={EventName:"ChatKBSearchResults",NumResults:$scope.pagingInfo.count,TopArticleId:$scope.deflection.articles.length>0?$scope.deflection.articles[0].id:"",TopArticleName:$scope.deflection.articles.length>0?$scope.deflection.articles[0].name:"",PortalId:portalId,Language:$rootScope.locale};eGainOneTagUtil.pushChatEvent("aac",oneTagEventInfo);$scope.page.progressbar.complete();$scope.deflection.wait=false;$scope.page.ready=true;$scope.deflection.showSendEscalationMessage=true}}})};var processResults=function(searchResults){if(!searchResults)return[];var articles=[];angular.forEach(searchResults,function(value,key){if(!value.textMetadata){articles.push(value)}else{if(value.articleType===1){}else{var highlightMetadata=value.textMetadata.highlightMetadata;for(var i=0;i<highlightMetadata.length;i++){if(highlightMetadata[i].attributeName==="snippet"){var snippetCRs=highlightMetadata[i].characterRange}}if(snippetCRs!=="undefined"){value.highlightRange=snippetCRs}}articles.push(value)}});searchResults=articles;return searchResults}}]);app.controller("GuidedHelpWindowController",["$scope","$sce","VAFactory","GHFactory","ApplicationFactory",function($scope,$sce,VAFactory,GHFactory,ApplicationFactory){var egGHUrl=ApplicationFactory.GetUrlParameter("egGHUrl");var egGHActive=ApplicationFactory.GetUrlParameter("egGHActive");var egGHSessionData=GHFactory.GetGHSessionData();if(VAFactory.IsVAEnabled()&&!VAFactory.IsVAActive()){GHFactory.CloseGHWindow(false)}else{$scope.$on("gh_url_update",function(event,data){if(data&&data.hasOwnProperty("GHUrl")&&data.GHUrl!==""){egGHUrl=data.GHUrl;if(egGHSessionData&&!data.Reload){egGHUrl+="&"+egGHSessionData}if(data.Reload){egGHUrl+="&time="+Date.now()}$scope.ghURL=$sce.trustAsResourceUrl(egGHUrl)}});$scope.ghUrlHome=GHFactory.GetGHUrl();if(egGHUrl){GHFactory.SetGHUrl(egGHUrl)}if(egGHActive==="true"){GHFactory.ExpandGHWindow(false)}if(egGHActive==="false"){GHFactory.CollapseGHWindow(false)}}$scope.CloseGHWindow=function(){GHFactory.CreateQuickPick().then(function(response){GHFactory.CloseGHWindow(true)})};$scope.ExpandGHWindow=function(){GHFactory.ExpandGHWindow(true)};$scope.CollapseGHWindow=function(){GHFactory.CollapseGHWindow(true)};$scope.OpenHomePage=function(){$scope.ghURL=$sce.trustAsResourceUrl($scope.ghUrlHome)}}]);app.controller("HeaderSmallController",["$scope","$rootScope","$state","$timeout","$stateParams","ApplicationFactory","ConfigFactory","ChatHeaderFactory","ConnectionFactory","SessionFactory","MessageFactory","VideoFactory","VAFactory","$filter",function($scope,$rootScope,$state,$timeout,$stateParams,ApplicationFactory,ConfigFactory,ChatHeaderFactory,ConnectionFactory,SessionFactory,MessageFactory,VideoFactory,VAFactory,$filter){$scope.$watch(function(){return ChatHeaderFactory.GetChatHeader()},function(newValue,oldValue){$scope.header=newValue});$scope.$watch(function(){return ChatHeaderFactory.GetChatHeaderImage()},function(newValue,oldValue){$scope.headerImage=newValue});$scope.$watch(function(){return VAFactory.IsVAActive()},function(newValue,oldValue){$scope.vaActive=newValue;if(true===$scope.vaActive){$scope.chatActive=false}else if(false===$scope.vaActive){if(true===oldValue){$timeout(function(){$scope.chatActive=true},300)}else{$scope.chatActive=true}}});var $translate=$filter("translate");$scope.showToolbarOptions=false;$scope.page.menuexpanded=false;$scope.page.previousArticles=[];$scope.offRecord=SessionFactory.GetSessionState().OffRecordBtnState?SessionFactory.GetSessionState().OffRecordBtnState:false;MessageFactory.SetOffRecordFlag($scope.offRecord);$scope.isDocked=ApplicationFactory.IsDocked();$scope.toolbarItems=[];$scope.iconBackImageURL="components/header-small/icon_chevron_w.png";$scope.title=$translate("APP.EG_MORE_OPTIONS");$scope.expanded=$translate("APP.EG_NAVBAR_EXPANDED");$scope.collapsed=$translate("APP.EG_NAVBAR_COLLAPSED");$scope.toolbarButtons={position:["video","audio","save","faq","offRecord","onRecord"],buttons:{video:{present:false,button:{name:"APP.EG_TOOLBAR_VIDEO_CHAT",link:"",icon:"fa fa-video-camera",target:"",id:"egain-video-chat"}},audio:{present:false,button:{name:"APP.EG_TOOLBAR_AUDIO_CHAT",link:"",icon:"fa fa-microphone",target:"",id:"egain-audio-chat"}},save:{present:false,button:{name:"APP.EG_TOOLBAR_SAVE_TRANSCRIPT",link:"",icon:"fa fa-save",target:"",id:"egain-save-transcript"}},faq:{present:false,button:{name:"APP.EG_TOOLBAR_FAQ",link:"",icon:"fa fa-question",target:"_blank",id:"egain-faq"}},offRecord:{present:false,button:{name:"APP.EG_TOOLBAR_OFF_RECORD",link:"",icon:"fa fa-ban",target:"_blank",id:"egain-off-record"}},onRecord:{present:false,button:{name:"APP.EG_TOOLBAR_ON_RECORD",link:"",icon:"fa fa-ban",target:"_blank",id:"egain-on-record"}}}};var addToolbarButton=function(button,position){var added=false;if(button){try{position="number"===typeof position?parseInt(position):-1}catch(e){position=-1}position=0>=$scope.toolbarItems.length||-1>position?-1:position;switch(position){case-1:$scope.toolbarItems.push(button);added=true;break;default:$scope.toolbarItems.splice(position,0,button);added=true;break}}return added};var removeToolbarButton=function(buttonId){var removed=false;if(buttonId&&"string"===typeof buttonId){$scope.toolbarItems=$scope.toolbarItems.filter(function(el){return el.id!==buttonId});removed=true}return removed};var determinePositionForAdding=function(toolbarItemName){var position=-1;var len=0;if($scope.toolbarButtons.position&&0<(len=$scope.toolbarButtons.position.length)&&toolbarItemName&&"string"===typeof toolbarItemName){if(-1<$scope.toolbarButtons.position.indexOf(toolbarItemName)){for(var i=0;i<len;i++){var listName=$scope.toolbarButtons.position[i];if(listName&&"string"===typeof listName){if(listName===toolbarItemName){position++;break}else{var listItem=$scope.toolbarButtons.buttons[listName];if(listItem&&true===listItem.present){position++}}}}}}return position};$scope.addRemoveToolbarButton=function(toolbarItemName,add){var toolbarItem=null;if(toolbarItemName&&"string"===typeof toolbarItemName&&(toolbarItem=$scope.toolbarButtons.buttons[toolbarItemName])){if(true===add){if(false===toolbarItem.present){var position=determinePositionForAdding(toolbarItemName);var added=addToolbarButton(toolbarItem.button,position);toolbarItem.present=added}}else{if(true===toolbarItem.present){var removed=removeToolbarButton(toolbarItem.button.id);toolbarItem.present=!removed}}}};$scope.addRemoveToolbarButton("save",true);var chatConfig=ConfigFactory.GetChatConfigurations();if(chatConfig.KnowledgeBaseUrl&&chatConfig.KnowledgeBaseUrl.length>0){$scope.addRemoveToolbarButton("faq",true)}$scope.goBack=function(){if($scope.page.previousArticles.length>0){$state.go("chat.deflection.article",{articleId:$scope.page.previousArticles.pop()})}else{$state.go("chat.deflection.escalation-results")}};$scope.$watch(function(){return ConnectionFactory.GetConnection().connected},function(newValue,oldValue){if(newValue){$scope.showToolbarOptions=true;ConnectionFactory.GetChatInitializationData().then(function(chatInitializationData){$scope.showOffRecord=chatInitializationData&&"boolean"===typeof chatInitializationData.isOffRecordEnabled?chatInitializationData.isOffRecordEnabled:false;showHideOnOffRecordButtons()})}else{$scope.showOffRecord=false;$timeout(function(){showHideOnOffRecordButtons()})}});var showHideOnOffRecordButtons=function(){if($scope.showOffRecord){if($scope.offRecord){$scope.addRemoveToolbarButton("offRecord",false);$scope.addRemoveToolbarButton("onRecord",true)}else{$scope.addRemoveToolbarButton("offRecord",true);$scope.addRemoveToolbarButton("onRecord",false)}}else{$scope.addRemoveToolbarButton("offRecord",false);$scope.addRemoveToolbarButton("onRecord",false)}};var showHideAVChatButtons=function(data){$scope.addRemoveToolbarButton("video",data.showVideoChatButton);$scope.addRemoveToolbarButton("audio",data.showAudioChatButton);$timeout(function(){$scope.$apply()})};$scope.$on("application_service_adjust_video_audio_chat_buttons",function(evt,data){showHideAVChatButtons(data)});var errorMessagePublished=false;$scope.$on("application_service_chat_error_message_published",function(evt,data){errorMessagePublished=true});var connectionErrorMsgListener=null;$scope.$on("application_service_network_disconnect_event",function(evt,data){connectionErrorMsgListener=$scope.$watch(function(){return errorMessagePublished},function(newValue,oldValue){if(newValue===true){disableEndChatBtn();connectionErrorMsgListener();connectionErrorMsgListener=null}});function disableEndChatBtn(){$scope.endChatBtnDisabled=true}});$scope.$on("application_service_network_reconnect_event",function(evt,data){$scope.endChatBtnDisabled=false;errorMessagePublished=false;if(typeof connectionErrorMsgListener==="function"){connectionErrorMsgListener();connectionErrorMsgListener=null}});$scope.$on("application_service_extended_timeout_expired",function(evt,data){$scope.endChatBtnDisabled=false});var checkAVChatButtonsState=function(){var data=VideoFactory.GetAVChatButtonsState();showHideAVChatButtons(data)};if(true===$stateParams.attachedChat){checkAVChatButtonsState()}$scope.enableAttachmentLink=function(flag){$rootScope.$broadcast("application_service_attachment_link_enable_disable",flag)}}]);app.controller("LaunchButtonController",["$scope","$stateParams","ChatHeaderFactory","ApplicationFactory","SessionFactory","VAFactory",function($scope,$stateParams,ChatHeaderFactory,ApplicationFactory,SessionFactory,VAFactory){$scope.isVaEnabled=$stateParams.launchVA;if($scope.isVaEnabled){var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_LAUNCH_VA","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize);VAFactory.GetLaunchImage().then(function(response){$scope.launchImage=response})}else{var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_LAUNCH_CHAT","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize);$scope.launchImage=applicationDefaults.eGainContextPath+"ext-components/launch-button/launch-button.png"}$scope.$watch(function(){return ChatHeaderFactory.GetChatHeaderImage()},function(newValue,oldValue){$scope.headerImage=newValue})}]);app.controller("MessageInputController",["$scope","$rootScope","$sce","$uibModal","MessageFactory","ConfigFactory","ConnectionFactory","ApplicationFactory","$timeout",function($scope,$rootScope,$sce,$uibModal,MessageFactory,ConfigFactory,ConnectionFactory,ApplicationFactory,$timeout){$scope.typingAreaPlaceholder="";$scope.attachmentIconURL="components/message-input-horizontal/attachment_icon.png";$scope.focusTextArea=true;var typingAreaPlaceholder="";ApplicationFactory.Translate("APP.EG_TYPEAREA_PLACEHOLDER").then(function(result){$scope.typingAreaPlaceholder=result;typingAreaPlaceholder=$scope.typingAreaPlaceholder});$scope.scp={customerTypingTimer:null};var isVAActive=ApplicationFactory.GetUrlParameter("VAActive")==="true"?true:false;if(true===isVAActive){$scope.isChatAttachmentEnabled=false}$scope.sendMessageToAgent=function(){$scope.scp.customerTypingTimer=null;MessageFactory.SendMessageToAgent($scope.customerMessage.trim());$scope.customerMessage=""};$scope.$on("application_service_chat_transfer_event",function(event,data){$scope.isChatAttachmentEnabled=data.ChatAttachmentEnabled});$scope.sendCustomerStartTypingStatus=function(){if(ConnectionFactory.GetConnection().connected){MessageFactory.SendCustomerStartTypingStatus()}};$scope.sendCustomerStopTypingStatus=function(){$scope.scp.customerTypingTimer=null;if(ConnectionFactory.GetConnection().connected){MessageFactory.SendCustomerStopTypingStatus();$scope.isCustomerTyping=false}};var audioAlertThreshold=2e3;var lastAudioAlert=0;var timeElapsedSinceLastAlert=0;var chatConfig=ConfigFactory.GetChatConfigurations();var audioUrl=chatConfig.CustomerAudioAlert;$scope.audioUrl=$sce.trustAsResourceUrl(audioUrl);$scope.maxInputLength=chatConfig.MaxMessageSize;$scope.$on("application_service_agent_message_received_event",function(evt,data){var currentTime=(new Date).getTime();timeElapsedSinceLastAlert=(new Date).getTime()-lastAudioAlert;if(audioUrl!=""&timeElapsedSinceLastAlert>audioAlertThreshold&!$scope.isEditiorFocussed){if($rootScope.isLargeDevice){document.getElementById("html5sound").play()}lastAudioAlert=currentTime}});$scope.$on("application_service_system_message_received_event",function(evt,data){var currentTime=(new Date).getTime();timeElapsedSinceLastAlert=(new Date).getTime()-lastAudioAlert;if(audioUrl!==""&timeElapsedSinceLastAlert>audioAlertThreshold&!$scope.isEditiorFocussed){if($rootScope.isLargeDevice){document.getElementById("html5sound").play()}lastAudioAlert=currentTime}});$scope.$on("application_service_chat_attached_event",function(evt,data){$scope.waitmessage=""});var errorMessagePublished=false;$scope.$on("application_service_chat_error_message_published",function(evt,data){errorMessagePublished=true});var connectionErrorMsgListener=null;$scope.$on("application_service_network_disconnect_event",function(evt,data){connectionErrorMsgListener=$scope.$watch(function(){return errorMessagePublished},function(newValue,oldValue){if(newValue===true){disableTypingArea();connectionErrorMsgListener();connectionErrorMsgListener=null}});function disableTypingArea(){$scope.page.inputDisabled=true;$scope.typingAreaPlaceholder=""}});$scope.$on("application_service_network_reconnect_event",function(evt,data){$scope.page.inputDisabled=false;$scope.typingAreaPlaceholder=typingAreaPlaceholder;errorMessagePublished=false;if(typeof connectionErrorMsgListener==="function"){connectionErrorMsgListener();connectionErrorMsgListener=null}});$scope.openAttachmentDialog=function(){var attachmentOptions={animation:true,templateUrl:"components/attachment/attachment.html",size:"md",controller:"AttachmentController",appendTo:angular.element(document.getElementsByClassName("egain-chat-content")),scope:$scope};if(ApplicationFactory.IsVisitorIOSPhone()){delete attachmentOptions.appendTo}if(!$scope.offRecordFlag){var modalInstance=$uibModal.open(attachmentOptions);modalInstance.result.then(function(selectedItem){},function(){})}};$scope.processAndSendMessage=function(event){$scope.customerMessage=ApplicationFactory.htmlEncode($scope.customerMessage);if($scope.customerMessage==="")return;if($scope.customerMessage.replace(/<br ?\/?>/g,"").replace(/&nbsp;/g,"").trim().length===0)return;$scope.customerMessage=$scope.customerMessage.replace(/<a\b/g,'<a target="_blank"');$scope.customerMessage=$scope.customerMessage.replace(/\n/g,"<br/>");var messageLength=$("<div>").html($scope.customerMessage.replace(/\n/g,"&crarr;")).text().length;$scope.customerMessage=$scope.customerMessage.replace(/\n/g," ");var extraCharacters=messageLength-chatConfig.MaxMessageSize;if(extraCharacters>0){ApplicationFactory.Translate("APP.EG_MESSAGE_LENGTH_ERROR",{
maxMessageLength:chatConfig.MaxMessageSize,extraCharacters:extraCharacters}).then(function(alertMessage){alert(alertMessage)});return}if(angular.isDefined($scope.customerMessage)&&!angular.equals($scope.customerMessage,"")){$scope.sendMessageToAgent();$scope.sendCustomerStopTypingStatus();if($rootScope.isSmallDevice&&event){event.target.blur()}}};$scope.sendMessage=function(){$scope.processAndSendMessage();$timeout(function(){$scope.focusTextArea=true})}}]);app.controller("PostChatSurveyController",["$scope","ApplicationFactory","$state","ChatService","ConnectionFactory","ConfigFactory","ChatHeaderFactory","$translate",function($scope,ApplicationFactory,$state,ChatService,ConnectionFactory,ConfigFactory,ChatHeaderFactory,$translate){$scope.page.progressbar.start();var chatConfig=ConfigFactory.GetChatConfigurations();$scope.surveyQuestions=chatConfig.SurveyQuestions;$scope.maxSurveyTextSize=chatConfig.MaxSurveyTextSize;$translate(["APP.EG_SURVEY_RATING_1_TITLE","APP.EG_SURVEY_RATING_2_TITLE","APP.EG_SURVEY_RATING_3_TITLE","APP.EG_SURVEY_RATING_4_TITLE","APP.EG_SURVEY_RATING_5_TITLE"]).then(function(translations){$scope.titles=[translations["APP.EG_SURVEY_RATING_1_TITLE"],translations["APP.EG_SURVEY_RATING_2_TITLE"],translations["APP.EG_SURVEY_RATING_3_TITLE"],translations["APP.EG_SURVEY_RATING_4_TITLE"],translations["APP.EG_SURVEY_RATING_5_TITLE"]]});var cnt=0;angular.forEach($scope.surveyQuestions,function(value,key){ApplicationFactory.Translate(value.questionText).then(function(response){cnt++;value.questionText=response;if(angular.equals("STAR",value.controlType.toUpperCase())){value.rate=0}else if(angular.equals("TEXTAREA",value.controlType.toUpperCase())){value.answer=""}if(cnt===$scope.surveyQuestions.length){$scope.page.ready=true;$scope.page.progressbar.complete()}})});$scope.$watch("survey.submitted",function(newValue,oldValue){if(newValue){var surveyArray=[];angular.forEach($scope.surveyQuestions,function(value,key){if(angular.equals("STAR",value.controlType.toUpperCase())){if(!angular.isDefined(value.rate)){value.rate=0}surveyArray.push({Question:value.questionText,Answer:value.rate})}else if(angular.equals("TEXTAREA",value.controlType.toUpperCase())){if(!angular.isDefined(value.answer)){value.answer=""}surveyArray.push({Question:"surveyText",Answer:value.answer})}});var oneTagEventInfo={EventName:"ChatSurveySubmitted"};angular.forEach(surveyArray,function(param){if("surveyText".toUpperCase()!==param["Question"].toUpperCase()){oneTagEventInfo[param["Question"]]=param["Answer"]}});eGainOneTagUtil.pushChatEvent("aac",oneTagEventInfo);ChatService.SubmitSurvey(ConnectionFactory.GetConnection().sessionID,surveyArray,ApplicationFactory.GetXEgainSessionID()).then(function(response){if(response.isErrorPresent){$scope.survey.submitted=false}navigateToPage()},function(){$scope.survey.submitted=false;navigateToPage()})}});var navigateToPage=function(){$state.go("chat.thank-you")}}]);app.controller("PreChatParamsListController",["$state","$scope","$window","$filter","$timeout","$translate","$q","ApplicationFactory","ConfigFactory","ConnectionFactory","CustomerFactory","SessionFactory","ChatService","VAFactory",function($state,$scope,$window,$filter,$timeout,$translate,$q,ApplicationFactory,ConfigFactory,ConnectionFactory,CustomerFactory,SessionFactory,ChatService,VAFactory){var anonymousLogin=function(){var customerObject=CustomerFactory.CreateCustomer();customerObject.SetPrimaryKey(customerObject.PrimaryKeyParams.PRIMARY_KEY_EMAIL,"anonymous@egain.com");CustomerFactory.SetCustomer(customerObject);setEscalationDataAtLogin();ConnectionFactory.StartChat()};var setEscalationDataAtLogin=function(){if(VAFactory.IsVAEscalated()){var escalationData={vaDomain:VAFactory.GetVAHost(),vaTenantId:ApplicationFactory.GetUrlParameter("VATenantAccId"),vaSessionId:SessionFactory.GetVASessionId(),vaBotName:ApplicationFactory.GetUrlParameter("VAName")};CustomerFactory.SetEscalationData(escalationData)}};var autologin=function(){if($scope.preChatForm.loaded){processAutologin()}else{$scope.$watch("preChatForm.loaded",function(newValue){if(newValue){processAutologin()}})}function processAutologin(){angular.forEach($scope.loginParameters,function(param,key){param.pattern=unescape(param.validationPattern);var fieldName="";if(typeof param.providerAttributeName!="undefined"&&param.providerAttributeName!="null")fieldName=param.providerAttributeName;if(fieldName==="")var fieldName="fieldname_"+(key+1);var attributeFromUrl=ApplicationFactory.GetUrlParameter(fieldName);if(attributeFromUrl!==null){$scope.customer[param.eGainAttributeName]=decodeURI(attributeFromUrl)}else if($scope.useChatAttributes&&$scope.customerContextParameters&&angular.isDefined($scope.customerContextParameters[fieldName])){$scope.customer[param.eGainAttributeName]=$scope.customerContextParameters[fieldName]}else{$scope.customer[param.eGainAttributeName]=""}if(angular.isDefined(param.secureAttribute)&&param.secureAttribute=="1"){param.required=false}$scope.PreChatForm[param.eGainAttributeName].$setViewValue($scope.customer[param.eGainAttributeName]);$scope.PreChatForm[param.eGainAttributeName].$render();if(false===validateRequired(param,$scope.customer[param.eGainAttributeName])){$scope.PreChatForm[param.eGainAttributeName].$setValidity("required",false)}if(validateCrossSiteScripting($scope.customer[param.eGainAttributeName])){$scope.PreChatForm[param.eGainAttributeName].$setValidity("pattern",false)}});if($scope.customerContextParameters&&angular.isDefined($scope.customerContextParameters["SAMLResponse"]))CustomerFactory.SetSamlResponse($scope.customerContextParameters["SAMLResponse"]);$timeout(function(){if($scope.PreChatForm.$valid){$scope.preChatForm.submitted=true}else{$scope.page.hide=false;renderLoginPage().then(function(){validateFormFields($scope.PreChatForm)})}})}};var renderLoginPage=function(){var deferred=$q.defer();var array=[];for(var i=0;i<$scope.loginParameters.length;i++){var param=$scope.loginParameters[i];if(angular.equals("singleselect",param.controlType)||angular.equals("multiselect",param.controlType)){array.push({objectName:param.eGainParentObject+"::"+param.eGainChildObject,attributeName:param.eGainAttributeName})}}var locale=ApplicationFactory.GetUrlParameter("locale");var language=ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[0]?ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[0]:"en";var country=ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[1]?ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[1]:"US";if(array.length>0){ChatService.GetAttributesInfo(array,language,country,ApplicationFactory.GetXEgainSessionID()).then(function(attributesInfo){if(false===attributesInfo.isErrorPresent&&attributesInfo.returnData){proceedToFormDisplay(attributesInfo.returnData)}else{proceedToFormDisplay()}})}else{proceedToFormDisplay()}function proceedToFormDisplay(attributesInfo){if($scope.preChatForm.loaded){buildLoginFormDisplay(attributesInfo)}else{$scope.$watch("preChatForm.loaded",function(newValue){if(newValue){buildLoginFormDisplay(attributesInfo)}})}}function buildLoginFormDisplay(attributesInfo){for(var i=0;i<$scope.loginParameters.length;i++){var param=$scope.loginParameters[i];param.error=false;param.pattern=unescape(param.validationPattern);if(angular.equals("singleselect",param.controlType)||angular.equals("multiselect",param.controlType)){if(typeof attributesInfo!=="undefined"&&attributesInfo!==null){var attributeInfo=attributesInfo[param.eGainParentObject+"::"+param.eGainChildObject+"::"+param.eGainAttributeName];param.options=[];param.outputData=[];if(attributeInfo&&attributeInfo.attributeOptions){for(var j=0;j<attributeInfo.attributeOptions.length;j++){param.options.push({text:attributeInfo.attributeOptions[j].displayValue,id:attributeInfo.attributeOptions[j].internalValue})}}}}var fieldName="";if(typeof param.providerAttributeName!="undefined"&&param.providerAttributeName!="null")fieldName=param.providerAttributeName;if(fieldName==="")fieldName="fieldname_"+(i+1);var attributeFromUrl=ApplicationFactory.GetUrlParameter(fieldName);if(ConfigFactory.GetChatConfigurations().EnableAutologin&&attributeFromUrl!==null){$scope.customer[param.eGainAttributeName]=decodeURI(attributeFromUrl);$scope.PreChatForm[param.eGainAttributeName].$setTouched()}else if($scope.useChatAttributes&&$scope.customerContextParameters&&angular.isDefined($scope.customerContextParameters[fieldName])){$scope.customer[param.eGainAttributeName]=$scope.customerContextParameters[fieldName];$scope.PreChatForm[param.eGainAttributeName].$setTouched()}else{$scope.customer[param.eGainAttributeName]=""}}$scope.preChatForm.show=true;$scope.preChatForm.wait=false;$scope.page.progressbar.complete();deferred.resolve()}var oneTagEventInfo={EventName:"ChatFormDisplay"};eGainOneTagUtil.pushChatEvent("aac",oneTagEventInfo);return deferred.promise};var setCustomerParamsFromVA=function(){var vaCustomer=VAFactory.GetVACustomer();if($scope.customerContextParameters===null||typeof $scope.customerContextParameters==="undefined"){$scope.customerContextParameters={}}if(vaCustomer){for(var key=0;key<vaCustomer.length;key++){var value=vaCustomer[key];if(value&&value.trim()!=""){$scope.customerContextParameters["fieldname_"+(key+1)]=value.trim()}}$scope.useChatAttributes=true;return true}return false};var onChatParametersReceived=function(data){$scope.customerContextParameters=data;var vaAutoLogin=false;if(VAFactory.IsVAEscalated()){vaAutoLogin=setCustomerParamsFromVA()}if(ConfigFactory.GetChatConfigurations().EnableAutologin||vaAutoLogin){autologin()}else{renderLoginPage()}};var submitPreChat=function(){var oneTagCustomerInfo={};$scope.page.progressbar.start();$scope.customerObject=buildCustomerParameters(oneTagCustomerInfo);CustomerFactory.SetCustomer($scope.customerObject);if(!ConfigFactory.GetChatConfigurations().IsDeflectionEnabled){ConnectionFactory.StartChat(oneTagCustomerInfo)}else{$state.go("chat.deflection.escalation-results",{customer:$scope.customerObject,oneTagCustomerInfo:oneTagCustomerInfo})}};$scope.$on("application_service_chat_connect_success_event",function(evt,data){$state.go("chat.interaction",{chatConnectionInfo:data})});$scope.$on("application_service_chat_connection_failure_event",function(evt,data){$state.go("chat.error",{errorCode:"CONNECT_FAIL"})});$scope.$watch("preChatForm.submitted",function(newValue,oldValue){if(newValue===true){var form=$scope.PreChatForm;validateFormFields(form);if(form.$valid){submitPreChat()}else{$scope.preChatForm.submitted=false;form.$setPristine()}}});var validateCrossSiteScripting=function(inputvalue){var regex=/(<[\/\s]*script|<[\/\s]*img|<[\/\s]*iframe|javascript\s*:|on[a-zA-Z]*\s*=)/gi;return regex.test(inputvalue)};var validateRequired=function(param,inputvalue){if(false===param.required){return true}if(typeof inputvalue!=="undefined"&&inputvalue!==null){if("multiselect"===param.controlType||"singleselect"===param.controlType){return inputvalue.length>0}else{return inputvalue.trim().length>0}}return true};var validateFormFields=function(form,input){var $translateLocale=$filter("translate");if(angular.isDefined(input)&&input!==null){if(typeof formFieldsValidated!=="undefined"&&formFieldsValidated===true){validateFormField(input)}}else{if(typeof formFieldsValidated==="undefined"){formFieldsValidated=true}for(var count=0;count<$scope.loginParameters.length;count++){var param=$scope.loginParameters[count];validateFormField(param)}}function validateFormField(param){param.error=false;param.errorLabel="";if(false===validateRequired(param,$scope.customer[param.eGainAttributeName])){$timeout(function(){param.error=true});form[param.eGainAttributeName].$setValidity("required",false);param.errorLabel=$translateLocale("APP.EG_ERROR_REQUIRED",{FieldName:$translateLocale(param.label)});return}else{param.error=false;form[param.eGainAttributeName].$setValidity("required",true)}if(form[param.eGainAttributeName].$invalid){param.error=true;if(form[param.eGainAttributeName].$error.pattern){if(angular.equals("email_address",param.eGainAttributeName)){param.errorLabel=$translateLocale("APP.EG_EMAIL_ADDRESS_ERROR")}else if(angular.equals("phone_number",param.eGainAttributeName)){param.errorLabel=$translateLocale("APP.EG_PHONE_NUMBER_ERROR")}else{param.errorLabel=$translateLocale("APP.EG_ERROR_INVALID")}return}if(form[param.eGainAttributeName].$error.minlength){param.errorLabel=$translateLocale("APP.EG_ERROR_MINLENGTH",{MinLength:param.minLength});return}if(form[param.eGainAttributeName].$error.maxlength){param.errorLabel=$translateLocale("APP.EG_ERROR_MAXLENGTH",{MaxLength:param.maxLength});return}}else if(validateCrossSiteScripting($scope.customer[param.eGainAttributeName])){param.error=true;form[param.eGainAttributeName].$setValidity("pattern",false);form[param.eGainAttributeName].$setTouched();param.errorLabel=$translateLocale("APP.EG_ERROR_INVALID")}else{param.error=false}}};$scope.validateFormFields=validateFormFields;var buildCustomerParameters=function(oneTagEventInfo){$scope.customerObject=CustomerFactory.CreateCustomer();angular.forEach($scope.loginParameters,function(value,key){var customerChatParameter=new ApplicationFactory.GetEgainChatParameter;customerChatParameter.eGainParamName=value.eGainAttributeName;customerChatParameter.eGainParentObject=value.eGainParentObject;customerChatParameter.eGainChildObject=value.eGainChildObject;customerChatParameter.eGainAttribute=value.eGainAttributeName;customerChatParameter.eGainMinLength=value.minLength;customerChatParameter.eGainMaxLength=value.maxLength;customerChatParameter.eGainRequired=value.required?"1":"0";customerChatParameter.eGainFieldType="1";customerChatParameter.eGainValidationString=value.validationPattern;customerChatParameter.secureAttribute=angular.isDefined(value.secureAttribute)?value.secureAttribute:"0";if(customerChatParameter.secureAttribute&&customerChatParameter.secureAttribute=="1"){customerChatParameter.providerAttributeName=value.providerAttributeName}if(angular.equals("subject",value.eGainAttributeName)){customerChatParameter.eGainValue=$scope.customer[value.eGainAttributeName];customerChatParameter.eGainValue=ApplicationFactory.MaskMessage(customerChatParameter.eGainValue);customerChatParameter.eGainValue=ApplicationFactory.htmlEncode(customerChatParameter.eGainValue);customerChatParameter.eGainValue=customerChatParameter.eGainValue.replace(/\n/g,"<br/>")}else{customerChatParameter.eGainValue=$scope.customer[value.eGainAttributeName]}$scope.customerObject.AddCustomerParameter(customerChatParameter);oneTagEventInfo[customerChatParameter.eGainAttribute]=customerChatParameter.eGainValue;if(value.primaryKey){customerChatParameter.eGainPrimaryKey="1";var primaryKeyParamType;if(angular.equals("email_address",value.eGainAttributeName)){primaryKeyParamType=$scope.customerObject.PrimaryKeyParams.PRIMARY_KEY_EMAIL}else{primaryKeyParamType=$scope.customerObject.PrimaryKeyParams.PRIMARY_KEY_PHONE}$scope.customerObject.SetPrimaryKey(primaryKeyParamType,$scope.customer[value.eGainAttributeName])}else{customerChatParameter.eGainPrimaryKey="0"}});$scope.customerObject["name"]=$scope.customerObject["full_name"];if(!$scope.customerObject["name"]){$scope.customerObject["name"]=$scope.customerObject["first_name"];$scope.customerObject["name"]=$scope.customerObject["name"]?$scope.customerObject["last_name"]?$scope.customerObject["first_name"]+" "+$scope.customerObject["last_name"]:$scope.customerObject["name"]:$scope.customerObject["last_name"]}$scope.customerObject["name"]=$scope.customerObject["name"]||CustomerFactory.GetCustomerScreenName();return $scope.customerObject};var getCustomerParamsFromStorage=function(){if($window.localStorage&&$window.localStorage.getItem("egainChatParameters")){var egainChatParams=$window.localStorage.getItem("egainChatParameters");$window.localStorage.removeItem("egainChatParameters")}else if($window.localStorage&&!$window.localStorage.windowRefreshed&&$window.location.protocol=="https:"){setTimeout(function(){$window.location.reload()},100);$window.localStorage.windowRefreshed=true}else{var localStorageWindow=null;try{localStorageWindow=$window.open("","egainChatDomainFrame");var egainChatParams=localStorageWindow?localStorageWindow.getChatParameters():null}catch(e){localStorageWindow.close();$state.go("chat.error",{errorCode:"400-112"})}}if(egainChatParams){onChatParametersReceived(JSON.parse(egainChatParams))}else{renderLoginPage()}};eGainOneTagUtil.pushChatEvent("aac",{EventName:"ChatEntry"});$scope.page.ready=true;$scope.page.progressbar.start();$scope.customer={};$scope.loginParameters=ConfigFactory.GetChatConfigurations().LoginParameters;$scope.isVisitorIOSPhone=false;if(ApplicationFactory.IsVisitorIOSPhone()){$scope.isVisitorIOSPhone=true}setEscalationDataAtLogin();var showPrechatForm=true;if($scope.loginParameters.length==0){showPrechatForm=false;anonymousLogin()}else if(VAFactory.IsVAEscalated()){if(!VAFactory.GetShowPreChatOnEscalation()){if(VAFactory.GetVACustomer()){ApplicationFactory.RetrieveFromParentStorage("EgainChatParameter",onChatParametersReceived)}else{anonymousLogin()}showPrechatForm=false;$scope.preChatForm.wait=true}}if(showPrechatForm){$scope.useChatAttributes=ApplicationFactory.GetUrlParameter("postChatAttributes")==="true"?true:false;if($scope.useChatAttributes){if(MobileInterface){MobileInterface.GetCustomerData(onChatParametersReceived)}else{if(ApplicationFactory.IsUndocked()&&($window.navigator.userAgent.indexOf("Trident")!==-1||$window.navigator.userAgent.indexOf("Edge")!==-1)){getCustomerParamsFromStorage()}else{ApplicationFactory.RetrieveFromParentStorage("EgainChatParameter",onChatParametersReceived)}}}else{if(ConfigFactory.GetChatConfigurations().EnableAutologin){$timeout(function(){autologin()})}else{renderLoginPage()}}}}]);app.controller("StatusBarController",["$rootScope","$stateParams","$scope","$timeout","ConfigFactory","ChatHeaderFactory",function($rootScope,$stateParams,$scope,$timeout,ConfigFactory,ChatHeaderFactory){var typingStatusTimer=null;$scope.scrollToBottom=function(){if($scope.page.showNewMessageSign){$scope.page.scrollToBottom();$scope.page.showNewMessageSign=false}};$scope.$on("application_service_agent_message_received_event",function(evt,data){if(typingStatusTimer){clearTimeout(typingStatusTimer)}$scope.$apply(function(){$scope.showTypingStatus=false})});$scope.$on("application_service_agent_start_typing_event",function(evt,data){$scope.$apply(function(){$scope.showTypingStatus=true;$scope.agentScreenName=data.AgentScreenName});typingStatusTimer=setTimeout(function(){$scope.$apply(function(){$scope.showTypingStatus=false})},4e4)});$scope.$on("application_service_agent_stop_typing_event",function(evt,data){$scope.$apply(function(){$scope.showTypingStatus=false})});var errorMessagePublished=false;$scope.$on("application_service_chat_error_message_published",function(evt,data){errorMessagePublished=true});var connectionErrorMsgListener=null;$scope.$on("application_service_network_disconnect_event",function(evt,data){connectionErrorMsgListener=$scope.$watch(function(){return errorMessagePublished},function(newValue,oldValue){if(newValue===true){showReconnectingStatus();connectionErrorMsgListener();connectionErrorMsgListener=null}});function showReconnectingStatus(){if($scope.showTypingStatus){$scope.showTypingStatus=false}$scope.showReconnectingStatus=true}});$scope.$on("application_service_network_reconnect_event",function(evt,data){$scope.showReconnectingStatus=false;errorMessagePublished=false;if(typeof connectionErrorMsgListener==="function"){connectionErrorMsgListener();connectionErrorMsgListener=null}});$scope.$on("application_service_extended_timeout_expired",function(evt,data){$scope.showReconnectingStatus=false});$scope.$watch(function(){return ChatHeaderFactory.GetChatHeader()},function(newValue,oldValue){$scope.waitTimeMessage=newValue})}]);app.controller("ThanksMessagesController",["$scope","ApplicationFactory","ConfigFactory",function($scope,ApplicationFactory,ConfigFactory){var isShowSurvey=ConfigFactory.GetChatConfigurations().SurveyPageOn;if(isShowSurvey){ApplicationFactory.Translate("APP.EG_THANKS_SURVEY_MESSAGE").then(function(result){$scope.thanksMessage=result})}else{ApplicationFactory.Translate("APP.EG_THANKS_CHAT_MESSAGE").then(function(result){$scope.thanksMessage=result})}}]);app.controller("TranscriptController",["$state","$scope","$stateParams","$filter","$rootScope","$window","$timeout","ConfigFactory","MessageFactory","CustomerFactory","ApplicationFactory","ChatHeaderFactory","ConnectionFactory","AttachmentFactory","VAFactory","TranscriptFactory","GHFactory",function($state,$scope,$stateParams,$filter,$rootScope,$window,$timeout,ConfigFactory,MessageFactory,CustomerFactory,ApplicationFactory,ChatHeaderFactory,ConnectionFactory,AttachmentFactory,VAFactory,TranscriptFactory,GHFactory){$scope.transcript={Messages:[]};var additionalRealTimeMessages=[];var msgIdsFromTranscript={};var customerName;var transcriptFromServer;var settings=ConfigFactory.GetChatConfigurations();var $translate=$filter("translate");$scope.page.badgeCount=MessageFactory.GetBadgeCount();$scope.iOSDevice=window.navigator.userAgent.match(/(iPhone|iPad)/)!=null;$scope.attachedChat=$stateParams.attachedChat;if($scope.attachedChat){$scope.page.progressbar.start()}var egainChatLibrary=ApplicationFactory.GetEgainChatLibrary();var transcriptLoaded=false;var applicationFailoverSuccess=false;var agentMsgEvtId=ApplicationFactory.GetParameterFromUrlOrStorage("egAgentMsg")?parseInt(ApplicationFactory.GetParameterFromUrlOrStorage("egAgentMsg")):0;var systemMsgEvtId=ApplicationFactory.GetParameterFromUrlOrStorage("egSystemMsg")?parseInt(ApplicationFactory.GetParameterFromUrlOrStorage("egSystemMsg")):0;var message=function(message,messageType,author,time,avatar,attachment,attachmentThumbnail,attachmentLink,showAcceptReject){this.Body=message;this.SenderType=messageType;this.SenderName=author;this.Timestamp=time;this.OffRecord=false;this.Avatar=avatar;this.Hidden=false;this.AgentInvitation="";this.Attachment=attachment;this.AttachmentThumbnail=attachmentThumbnail;this.AttachmentLink=attachmentLink;this.showAcceptReject=showAcceptReject};var processTranscriptCallback=function(response){transcriptFromServer=response;if(transcriptFromServer.isVATranscript)loadVATranscript(transcriptFromServer);else loadTranscript(transcriptFromServer);if(!transcriptFromServer.isVATranscript){if(typeof transcriptFromServer.Assignee==="undefined"){delete $scope.transcript.Assignee;checkQueueStatus()}else{$scope.transcript.Assignee=transcriptFromServer.Assignee;$scope.page.showWaitTime=false;$scope.page.showAlternateEngagementOptions=false}}};var processTranscriptAfterFallback=function(response){var transcriptFromServer=response;if(typeof transcriptFromServer.Assignee==="undefined"){delete $scope.transcript.Assignee;checkQueueStatus()}else{$scope.transcript.Assignee=transcriptFromServer.Assignee;$scope.page.showWaitTime=false;$scope.page.showAlternateEngagementOptions=false}mergeTranscripts(transcriptFromServer)};var getTranscripts=function(forceAPICall){if(VAFactory.IsVAActive()){if($stateParams.attachedChat){$scope.interactionPage.wait=true;VAFactory.GetVATranscript(false).then(function(response){processTranscriptCallback(response)})}else{transcriptLoaded=true;VAFactory.SendVaMessage("")}}else{if(VAFactory.IsVAEscalated()){$scope.interactionPage.wait=true;sendQuickpickData();VAFactory.GetVATranscript(true).then(function(response){processTranscriptCallback(response)})}else{MessageFactory.GetChatTranscript(forceAPICall).then(function(response){if(applicationFailoverSuccess){processTranscriptAfterFallback(response)}else{processTranscriptCallback(response)}})}}};getTranscripts();$scope.$on("application_service_agent_message_received_event",function(evt,data){var currentTime=MessageFactory.GetFormattedTime(new Date);var messageType=MessageFactory.GetAgentMessageType(data.AgentScreenName);var msgObject=new message(data.Message,messageType,data.AgentScreenName,currentTime);msgObject.MsgId=data.MsgId;msgObject.PagePushMessage=data.PagePushMessage;pushToTranscript(msgObject);$scope.$apply();if(VAFactory.IsVAActive()&&angular.isDefined(data.avatar)&&0<data.avatar.length){ChatHeaderFactory.SetChatHeaderImage(data.avatar,false)}if(angular.isDefined(data.url)&&0<data.url.length){var p=ApplicationFactory.CreatePayload("PAGEPUSH","UrlToPush",data.url,"EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(p,"*")}if(data.escalate){$timeout(function(){VAFactory.SetVAActive(false);VAFactory.SetVAEscalated(true);if(true===GHFactory.GetGHActive()){GHFactory.CreateQuickPick().then(function(response){GHFactory.CloseGHWindow(false)})}escalateToChat()},2e3,false)}});var msgObject;$scope.$on("application_service_system_message_received_event",function(evt,data){var currentTime=MessageFactory.GetFormattedTime(new Date);var attachmentSendingCancelled=false;if(data.AgentJoinedMessage){$scope.page.showWaitTime=false}if(data.AttachmentAcceptedMsg){attachmentSendingCancelled=isAttachmentSendingCancelled(data.uniqueFileId)}if(data.Attachment){if(data.ArticleAttachmentMessage){var attachmentLink="<a id='eg-attachment-link' eg-attachment-id='"+data.Attachment.Id+"'>"+data.Attachment.Name+"</a>";data.Message=ApplicationFactory.GetFormattedMessage($rootScope.messagingProperty.attachment_msg,[attachmentLink]);msgObject=new message(data.Message,"System","",currentTime)}else{var attachmentMessage=new message($translate("APP.EG_PENDING"),"System",data.Attachment.AgentName,currentTime,"",data.Attachment,"components/transcript/icon_upload_32.gif","",true);msgObject=attachmentMessage}}else{msgObject=new message(data.Message,"System","",currentTime)}msgObject.MsgId=data.MsgId;if(!attachmentSendingCancelled)pushToTranscript(msgObject);$scope.$apply()});$scope.$on("application_service_chat_connection_failure_event",function(evt,data){var msgObject=new message($translate("APP.EG_CONNECTION_FAILURE"),"System");pushToTranscript(msgObject);$scope.$apply()});$scope.$on("application_service_extended_timeout_expired",function(evt,data){var msgObject=new message($translate("APP.EG_CONNECTION_FAILURE"),"System");pushToTranscript(msgObject);$scope.$apply()});$scope.$on("application_failover_success_event",function(){applicationFailoverSuccess=true;getTranscripts(true)});$scope.$on("application_service_send_system_message_event",function(evt,data,isHidden){var msgObject=new message(data,"System");if("undefined"!==typeof isHidden){msgObject.Hidden=isHidden}if(!isAttachmentSendingCancellationMsg(data)){if(isHidden){pushToTranscript(msgObject,false)}else{pushToTranscript(msgObject,true)}}});$scope.$on("application_service_send_message_to_agent_event",function(evt,data){var currentTime=MessageFactory.GetFormattedTime(new Date);var msgObject=new message(data.sentMessage,"Customer",customerName,currentTime);msgObject.OffRecord=MessageFactory.GetOffRecordFlag();pushToTranscript(msgObject);if(!angular.equals(data.sentMessage,data.originalMessage)){MessageFactory.SendSystemMessage($translate("APP.EG_SENSITIVE_DATA_NOTIFICATION"))}});$scope.$on("application_service_chat_transfer_event",function(){delete $scope.transcript.Assignee;checkQueueStatus()});$scope.$on("application_service_server_notification_received_event",function(evt,data){var clearPollQueueStatusTimerVar=true;if(typeof systemMessageIntegHook==="function"){clearPollQueueStatusTimerVar=systemMessageIntegHook(data.MessageFromServer)}if(clearPollQueueStatusTimerVar){stopQueueStatusCheck()}});$scope.$on("application_service_attachment_notification_sent_event",function(evt,data){if(data.status===$translate("APP.EG_FAILED").toLowerCase()){}else{var file=data.File;file.Id=file.uniqueFileId;file.Name=file.filename;file.AttachmentSize=file.size;var currentTime=MessageFactory.GetFormattedTime(new Date);var msgObject=new message($translate("APP.EG_WAITING"),"Customer",customerName,currentTime,"",file,"components/transcript/icon_upload_32.gif","");pushToTranscript(msgObject,true);TranscriptFactory.IncreasePendingAttachmentCount();$scope.$apply()}});$scope.onDownloadAttachment=function(fileId){};$scope.$on("application_service_get_attachment_event",function(evt,agentAttachmentArgs){$scope.scrollToBottom=false;var fileId;if(agentAttachmentArgs.uniqueFileId){fileId=agentAttachmentArgs.uniqueFileId}else{fileId=agentAttachmentArgs.fileId}var fileName;angular.forEach($scope.transcript.Messages,function(msg,key){if(msg.Attachment&&angular.equals(fileId,msg.Attachment.Id)){var data=agentAttachmentArgs.data;fileName=msg.Attachment.Name;if(MobileInterface){msg.AttachmentLink=agentAttachmentArgs.originalUrl}else{if($scope.iOSDevice){var extension=fileName.split(".").pop();if(/\.(gif|jpg|jpeg|png)$/i.test("."+extension.toLowerCase())){var mimeType="image/"+extension;var blob=new Blob([data],{type:mimeType});msg.AttachmentLink=blob}else if(/\.(txt)$/i.test("."+extension.toLowerCase())){var mimeType="text/plain";var blob=new Blob([data],{type:mimeType});msg.AttachmentLink=blob}else if(/\.(pdf)$/i.test("."+extension.toLowerCase())){var mimeType="application/pdf";var blob=new Blob([data],{type:mimeType});msg.AttachmentLink=blob}else{var mimeType="application/octet-stream";var blob=new Blob([data],{type:mimeType});msg.AttachmentLink=blob}}else{var blob=new Blob([data]);url=$window.URL||$window.webkitURL;var fileUrl=url.createObjectURL(blob);msg.AttachmentLink=fileUrl;msg.AttachmentBlob=blob}}if(typeof fileName!=="undefined"&&fileName!==null){if(/\.(gif|jpg|jpeg|tiff|png)$/i.test(fileName)){if($scope.page.isScrolledToBottom()){$scope.scrollToBottom=true}msg.AttachmentThumbnail=AttachmentFactory.GetImageThumbnail(agentAttachmentArgs.fileId,agentAttachmentArgs.uniqueFileId)}}}});MessageFactory.SetTranscript($scope.transcript);$scope.$apply()});$scope.$on("application_service_get_attachment_image_thumbnail_event",function(evt,attachmentThumbnailArgs){var fileId;if(attachmentThumbnailArgs.uniqueFileId){fileId=attachmentThumbnailArgs.uniqueFileId}else{fileId=attachmentThumbnailArgs.fileId}angular.forEach($scope.transcript.Messages,function(msg,key){if(msg.Attachment&&angular.equals(fileId,msg.Attachment.Id)){msg.AttachmentThumbnail=attachmentThumbnailArgs.data}});MessageFactory.SetTranscript($scope.transcript);if($scope.page.isScrolledToBottom()){$timeout(function(){$scope.page.scrollToBottom()},200)}$scope.$apply()});$scope.onClickAcceptChatAttachment=function(file,name){AttachmentFactory.SendAcceptChatAttachmentNotification(file,name);angular.element(document.getElementById(file)).children()[0].focus();angular.element(document.getElementById(file)).children()[0].tabIndex=0};$scope.onClickRejectChatAttachment=function(file,name){AttachmentFactory.SendRejectChatAttachmentNotification(file,name)};$scope.$on("application_service_attachment_accepted_notification_sent",function(evt,data){var args=new Array;var currentTime=MessageFactory.GetFormattedTime(new Date);args[1]=data.FileName;args[0]=data.CustomerName;var customerAcceptedAttachmentMsg=decodeURIComponent(JSON.parse('"'+$rootScope.messagingProperty.accepted_chat_attachment+'"'));var msgObject=new message(ApplicationFactory.GetFormattedMessage(customerAcceptedAttachmentMsg,args),"System","",currentTime);msgObject.Hidden=true;msgObject.MsgId=data.MsgId;updateAttachmentStatus(data.FileId,$translate("APP.EG_RECIEVED"),"components/transcript/icon_attachment_32.gif");AttachmentFactory.GetAttachment(data.FileId);pushToTranscript(msgObject)});$scope.$on("application_service_attachment_rejected_notification_sent",function(evt,data){var args=new Array;var currentTime=MessageFactory.GetFormattedTime(new Date);args[1]=data.FileName;args[0]=customerName;var customerRejectedAttachmentMsg=decodeURIComponent(JSON.parse('"'+$rootScope.messagingProperty.rejected_chat_attachment+'"'));var msgObject=new message(ApplicationFactory.GetFormattedMessage(customerRejectedAttachmentMsg,args),"System","",currentTime);msgObject.Hidden=true;msgObject.MsgId=data.MsgId;pushToTranscript(msgObject);updateAttachmentStatus(data.fileId,$translate("APP.EG_REJECTED"),"components/transcript/icon_reject.gif");
});var attachmentDisabledResponse="";ApplicationFactory.Translate("APP.EG_QUEUE_ATTACHMENT_DISABLED_RESPONSE").then(function(result){attachmentDisabledResponse=result});$scope.$on("application_service_attachment_uploaded_by_customer_event",function(evt,data){if("failed"===data.status){if(angular.equals("attachmentSettingDisabledForCustomer",data.message)){data.message=attachmentDisabledResponse}updateAttachmentStatus(data.uniqueFileId,$translate("APP.EG_FAILED")+"("+data.message+")","components/transcript/icon_reject.gif")}else if("failed-failover"===data.status){updateAttachmentStatus(data.uniqueFileId,$translate("APP.EG_FAILED"),"components/transcript/icon_reject.gif")}else{var fileName=data.attachmentName;var fileInternalName=data.attachmentInternalName;var uniqueFileId=fileInternalName?fileInternalName.substr(0,fileInternalName.indexOf(fileName)-1):"";if(typeof data.status!="undefined"&&data.status==200){updateAttachmentStatus(uniqueFileId,$translate("APP.EG_SENT"),"components/transcript/icon_attachment_32.gif");AttachmentFactory.GetAttachment(data.attachmentId,uniqueFileId);TranscriptFactory.DecreasePendingAttachmentCount()}else{updateAttachmentStatus(uniqueFileId,$translate("APP.EG_FAILED"),"components/transcript/icon_reject.gif")}}});$scope.$on("application_service_attachment_rejected_by_agent_event",function(evt,data){updateAttachmentStatus(data.uniqueFileId,$translate("APP.EG_REJECTED"),"components/transcript/icon_reject.gif");TranscriptFactory.DecreasePendingAttachmentCount()});$scope.$on("$destroy",function(){stopQueueStatusCheck()});$scope.getAttachmentSizeUnit=function(bytes){if(bytes>=1048576){bytes=Math.floor(bytes*10/1048576)/10+" MB"}else if(bytes>=1024){bytes=Math.floor(bytes*10/1024)/10+" KB"}else if(bytes>1){bytes=bytes+" bytes"}else if(bytes==1){bytes=bytes+" byte"}else{bytes="0 byte"}return bytes};var checkQueueStatusPollOn=false;var queueStatusPollTimer;var waitTimeStart;var checkQueueStatus=function(){if(settings.DisplayForChatWaitingSatus===""){ChatHeaderFactory.SetChatHeader("");return}if(!checkQueueStatusPollOn){var d=new Date;waitTimeStart=d.getTime()}checkQueueStatusPollOn=true;ConnectionFactory.GetQueueCurrentStatus().then(function(queueStatus){if(true===checkQueueStatusPollOn){$timeout(function(){if(true===checkQueueStatusPollOn){var queuePosition=queueStatus.QueueDepth;var waitTime=queueStatus.WaitTime;var altEngmtTime=queueStatus.AltEngmtTime;if(settings.DisplayForChatWaitingSatus==="QUEUE_POSITION"){ChatHeaderFactory.SetChatHeader("APP.EG_QUEUE_POSITION",{queuePosition:queuePosition})}else if(settings.DisplayForChatWaitingSatus==="WAIT_TIME"&&waitTime!==1){ChatHeaderFactory.SetChatHeader("APP.EG_WAIT_TIME",{waitTime:waitTime})}else if(settings.DisplayForChatWaitingSatus==="WAIT_TIME"&&waitTime===1){ChatHeaderFactory.SetChatHeader("APP.EG_WAIT_TIME_SINGULAR")}if(waitTime>0){$scope.page.showWaitTime=true}else{$scope.page.showWaitTime=false}if(altEngmtTime>-1){var day=new Date;var currTime=day.getTime();if((currTime-waitTimeStart)/6e4>=altEngmtTime){$scope.page.showAlternateEngagementOptions=true}}else{$scope.page.showAlternateEngagementOptions=false}}});queueStatusPollTimer=$timeout(checkQueueStatus,30*1e3)}})};var stopQueueStatusCheck=function(){if(true===checkQueueStatusPollOn&&true!==ApplicationFactory.GetMailLinkClicked()){$timeout(function(){if(true===checkQueueStatusPollOn&&true!==ApplicationFactory.GetMailLinkClicked()){$scope.page.showAlternateEngagementOptions=false;$scope.page.showWaitTime=false;$timeout.cancel(queueStatusPollTimer);checkQueueStatusPollOn=false}})}};$scope.$on("application_service_chat_error_occurred_event",function(evt,data){stopQueueStatusCheck()});var pushToTranscript=function(msgObject,forceScrollToBottom){if(msgObject.Body){var msgObjectCopy=angular.copy(msgObject);if(false===transcriptLoaded){additionalRealTimeMessages.push(msgObjectCopy)}else if(true===isMessageUnique(msgObjectCopy)){pushOnetagEvents(msgObjectCopy);$scope.transcript.Messages.push(msgObjectCopy);$scope.lastMessageIndex=$scope.transcript.Messages.length}updateScrollPosition(msgObject,forceScrollToBottom)}};var updateScrollPosition=function(msgObject,forceScrollToBottom){if(!$scope.page.minimized){if(angular.isDefined($scope.page.isScrollingOn)){if($scope.page.isScrollingOn()===false||forceScrollToBottom===true){$timeout(function(){$scope.page.scrollToBottom()})}else{if(VAFactory.IsVAActive()){$timeout(function(){$scope.page.scrollToBottom()})}else{if(msgObject.SenderType==="Customer"){$timeout(function(){$scope.page.scrollToBottom()})}else if($scope.page.isScrolledToBottom()){$timeout(function(){$scope.page.scrollToBottom()})}else{if(!msgObject.Hidden){$scope.page.showNewMessageSign=true}}$rootScope.$broadcast("application_service_add_to_transcript_event",msgObject);MessageFactory.SetTranscript($scope.transcript)}}}}if($scope.page.minimized===true){$scope.page.badgeCount++;MessageFactory.SetBadgeCount($scope.page.badgeCount)}};var loadVATranscript=function(transcript){angular.forEach(transcript.Messages,function(msg,key){var messageType=msg.SenderType===""?$translate("APP.EG_CUSTOMER"):MessageFactory.GetAgentMessageType(msg.SenderType);var msgObj=new message(msg.Body,messageType,msg.SenderName,MessageFactory.GetFormattedTime(new Date(msg.Timestamp)));$scope.transcript.Messages.push(msgObj)});if(transcript.isVAEscalated){MessageFactory.GetChatTranscript().then(function(response){processTranscriptCallback(response)})}else{mergeAdditionalRealTimeMessages();transcriptLoaded=true}$scope.interactionPage.wait=false;$scope.page.ready=true;$scope.page.progressbar.complete();$timeout(function(){$scope.page.scrollToBottom()})};var processMessage=function(msg){var hidden=false;var offRecord=false;var messageType=msg.SenderType;if(angular.equals("System",msg.SenderType)){if(isCustomerAttachmentAcceptedMessage(msg.Body,customerName)||isCustomerAttachmentRejectedMessage(msg.Body,customerName)||isQuickPickMessage(msg.Body)){hidden=true}}if(angular.equals("Agent",msg.SenderType)){messageType=MessageFactory.GetAgentMessageType(msg.SenderName)}var msgObj;if(msg.Attachment){msgObj=processAttachmentsFromTranscript(msg)}else{msgObj=new message(msg.Body,messageType,msg.SenderName,MessageFactory.GetFormattedTime(new Date(msg.Timestamp),msg.Timestamp));msgObj.OffRecord=msg.OffRecord;msgObj.Hidden=hidden;msgObj.OffRecord=offRecord}msgObj.MsgId=msg.MsgId;addMsgId(msgObj.MsgId);if(msg.InvitationMedia){msgObj.InvitationMedia=msg.InvitationMedia}if(msg.InvitationStatus){msgObj.InvitationStatus=msg.InvitationStatus}pushOnetagEvents(msg);return msgObj};var mergeTranscripts=function(transcriptFromServer){if($scope.transcript.Messages.length===0){loadTranscript(transcriptFromServer);return}var transcriptMesgIdArr=[];angular.forEach($scope.transcript.Messages,function(mesg){if(mesg.Attachment){if(mesg.Attachment.SenderType!=="Customer"){transcriptMesgIdArr.push(mesg.Attachment.Id)}else{transcriptMesgIdArr.push(mesg.Attachment.Id+"_"+mesg.Attachment.name)}}else if(mesg.SenderType!=="Customer"){transcriptMesgIdArr.push(mesg.MsgId)}});angular.forEach(transcriptFromServer.Messages,function(mesgFromAPI){if(mesgFromAPI.Attachment&&mesgFromAPI.Attachment.SenderType==="Agent"){if(transcriptMesgIdArr.indexOf(mesgFromAPI.Attachment.Id)===-1){var msgObj=processMessage(mesgFromAPI);if(!isAttachmentSendingCancellationMsg(mesgFromAPI.Body)){$scope.transcript.Messages.push(msgObj)}}}else if(!mesgFromAPI.Attachment&&mesgFromAPI.SenderType!=="Customer"&&transcriptMesgIdArr.indexOf(mesgFromAPI.MsgId)===-1){var msgObj=processMessage(mesgFromAPI);if(!isAttachmentSendingCancellationMsg(mesgFromAPI.Body)){$scope.transcript.Messages.push(msgObj)}}});$scope.lastMessageIndex=$scope.transcript.Messages.length};var loadTranscript=function(transcript){if(!VAFactory.IsVAEscalated())$scope.transcript.Messages=[];customerName=transcript.CustomerName?transcript.CustomerName:$translate("APP.EG_CUSTOMER");CustomerFactory.SetCustomerScreenName(customerName);var subject=transcript.Subject?transcript.Subject:"";$rootScope.subject=subject;$scope.transcript.CustomerName=customerName;$scope.transcript.Subject=subject;var lastAVChatInvitationMedia=null;var lastAVChatInvitationStatus=null;angular.forEach(transcript.Messages,function(msg,key){var msgObj=processMessage(msg);if(msg.InvitationMedia){lastAVChatInvitationMedia=msg.InvitationMedia}if(msg.InvitationStatus){lastAVChatInvitationStatus=msg.InvitationStatus}if(!isAttachmentSendingCancellationMsg(msg.Body))$scope.transcript.Messages.push(msgObj)});mergeAdditionalRealTimeMessages();MessageFactory.SetTranscript($scope.transcript);MessageFactory.SetLastAVChatInvitationDetails(lastAVChatInvitationMedia,lastAVChatInvitationStatus);transcriptLoaded=true;$scope.interactionPage.wait=false;$scope.page.ready=true;$scope.page.progressbar.complete();ApplicationFactory.transcriptLoaded();$timeout(function(){$scope.page.scrollToBottom()})};var addMsgId=function(messageId){if(messageId&&"string"===typeof messageId&&msgIdsFromTranscript){msgIdsFromTranscript[messageId]=true}};var isMessageUnique=function(realTimeMessage){var isUnique=realTimeMessage&&(!realTimeMessage.MsgId||true!==msgIdsFromTranscript[realTimeMessage.MsgId]);return isUnique};var pushOnetagEvents=function(msg){try{if(msg.SenderType.toLowerCase().indexOf("agent")!==-1){if(parseInt(msg.MsgId.split("$")[2])>agentMsgEvtId){if(!msg.OffRecord){eGainOneTagUtil.pushChatAgentMsg(msg.Body)}ApplicationFactory.PersistToParentStorage("egAgentMsg",msg.MsgId.split("$")[2])}}else if(msg.SenderType.toLowerCase().indexOf("system")!==-1){if(parseInt(msg.MsgId.split("$")[2])>systemMsgEvtId){eGainOneTagUtil.pushChatSystemMsg(msg.Body);ApplicationFactory.PersistToParentStorage("egSystemMsg",msg.MsgId.split("$")[2])}}}catch(e){}};var mergeAdditionalRealTimeMessages=function(){if(additionalRealTimeMessages&&0<additionalRealTimeMessages.length){additionalRealTimeMessages.forEach(function(realTimeMessage){if(true===isMessageUnique(realTimeMessage)){$scope.transcript.Messages.push(realTimeMessage);if(angular.equals("System",realTimeMessage.type)){eGainOneTagUtil.pushChatSystemMsg(realTimeMessage.Message)}}})}additionalRealTimeMessages=[];$scope.lastMessageIndex=$scope.transcript.Messages.length};var customerAttachmentAcceptedMsg;if(typeof $rootScope.messagingProperty!=="undefined"&&$rootScope.messagingProperty!==null){customerAttachmentAcceptedMsg=decodeURIComponent(JSON.parse('"'+$rootScope.messagingProperty.accepted_chat_attachment+'"'))}var customerAttachmentRejectedMsg;if(typeof $rootScope.messagingProperty!=="undefined"&&$rootScope.messagingProperty!==null){customerAttachmentRejectedMsg=decodeURIComponent(JSON.parse('"'+$rootScope.messagingProperty.rejected_chat_attachment+'"'))}var quickPickMsg;ApplicationFactory.Translate("APP.EG_QUICKPICK_MSG").then(function(response){quickPickMsg=response});var articleAttachmentMsg;if(typeof $rootScope.messagingProperty!=="undefined"&&$rootScope.messagingProperty!==null){articleAttachmentMsg=decodeURIComponent(JSON.parse('"'+$rootScope.messagingProperty.attachment_msg+'"'))}var attachmentSendingCancellationMsg;if(typeof $rootScope.messagingProperty!=="undefined"&&$rootScope.messagingProperty!==null){attachmentSendingCancellationMsg=decodeURIComponent(JSON.parse('"'+$rootScope.messagingProperty.attachment_sending_cancelled+'"'))}var isCustomerAttachmentAcceptedMessage=function(message,customerName){if(VAFactory.IsVAActive())return false;else{var customerAttachmentAccepted=customerAttachmentAcceptedMsg.replace("{0}",customerName);customerAttachmentAccepted=customerAttachmentAccepted.substr(0,customerAttachmentAccepted.indexOf("{1}")-1);if(message.indexOf(customerAttachmentAccepted)===0){return true}}return false};var isCustomerAttachmentRejectedMessage=function(message,customerName){if(VAFactory.IsVAActive())return false;else{var customerAttachmentRejected=customerAttachmentRejectedMsg.replace("{0}",customerName);customerAttachmentRejected=customerAttachmentRejected.substr(0,customerAttachmentRejected.indexOf("{1}")-1);if(message.indexOf(customerAttachmentRejected)===0){return true}}return false};var isQuickPickMessage=function(message){if(VAFactory.IsVAActive())return false;else{if(angular.equals(message,quickPickMsg)){return true}}return false};var isArticleAttachmentMsg=function(message,attachmentName){if(VAFactory.IsVAActive())return false;else{var articleAttachmentRecieved=articleAttachmentMsg.replace("{0}",attachmentName);if(message.indexOf(articleAttachmentRecieved)===0){return true}}return false};var isAttachmentSendingCancellationMsg=function(message){if(VAFactory.IsVAActive())return false;else{if(angular.equals(message,attachmentSendingCancellationMsg)){return true}}return false};var updateAttachmentStatus=function(fileId,newStatus,newThumbnail){angular.forEach($scope.transcript.Messages,function(msg,key){if(msg.Attachment&&angular.equals(fileId,msg.Attachment.Id)){msg.Body=newStatus;msg.AttachmentThumbnail=newThumbnail;msg.showAcceptReject=false}});MessageFactory.SetTranscript($scope.transcript);$scope.$apply()};var createObjectURL=function(file){if(window.webkitURL){return window.webkitURL.createObjectURL(file)}else if(window.URL&&window.URL.createObjectURL){return window.URL.createObjectURL(file)}else{return null}};var processAttachmentsFromTranscript=function(msg){var msgObj;if(!isArticleAttachmentMsg(msg.Body,msg.Attachment.Name)){if(msg.Attachment.SenderType==="Customer"){var fileName=msg.Attachment.Name;var fileInternalName=msg.Attachment.AttachmentInternalName;var uniqueFileId=fileInternalName.substr(0,fileInternalName.indexOf(fileName)-1);var size=msg.Attachment.AttachmentSize;if(msg.Attachment.Status==="pending"){var file={};file.Id=uniqueFileId;file.Name=fileName;file.AttachmentSize=size;msgObj=new message($translate("APP.EG_CANCELLED"),"Customer",msg.Attachment.SenderName,MessageFactory.GetFormattedTime(new Date(msg.Timestamp)),"",file,"components/transcript/icon_reject.gif","")}if(msg.Attachment.Status==="accepted"){var file={};file.Id=uniqueFileId;file.Name=fileName;file.AttachmentSize=size;msgObj=new message($translate("APP.EG_SENT"),"Customer",msg.Attachment.SenderName,MessageFactory.GetFormattedTime(new Date(msg.Timestamp)),"",file,"components/transcript/icon_attachment_32.gif","");AttachmentFactory.GetAttachment(msg.Attachment.Id,uniqueFileId);$scope.scrollToBottom=true}if(msg.Attachment.Status==="rejected"){var file={};file.Id=uniqueFileId;file.Name=fileName;file.AttachmentSize=size;msgObj=new message($translate("APP.EG_REJECTED"),"Customer",msg.Attachment.SenderName,MessageFactory.GetFormattedTime(new Date(msg.Timestamp)),"",file,"components/transcript/icon_reject.gif","")}}else{if(msg.Attachment.Status==="accepted"){var msgObj=new message($translate("APP.EG_RECIEVED"),"System",msg.Attachment.SenderName,MessageFactory.GetFormattedTime(new Date(msg.Timestamp)),"",msg.Attachment,"components/transcript/icon_attachment_32.gif","",false);AttachmentFactory.GetAttachment(msg.Attachment.Id)}if(msg.Attachment.Status==="rejected"){msgObj=new message($translate("APP.EG_REJECTED"),"System",msg.Attachment.SenderName,MessageFactory.GetFormattedTime(new Date(msg.Timestamp)),"",msg.Attachment,"components/transcript/icon_reject.gif","",false)}if(msg.Attachment.Status==="pending"){msgObj=new message($translate("APP.EG_PENDING"),"System",msg.Attachment.SenderName,MessageFactory.GetFormattedTime(new Date(msg.Timestamp)),"",msg.Attachment,"components/transcript/icon_upload_32.gif","",true)}}}else{var attachmentLink="<a id='eg-attachment-link' eg-attachment-id='"+msg.Attachment.Id+"'>"+msg.Attachment.Name+"</a>";msg.Body=ApplicationFactory.GetFormattedMessage($rootScope.messagingProperty.attachment_msg,[attachmentLink]);msgObj=new message(msg.Body,"System","",MessageFactory.GetFormattedTime(new Date(msg.Timestamp)))}return msgObj};var escalateToChat=function(){var entryPoint=ApplicationFactory.GetEntryPointId();$scope.$on("application_service_chat_initialized_success_event",function(evt,response){if(response.isOneTagOff){proceedToEscalatedChat(response)}else if(response.oneTagAId&&response.oneTagServerDomainName){proceedToEscalatedChat(response)}else{$state.go("chat.error",{errorCode:"ONETAG_FAILURE"})}});ApplicationFactory.Chat(entryPoint)};var proceedToEscalatedChat=function(response){var available=response.checkEligibility.responseType;var showPreChat=VAFactory.GetShowPreChatOnEscalation();if(available===0){$state.go("chat.pre-chat",{VAEscalated:true,VAShowPreChat:showPreChat})}else if(available===1){$state.go("chat.chat-unavailable",{VAEscalated:true,VAShowPreChat:showPreChat})}else if(available===2){$state.go("chat.chat-unavailable",{VAEscalated:true,VAShowPreChat:showPreChat})}};var isAttachmentSendingCancelled=function(fileId){var statusCancelled=false;angular.forEach($scope.transcript.Messages,function(msg,key){if(msg.Attachment&&angular.equals(fileId,msg.Attachment.Id)){statusCancelled=msg.Body==$translate("APP.EG_CANCELLED")}});return statusCancelled};if(ApplicationFactory.IsDocked()){$window.onbeforeunload=function(){var pendingAttachmentCount=TranscriptFactory.GetPendingAttachmentCount();if(pendingAttachmentCount>0)return""};$scope.$on("$destroy",function(){$window.onbeforeunload=null})}function sendQuickpickData(){var quickPickData=GHFactory.GetQuickPick();if(quickPickData!==null){var subCommandObj={QuickPick:quickPickData};ApplicationFactory.Translate("APP.EG_QUICKPICK_MSG").then(function(response){quickPickMsg=response;var subCommand="quickpickdata"+"$$"+JSON.stringify(subCommandObj);var systemMsg=quickPickMsg?quickPickMsg:"";MessageFactory.SendSystemMessage(systemMsg,subCommand,true)})}}$scope.download=function(Link){if(MobileInterface){MobileInterface.DownloadAttachment(Link);return}var reader=new FileReader;reader.onload=function(e){$scope.openTab(reader.result)};reader.readAsDataURL(Link)};$scope.downloadAttachment=function(item){if(item.AttachmentLink){if(navigator.msSaveOrOpenBlob){return navigator.msSaveOrOpenBlob(new Blob([item.AttachmentBlob]),item.Attachment.Name)}var link=document.createElement("a");link.setAttribute("href",window.URL.createObjectURL(new Blob([item.AttachmentBlob])));link.setAttribute("download",item.Attachment.Name);document.body.appendChild(link);link.click();setTimeout(function(){document.body.removeChild(link);window.URL.revokeObjectURL(item.AttachmentLink)},100);var el=document.getElementById(item.Attachment.Id);angular.element(el).children()[0].tabIndex=0;angular.element(el).children()[0].focus()}};$scope.openTab=function(url){var a=window.document.createElement("a");a.target="_blank";a.href=url;var e=window.document.createEvent("MouseEvents");e.initMouseEvent("click",true,true,window,0,0,0,0,0,false,false,false,false,0,null);a.dispatchEvent(e)}}]);app.controller("VideoController",["$scope","$timeout","$stateParams","ApplicationFactory","VideoFactory",function($scope,$timeout,$stateParams,ApplicationFactory,VideoFactory){$scope.openTokAngular={show:false,videoToken:null,avChatFrameMaximised:false};$scope.cleanupAVAfterEnded=function(){$scope.openTokAngular.videoToken=null;$scope.openTokAngular.show=false;$scope.page.isAVChatInProgress=false;$scope.openTokAngular.avChatFrameMaximised=false};$scope.showAVAfterStart=function(){$scope.openTokAngular.show=true;$scope.page.isAVChatInProgress=true;$scope.openTokAngular.avChatFrameMaximised=false};$scope.toggleAVChatMaximise=function(maximised){$scope.openTokAngular.avChatFrameMaximised="boolean"===typeof maximised?maximised:!$scope.openTokAngular.avChatFrameMaximised};var startAVChat=function(data){if(data&&!angular.equals(data,$scope.openTokAngular.videoToken)){$scope.openTokAngular.videoToken=data;$scope.showAVAfterStart();VideoFactory.AddAVChatIframe("flash-wrap-id");VideoFactory.InitializeVideo();$timeout(function(){$scope.page.scrollToBottom()},700)}};$scope.$on("application_service_video_chat_token_received",function(evt,data){$scope.$apply(function(){startAVChat(data)})});$scope.$on("application_service_avchat_ended",function(evt,ended){if(true===ended){$timeout(function(){$scope.cleanupAVAfterEnded()})}});$scope.$on("application_service_avchat_maximised",function(evt,maximised){$timeout(function(){$scope.toggleAVChatMaximise(maximised)})});ApplicationFactory.onceTranscriptLoaded().then(function(){VideoFactory.UpdateAVChatInvitation();if(VideoFactory.IsWindowReadyForAVChat()){var videoToken=VideoFactory.GetVideoToken();if(videoToken){startAVChat(videoToken)}}})}]);app.controller("WaitScreenController",[function(){}]);app.controller("ChatDeflectionPageController",["$scope","$state","$stateParams","$window","ChatService","ConfigFactory","ConnectionFactory","ApplicationFactory",function($scope,$state,$stateParams,$window,ChatService,ConfigFactory,ConnectionFactory,ApplicationFactory){$scope.deflection={articles:null,sessionId:null,showSendEscalationMessage:false,wait:false};var oneTagCustomerInfo=$stateParams.oneTagCustomerInfo;$scope.$watch(function(){return $state.current.name},function(newValue,oldValue){if(angular.equals("chat.deflection.article",newValue)){$scope.isArticleContentPage=true}else{$scope.isArticleContentPage=false}});$scope.avertEscalation=function(){var oneTagEventInfo={EventName:"ChatKBDeflected"};eGainOneTagUtil.pushChatEvent("uac",oneTagEventInfo);$scope.submitted=true;ChatService.AvertEscalation(ConfigFactory.GetChatConfigurations().DeflectionPortalId,ApplicationFactory.GetUrlParameter("entryPointId"),$scope.deflection.sessionId).then(function(response){if(response.isErrorPresent){console.log("AvertEscalation error occurred")}else{$scope.deflection.showSendEscalationMessage=false}if(true===ApplicationFactory.IsDocked()||true===ApplicationFactory.isPoppedOut()){var p=ApplicationFactory.CreatePayload("NOTIFY","","CHAT_CLOSED","EGLV_DOCK_CALLER_APP");ApplicationFactory.PostMessageToParent(p,"*");ApplicationFactory.ResetChat()}else{$window.close()}})};$scope.startChat=function(){var oneTagEventInfo={EventName:"ChatKBNotDeflected"};eGainOneTagUtil.pushChatEvent("uac",oneTagEventInfo);$scope.submitted=true;if(angular.isDefined($scope.deflection.sessionId)){ApplicationFactory.SetXEgainSessionIDInChatLibrary($scope.deflection.sessionId)}ConnectionFactory.StartChat(oneTagCustomerInfo)};$scope.$on("application_service_chat_connect_success_event",function(evt,data){$state.go("chat.interaction")})}]);app.controller("ChatLandingPageController",["$scope","$state","ApplicationFactory",function($scope,$state,ApplicationFactory){var customLaunchButtonClicked="true"===ApplicationFactory.GetUrlParameter("chatLaunched")?true:false;var launchButtonSkipped=ApplicationFactory.IsDocked()===false||customLaunchButtonClicked;$scope.showLaunchButton=!launchButtonSkipped;$scope.page={};if(launchButtonSkipped){$state.go("initialize")}}]);app.controller("ChatMainPageController",["$scope","$window","$stateParams","ngProgressFactory","ChatHeaderFactory","ApplicationFactory","VAFactory","ConnectionFactory","SessionFactory","GHFactory",function($scope,$window,$stateParams,ngProgressFactory,ChatHeaderFactory,ApplicationFactory,VAFactory,ConnectionFactory,SessionFactory,GHFactory){$scope.page={ready:false,hide:false,visible:false,backButtonEnabled:false};$scope.page.progressbar=ngProgressFactory.createInstance();$scope.page.progressbar.setAbsolute();ChatHeaderFactory.SetChatHeaderImage("");$scope.$on("$stateChangeStart",function(){$scope.page.ready=false;$scope.page.hide=false;$scope.page.backButtonEnabled=false});$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){if(!angular.equals(toState,"chat.wait-screen")){if(VAFactory.IsVAActive()){var launchImage=ApplicationFactory.GetUrlParameter("vaLastAvatar");if(launchImage===null||launchImage===""){imageUrl=VAFactory.GetLaunchImage()}ChatHeaderFactory.SetChatHeaderImage(launchImage)}else{ChatHeaderFactory.SetChatHeaderImage("components/header-small/icon_agent.png")}}});$scope.$watch(function(){return GHFactory.GetGHActive()},function(newValue,oldValue){if(newValue===true){$scope.ghActive=true}else if(newValue===false){$scope.ghActive=false}else{$scope.ghActive=null}});var confirmMessage="";ApplicationFactory.Translate("APP.EG_CONFIRM_CLOSE_CHAT").then(function(confirmMsg){confirmMessage=confirmMsg});var addWindowEventHandlersForUndocked=function(){$window.addEventListener("unload",function(){var isInProgressFlagInSession=$window.sessionStorage.getItem("isUnDockedChatInProgress")==="true";var isInProgressFlagInLocal=$window.localStorage.getItem("isUnDockedChatInProgress")==="true";if(isInProgressFlagInSession&&isInProgressFlagInLocal){$window.localStorage.setItem("isUnDockedChatInProgress",false)}if(ApplicationFactory.IsVisitorIOSPhone()||ApplicationFactory.IsVisitorIOSTablet()){}else{ConnectionFactory.EndChat()}});$scope.$on("application_service_chat_connect_success_event",function(evt,data){$window.onbeforeunload=function(){if(ApplicationFactory.GetMailLinkClicked()===true){return}else{return confirmMessage}}});if($stateParams.attachedChat){$window.onbeforeunload=function(){return confirmMessage}}$scope.$on("application_service_chat_connection_completion_event",function(){$window.onbeforeunload=null});$scope.$on("application_service_chat_connection_failure_event",function(){$window.onbeforeunload=null})};var addWindowEventHandlersForPopout=function(){$window.onunload=function(){SessionFactory.ClearSessionState();ConnectionFactory.EndChat();ApplicationFactory.PersistToParentStorage("egPopoutWindow","false","session")};if($stateParams.attachedChat){ApplicationFactory.PersistToStorage("egSessionId",SessionFactory.GetSessionState().sessionID,"session");$window.onbeforeunload=function(){return confirmMessage}}$scope.$on("application_service_chat_connect_success_event",function(evt,data){ApplicationFactory.PersistToStorage("egSessionId",data.SessionID,"session");$window.onbeforeunload=function(){return confirmMessage}});$scope.$on("application_service_chat_connection_completion_event",function(){$window.onbeforeunload=null});$scope.$on("application_service_chat_connection_failure_event",function(){$window.onbeforeunload=null})};if(ApplicationFactory.IsUndocked()){addWindowEventHandlersForUndocked()}if(true===ApplicationFactory.isPoppedOut()){addWindowEventHandlersForPopout()}}]);app.controller("ChatUnavailablePageController",["$scope","$stateParams","$timeout","ConfigFactory","ChatHeaderFactory",function($scope,$stateParams,$timeout,ConfigFactory,ChatHeaderFactory){if($stateParams.condition!==null&&angular.equals("MAX_QUEUE_DEPTH_EXCEEDED",$stateParams.condition)){$scope.showCallbackOptions=true}else{$timeout(function(){eGainOneTagUtil.pushChatEvent("aac",{EventName:"ChatOutOfHours"})},100);$scope.showCallbackOptions=ConfigFactory.GetChatConfigurations().ShowCallBackPageDuringOffHours}}]);app.controller("ErrorPageController",[function(){}]);app.controller("InteractionPageController",["$scope","$rootScope","$uibModal","$filter","ApplicationFactory","ConnectionFactory","AttachmentFactory","SessionFactory",function($scope,$rootScope,$uibModal,$filter,ApplicationFactory,ConnectionFactory,AttachmentFactory,SessionFactory){$scope.dropText="";$scope.droppedAttachmentQueue=[];$scope.isChatAttachmentEnabled=false;var $translate=$filter("translate");$scope.review_attachment_msg=$translate("APP.EG_REVIEW_ATTACHMENT");$scope.drop_not_allowed_msg=$translate("APP.EG_ATTACHMENT_NOT_ALLOWED_MSG");$scope.off_record_msg=$translate("APP.EG_OFF_RECORD_ATTACHMENT_DISABLED_MSG");$scope.add_attachments=$translate("APP.EG_ATTACHMENT_HEADER");$scope.select_files=$translate("APP.EG_SELECT_FILES");$scope.send=$translate("APP.EG_SEND");$scope.cancel=$translate("APP.EG_ATTACHMENT_CANCEL");$scope.browse=$translate("APP.EG_BROWSE");$scope.offRecordFlag=SessionFactory.GetSessionState().OffRecordBtnState?SessionFactory.GetSessionState().OffRecordBtnState:false;$scope.interactionPage={wait:false};$scope.attachmentCnt={valid:0,invalid:0};ConnectionFactory.GetChatInitializationData().then(function(chatInitializationData){if(SessionFactory.GetChatTransferredFlag()){$scope.isChatAttachmentEnabled=SessionFactory.GetChatAttachmentEnabledFlag()}else{$scope.isChatAttachmentEnabled=chatInitializationData.isChatAttachmentEnabled}});$scope.$on("application_service_validated_dropped_attachments",function(evt,tempAttachments){$scope.droppedAttachmentQueue=tempAttachments.attachmentQueue;$scope.attachmentCnt.valid=tempAttachments.validCount;sendFiles()});$scope.$on("application_service_chat_transfer_event",function(event,data){$scope.isChatAttachmentEnabled=data.ChatAttachmentEnabled});var sendFiles=function(){var validFiles=[];var invalidFiles=[];angular.forEach($scope.droppedAttachmentQueue,function(file){if(!file.invalidFile){validFiles.push(file)}else{invalidFiles.push(file)}});if(invalidFiles.length>0||!$scope.isChatAttachmentEnabled||$scope.offRecordFlag){openAttachmentDialog(validFiles,invalidFiles)}else AttachmentFactory.SendCustomerAttachmentNotification(validFiles)};var openAttachmentDialog=function(validFiles,invalidFiles){var attachmentOptions={animation:true,templateUrl:"components/attachment-review/attachment-review.html",size:"md",controller:"AttachmentReviewController",appendTo:angular.element(document.getElementsByClassName("egain-chat-content")),scope:$scope,resolve:{droppedAttachmentQueue:function(){return $scope.droppedAttachmentQueue}}};if(ApplicationFactory.IsVisitorIOSPhone()){delete attachmentOptions.appendTo}$uibModal.open(attachmentOptions)};$rootScope.$on("application_service_attachment_link_enable_disable",function(evt,data){$scope.offRecordFlag=data})}]);app.controller("PostChatPageController",["$scope","ConfigFactory",function($scope,ConfigFactory){$scope.showSurveyPage=ConfigFactory.GetChatConfigurations().SurveyPageOn;$scope.survey={submitted:false}}]);app.controller("PreChatPageController",["$scope","$stateParams","ApplicationFactory","ConfigFactory","ChatHeaderFactory",function($scope,$stateParams,ApplicationFactory,ConfigFactory,ChatHeaderFactory){$scope.preChatForm={submitted:false,show:false,wait:false};$scope.settings={}}]);app.controller("ThanksPageController",[function(){}]);app.controller("VALandingPageController",["$scope","$state","VAFactory","ApplicationFactory",function($scope,$state,VAFactory,ApplicationFactory){var customLaunchButtonClicked="true"===ApplicationFactory.GetUrlParameter("chatLaunched")?true:false;$scope.showLaunchButton=!customLaunchButtonClicked;if(!$scope.showLaunchButton){VAFactory.SetVAActive(true);$state.go("chat.interaction")}}]);app.controller("WaitScreenPageController",[function(){}]);