app.factory("ApplicationFactory",["$q","$injector","$window","$rootScope","$translate","ConfigFactory",function($q,$injector,$window,$rootScope,$translate,ConfigFactory){var factory={};var egainChatLibrary;var egainChat;var applicationCallbacks;var VAFactory=null;var agentName="";factory.transcriptLoadedDeferred=$q.defer();factory["X-egain-session"]=null;factory.initializeChat=function(){$rootScope.$broadcast("application_service_start_chat_initialize",true)};factory.InitializeApplicationState=function(){initializeEgainChatLibrary();var isVAEnabled=factory.GetUrlParameter("VAEnabled")==="true"?true:false;if(VAFactory===null){VAFactory=$injector.get("VAFactory");if(isVAEnabled)VAFactory.initializeVALibrary()}var providerid=factory.GetUrlParameter("providerId");if(providerid!==null){egainChatLibrary.AddConnectionParameter("providerId",providerid)}addOffersParametersToUrl();eGainOneTagUtil.cleanIFrameUrl();$translate.use(factory.GetCaseSensitiveLocale(factory.GetUrlParameter("locale")))};factory.ValidateApplicationState=function(){return ConfigFactory.GetApplicationConfigurations().then(function(applicationConfig){if(angular.isDefined(applicationConfig))var userAgent=navigator.userAgent;var browserArray=applicationConfig.SUPPORTED_BROWSERS;var isBrowserValid=false;for(var i=0;i<browserArray.length;i++){if(userAgent.indexOf(browserArray[i])>-1){isBrowserValid=true}}if(!isBrowserValid){return false}else{console.log("App Service: validateAppState: resolving promise to True");return true}})};factory.CheckMobile=function(){var check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true})(navigator.userAgent||navigator.vendor||window.opera);return check};factory.IsVisitorAndroid=function(){var ua=navigator.userAgent;return ua.match(/Android/)};factory.IsVisitorIOSPhone=function(){var ua=navigator.userAgent;return ua.match(/(iPhone|iPod)/)};factory.IsVisitorIOSTablet=function(){var ua=navigator.userAgent;return ua.match(/iPad/)};factory.GetEgainChat=function(){return egainChat};factory.GetEgainChatLibrary=function(){return egainChatLibrary};factory.GetEgainChatCallbacks=function(){return applicationCallbacks};factory.SetEgainChatCallbacks=function(callbacks){applicationCallbacks=callbacks};factory.GetEgainChatParameter=function(){var chatParameter=new egainChatLibrary.Datatype.CustomerParameter;return chatParameter};factory.GetParameterFromUrlOrStorage=function(name,storageType){var retVal=factory.GetUrlParameter(name);if(null===retVal&&true===factory.IsUndocked()){retVal=factory.RetrieveFromStorage(name,storageType);retVal=null!==retVal?""+retVal:null}return retVal};factory.GetUrlParameter=function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var results=new RegExp("[\\?&]"+name+"=([^&#]*)").exec($window.location.href);return results?results[1]:null};factory.GetCaseSensitiveLocale=function(locale){var localeRegex=/^([a-z]{2})-([a-z]{2})$/i;if(localeRegex.test(locale)){locale=locale.replace(localeRegex,function(match,language,country,offset,str){return language.toLowerCase()+"-"+country.toUpperCase()})}else{locale=applicationDefaults.eGainChatDefaultLocale}return locale};factory.GetTimeZoneOffset=function(){var d=new Date;var offset=-1*d.getTimezoneOffset();var sign;if(offset>0){sign="%2B"}else{sign="-"}offset=Math.abs(offset);var minutes=offset%60;if(minutes/10<1){minutes="0"+minutes}var tzone=sign+Math.floor(offset/60)+minutes;return tzone};factory.GetEntryPointId=function(){return factory.GetUrlParameter("entryPointId")};factory.ResetChat=function(){var p=factory.CreatePayload("RESET_CHAT","","","EGLV_DOCK_CALLER_RESET");factory.PostMessageToParent(p)};factory.MaskMessage=function(message){return egainChatLibrary.Masker.MaskData(message)};factory.GetFormattedMessage=function(message,args){if(message&&args&&args.length){var replaceToken=null;for(var i=0;i<args.length&&typeof args[i]!="undefined"&&args[i]!=null;i++){replaceToken="{"+i+"}";if(message.indexOf(replaceToken)!=-1){message=message.replace(replaceToken,args[i])}}}return message};factory.GetAgentName=function(){return agentName};factory.SetAgentName=function(agent){agentName=agent};factory.Translate=function(str,values){if(values){return $translate(str,values).then(function(result){return result},function(translationId){return translationId})}else{return $translate(str).then(function(result){return result},function(translationId){return translationId})}};var Payload=function(method,key,value,caller,storageType){this.Method=method;this.Key=key;this.Value=value;this.Caller=caller;this.StorageType=storageType};factory.PostMessageToParent=function(message){if(isDocked){$window.parent.postMessage(JSON.stringify(message),"*")}else if(isPoppedOut){switch(factory.popoutOpenedBy){case"egainiframe":{if($window.opener&&!$window.opener.closed&&$window.opener.parent&&$window.opener.parent.postMessage){$window.opener.parent.postMessage(JSON.stringify(message),"*")}break}case"customerpage":default:{if($window.opener&&!$window.opener.closed&&$window.opener.postMessage){$window.opener.postMessage(JSON.stringify(message),"*")}break}}}};factory.CreatePayload=function(method,key,value,caller,storageType){return new Payload(method,key,value,caller,storageType)};factory.Chat=function(entryPoint){var templateName=factory.GetUrlParameter("templateName");var version=factory.GetUrlParameter("ver");var locale=factory.GetUrlParameter("locale");var video="1"===factory.GetUrlParameter("video");var avmode=factory.GetUrlParameter("avmode");avmode=avmode?parseInt(avmode):null;var language=factory.GetCaseSensitiveLocale(locale).split("-")[0]?factory.GetCaseSensitiveLocale(locale).split("-")[0]:"en";var country=factory.GetCaseSensitiveLocale(locale).split("-")[1]?factory.GetCaseSensitiveLocale(locale).split("-")[1]:"US";var chatServer=null;if(VAFactory.IsVAEscalated()){if(VAFactory.GetVAChatServerURL()!="")chatServer=VAFactory.GetVAChatServerURL();var vaEntryPointId=VAFactory.GetVAEntryPointId();if(vaEntryPointId!=null&&vaEntryPointId!="")entryPoint=vaEntryPointId}egainChat.Initialize(entryPoint,language,country,applicationCallbacks,templateName,version,chatServer,video,avmode)};factory.PersistToParentStorage=function(key,value,storageType){if(false===factory.IsUndocked()){var payLoad;if(angular.equals("session",storageType)){payLoad=factory.CreatePayload("SET",key,value,"EGLV_DOCK_CALLER_SET","session")}else{payLoad=factory.CreatePayload("SET",key,value,"EGLV_DOCK_CALLER_SET")}factory.PostMessageToParent(payLoad)}else{if("object"===typeof value){factory.PersistToStorageKeyValuePairs(value,storageType)}else{factory.PersistToStorage(key,value,storageType)}}};factory.PersistToStorageKeyValuePairs=function(keyValuePairs,storageType){if(keyValuePairs&&"object"===typeof keyValuePairs){var keys=Object.keys(keyValuePairs);keys.forEach(function(key){factory.PersistToStorage(key,keyValuePairs[key],storageType)})}};factory.PersistToStorage=function(key,value,storageType){if(key){var storage="session"===storageType?"sessionStorage":"localStorage";try{var tempData=typeof value!=="string"?JSON.stringify(value):value;$window[storage].setItem(key,tempData)}catch(e){}}};factory.RetrieveFromStorage=function(key,storageType){var retVal=null;if(key){var storage="session"===storageType?"sessionStorage":"localStorage";var _getItem=function(ke){var val=null;try{val=$window[storage].getItem(ke)}catch(e){val=null}return val};if(Array.isArray(key)){retVal={};key.forEach(function(k){if(k){retVal[k]=_getItem(k)}})}else{retVal=_getItem(key)}}return retVal};factory.RemoveFromStorage=function(key,storageType){if(key){var storage="session"===storageType?"sessionStorage":"localStorage";if(Array.isArray(key)){key.forEach(function(k){if(k){$window[storage].removeItem(k)}})}else{$window[storage].removeItem(key)}}};var responsesQ={};var timerQ={};factory.RetrieveFromParentStorage=function(key,callback,storageType){var domainRegex=new RegExp(ChatConfigurations.domain);try{var payLoad;responsesQ[key]=false;var _messageListener=function(event,data){if(!domainRegex.test(event.origin)){return}else{var parentData=JSON.parse(event.data);if(angular.equals("EGLV_DOCK_CALLER_GET",parentData.caller)){responsesQ[key]=true;clearTimeout(timerQ[key]);callback(parentData.value)}}$window.removeEventListener("message",_messageListener)};$window.addEventListener("message",_messageListener);if(angular.equals("session",storageType)){payLoad=factory.CreatePayload("GET",key,null,"EGLV_DOCK_CALLER_GET","session")}else{payLoad=factory.CreatePayload("GET",key,null,"EGLV_DOCK_CALLER_GET")}if(isDocked){$window.parent.postMessage(JSON.stringify(payLoad),"*")}else{switch(factory.popoutOpenedBy){case"egainiframe":{if($window.opener&&!$window.opener.closed&&$window.opener.parent&&$window.opener.parent.postMessage){$window.opener.parent.postMessage(JSON.stringify(payLoad),"*")}break}case"customerpage":default:{if($window.opener&&!$window.opener.closed&&$window.opener.postMessage){$window.opener.postMessage(JSON.stringify(payLoad),"*")}break}}}timerQ[key]=setTimeout(function(){if(!responsesQ[key]){callback(null);$window.removeEventListener("message",_messageListener)}},5e3)}catch(e){callback(null)}};factory.RemoveFromParentStorage=function(dataToremove,storageType){if(false===factory.IsUndocked()){var payLoad;if(angular.equals("session",storageType)){payLoad=factory.CreatePayload("REMOVE",dataToremove,null,"EGLV_DOCK_CALLER_REMOVE","session")}else{payLoad=factory.CreatePayload("REMOVE",dataToremove,null,"EGLV_DOCK_CALLER_REMOVE")}factory.PostMessageToParent(payLoad)}else{factory.RemoveFromStorage(dataToremove,storageType)}};factory.NotifyParent=function(){};var mailLinkClicked=false;factory.SetMailLinkClicked=function(mailClicked){mailLinkClicked=mailClicked};factory.GetMailLinkClicked=function(){return mailLinkClicked};function initializeEgainChatLibrary(){$rootScope.eGainContextPath=applicationDefaults.eGainContextPath;var librarySettings=new eGainLibrarySettings;librarySettings.CORSHost=applicationDefaults.eGainChatApiPath;librarySettings.IsDevelopmentModeOn=applicationDefaults.IsDevelopmentModeOn?applicationDefaults.IsDevelopmentModeOn:false;librarySettings.eGainContextPath=applicationDefaults.eGainContextPath?applicationDefaults.eGainContextPath:"";librarySettings.ChatPauseInSec=ConfigFactory.GetChatConfigurations().ChatPauseInSec?ConfigFactory.GetChatConfigurations().ChatPauseInSec:"30";librarySettings.IsDebugOn=factory.GetUrlParameter("debug")?factory.GetUrlParameter("debug")==="true":false;librarySettings.RetryCount=applicationDefaults.retryCount?applicationDefaults.retryCount:7;librarySettings.RetryIntervalInSec=applicationDefaults.retryIntervalInSec?applicationDefaults.retryIntervalInSec:5;egainChatLibrary=new eGainLibrary(librarySettings);egainChat=new egainChatLibrary.Chat;applicationCallbacks=egainChat.GetEventHandlers()}factory.GetCookie=function(name){var cookieVal=null;if(name&&"string"===typeof name){var allCookiesString=document.cookie;var cookiesString="; "+allCookiesString;var parts=cookiesString.split("; "+name+"=");parts.shift();if(1<=parts.length){cookieVal=parts.shift().split(";").shift()}}return cookieVal};function addOffersParametersToUrl(){var ofrsessionid=factory.GetUrlParameter("offercorrelationid");if(ofrsessionid!==null){egainChatLibrary.AddConnectionParameter("offercorrelationid",ofrsessionid)}var interactionid=factory.GetUrlParameter("interactionid");if(interactionid!==null){egainChatLibrary.AddConnectionParameter("interactionid",interactionid)}var aId=factory.GetUrlParameter("aId");if(aId!==null){egainChatLibrary.AddConnectionParameter("aId",aId)}var sId=factory.GetUrlParameter("sId");if(sId!==null){egainChatLibrary.AddConnectionParameter("sId",sId)}var uId=factory.GetUrlParameter("uId");if(uId!==null){egainChatLibrary.AddConnectionParameter("uId",uId)}var eglvrefname=factory.GetUrlParameter("eglvrefname");if(eglvrefname!==null){egainChatLibrary.AddConnectionParameter("eglvrefname",eglvrefname)}var eglvPriorityChat=factory.GetUrlParameter("eglvPriorityChat");if(eglvPriorityChat!==null){egainChatLibrary.AddConnectionParameter("eglvPriorityChat",eglvPriorityChat)}var referer=factory.GetUrlParameter("referer");if(referer!==null){egainChatLibrary.AddConnectionParameter("referer",referer)}var eglvcaseid=factory.GetUrlParameter("eglvcaseid");if(eglvcaseid!==null){egainChatLibrary.AddConnectionParameter("eglvcaseid",eglvcaseid)}var clientKey=factory.GetUrlParameter("clientKey");if(clientKey!==null){egainChatLibrary.AddConnectionParameter("clientKey",clientKey)}}var isDocked=factory.GetUrlParameter("docked")==="true"?true:false;var isPoppedOut=factory.GetUrlParameter("popout")==="true"?true:false;var isUndocked=false===isDocked&&false===isPoppedOut;factory.popoutOpenedBy=factory.GetUrlParameter("popoutOpenedBy");factory.isPoppedOut=function(){return isPoppedOut};factory.IsDocked=function(){return isDocked};factory.IsUndocked=function(){return isUndocked};var popoutButtonClicked=false;factory.isPopoutButtonClicked=function(isClicked){if(angular.isDefined(isClicked)){popoutButtonClicked=isClicked}return popoutButtonClicked};factory.transcriptLoaded=function(){var resolved=false;if(factory.transcriptLoadedDeferred){factory.transcriptLoadedDeferred.resolve(true);resolved=true}return resolved};factory.onceTranscriptLoaded=function(){var promise=null;if(factory.transcriptLoadedDeferred){promise=factory.transcriptLoadedDeferred.promise}return promise};factory.isDescendent=function(parent,child){var node=child.parentNode;while(node&&node!==null){if(node.className&&(node.className.indexOf(parent)>=0||parent===child.className||child.className.indexOf(parent)>=0||node.id===parent)){return true}node=node.parentNode}return false};factory.htmlEncode=function(value){return angular.element("<div/>").text(value).html()};factory.htmlDecode=function(value){return angular.element("<div/>").html(value).text()};factory.addBaseURL=function(url,baseURL){var retURL=url;if(url&&baseURL&&"string"===typeof url&&"string"===typeof baseURL){var hasServerNameRegex=/^(http:|https:)?\/\//i;retURL=!hasServerNameRegex.test(url)?baseURL+url:retURL}return retURL};factory.SendMultiSubDomainSupportConfigToParent=function(){var chatConfig=ConfigFactory.GetChatConfigurations();if(chatConfig&&chatConfig.MultiSubDomainSupport){var p=factory.CreatePayload("SUB_DOMAIN_SUPPORT","MultiSubDomainSupportConfig",JSON.stringify(chatConfig.MultiSubDomainSupport),"EGLV_DOCK_CALLER_SUBDOMAIN");factory.PostMessageToParent(p)}};factory.SetXEgainSessionID=function(sessionId){factory["X-egain-session"]=sessionId};factory.GetXEgainSessionID=function(){return factory["X-egain-session"]};factory.SetXEgainSessionIDInChatLibrary=function(sessionId){egainChatLibrary.SetXEgainSession(sessionId)};factory.SetXEgainSessionIDOnInitialised=function(sessionId){factory.SetXEgainSessionID(sessionId);if(factory.IsUndocked()){factory.PersistToStorage("egXEgainSession",sessionId,"session")}else{factory.PersistToParentStorage("egXEgainSession",sessionId,"session")}};factory.GetXEgainSessionIDOnLoad=function(){var sessionId=null;if(factory.IsUndocked()){sessionId=factory.RetrieveFromStorage("egXEgainSession","session");factory.SetXEgainSessionID(sessionId);factory.SetXEgainSessionIDInChatLibrary(sessionId)}else{factory.RetrieveFromParentStorage("egXEgainSession",function(data){sessionId=data;factory.SetXEgainSessionID(sessionId);factory.SetXEgainSessionIDInChatLibrary(sessionId)},"session")}};return factory}]);app.factory("AttachmentFactory",["$filter","$rootScope","ApplicationFactory","ConnectionFactory","CustomerFactory","MessageFactory",function($filter,$rootScope,ApplicationFactory,ConnectionFactory,CustomerFactory,MessageFactory){var factory={};var egainChat=ApplicationFactory.GetEgainChat();var appCallbacks=ApplicationFactory.GetEgainChatCallbacks();var customerAttachmentQueue=[];var $translate=$filter("translate");appCallbacks.OnCustomerAttachmentNotificationSent=function(customerAttachmentNotificationSentEventArgs){$rootScope.$broadcast("application_service_attachment_notification_sent_event",customerAttachmentNotificationSentEventArgs)};appCallbacks.OnAttachmentAcceptedByAgent=function(attachmentAcceptedByAgentEventArgs){var fileToUpload;var agentName={};if(typeof customerAttachmentQueue!=="undefined"||customerAttachmentQueue!==null){angular.forEach(customerAttachmentQueue,function(file){if(angular.equals(attachmentAcceptedByAgentEventArgs.uniqueFileId,file.uniqueFileId)){fileToUpload=file;agentName=attachmentAcceptedByAgentEventArgs.agentName}})}if(typeof fileToUpload==="undefined"||fileToUpload===null){var msg=decodeURIComponent(JSON.parse('"'+$rootScope.messagingProperty.attachment_sending_cancelled+'"'));MessageFactory.SendSystemMessage(msg,"cancelattachment",true)}else{factory.UploadAttachment(fileToUpload,agentName)}};appCallbacks.OnAttachmentRejectedByAgent=function(attachmentRejectedByAgentEventArgs){$rootScope.$broadcast("application_service_attachment_rejected_by_agent_event",attachmentRejectedByAgentEventArgs)};appCallbacks.OnAttachmentUploadedByCustomer=function(attachmentUploadedByCustomerEventArgs){$rootScope.$broadcast("application_service_attachment_uploaded_by_customer_event",attachmentUploadedByCustomerEventArgs)};appCallbacks.OnAttachmentInviteReceived=function(attachmentInvitedAgentEventArgs){$rootScope.$broadcast("application_service_system_message_received_event",attachmentInvitedAgentEventArgs)};appCallbacks.OnAttachmentAcceptedByCustomer=function(attachmentAcceptedByCustomerEventArgs){$rootScope.$broadcast("application_service_attachment_accepted_notification_sent",attachmentAcceptedByCustomerEventArgs)};appCallbacks.OnAttachmentRejectedByCustomer=function(attachmentRejectedByCustomerEventArgs){$rootScope.$broadcast("application_service_attachment_rejected_notification_sent",attachmentRejectedByCustomerEventArgs)};appCallbacks.OnGetAttachment=function(getAgentAttachmentEventArgs){$rootScope.$broadcast("application_service_get_attachment_event",getAgentAttachmentEventArgs)};appCallbacks.OnGetAttachmentImageThumbnail=function(attachmentThumbnailArgs){$rootScope.$broadcast("application_service_get_attachment_image_thumbnail_event",attachmentThumbnailArgs)};factory.GetAttachment=function(filename,uniqueFileId){egainChat.GetAttachment(filename,uniqueFileId)};factory.GetArticleAttachment=function(filename){egainChat.GetArticleAttachment(filename)};factory.SendCustomerAttachmentNotification=function(files){egainChat.SendCustomerAttachmentNotification(files,CustomerFactory.GetCustomerScreenName())};factory.SendAcceptChatAttachmentNotification=function(fileId,filename){egainChat.SendAcceptChatAttachmentNotification(fileId,filename,CustomerFactory.GetCustomerScreenName())};factory.SendRejectChatAttachmentNotification=function(fileId,filename){egainChat.SendRejectChatAttachmentNotification(fileId,filename,CustomerFactory.GetCustomerScreenName())};factory.UploadAttachment=function(files,agentName){egainChat.UploadAttachment(files,agentName)};factory.GetImageThumbnail=function(fileId,uniqueFileId){egainChat.GetAttachmentImage(fileId,uniqueFileId)};factory.ValidateAttachmentFiles=function(files,isDropped,attachmentCount){ConnectionFactory.GetChatInitializationData().then(function(chatInitializationData){attachmentCount=isDropped===true?0:attachmentCount;var allowAllType;var tempAttachments={attachmentQueue:[],invalidCount:0,validCount:0};var tempAttachmentQueue=[];if(chatInitializationData&&chatInitializationData.listValue){allowAllType=chatInitializationData.listValue}else{allowAllType=true}for(var i=0;i<files.length;i++){var currentFile=files[i];currentFile.invalidFile=false;tempAttachments.validCount++;currentFile.maxNumberValidationFailed=false;if(files.length+attachmentCount>10){currentFile.invalidFile=true;tempAttachments.validCount--;tempAttachments.invalidCount++;currentFile.attachmentValidationError=$translate("APP.EG_MAXIMUM_ATTACHMENT_NUMBER_EXCEEDED");currentFile.maxNumberValidationFailed=true;tempAttachments.attachmentQueue.push(currentFile);break}var fileExtension="."+currentFile.name.split(".").pop();if(chatInitializationData.maxChatAttachmentSize<currentFile.size/(1024*1024)){currentFile.attachmentValidationError=$translate("APP.EG_ATTACHMENT_SIZE_FAIL_MESSAGE",{fileName:currentFile.name,maxAttachmentSize:chatInitializationData.maxChatAttachmentSize});currentFile.invalidFile=true;tempAttachments.validCount--;tempAttachments.invalidCount++}else if(allowAllType!==true){var isBlackListType=chatInitializationData.isBlackListType?chatInitializationData.isBlackListType:false;if(isBlackListType&&chatInitializationData.listValue.split(",").indexOf(fileExtension.toLowerCase())!==-1){currentFile.attachmentValidationError=$translate("APP.EG_FILE_BLACKLIST_MESSAGE",{fileName:currentFile.name});currentFile.invalidFile=true;tempAttachments.validCount--;tempAttachments.invalidCount++}else if(!isBlackListType&&chatInitializationData.listValue.split(",").indexOf(fileExtension.toLowerCase())===-1){currentFile.attachmentValidationError=$translate("APP.EG_FILE_NOT_IN_WHITE_LIST",{fileName:currentFile.name});currentFile.invalidFile=true;tempAttachments.validCount--;tempAttachments.invalidCount++}}currentFile.isDropped=isDropped;currentFile.isPending=true;tempAttachments.attachmentQueue.push(currentFile)}if(isDropped){$rootScope.$broadcast("application_service_validated_dropped_attachments",tempAttachments)}else{$rootScope.$broadcast("application_service_validated_selected_attachments",tempAttachments)}customerAttachmentQueue=customerAttachmentQueue.concat(tempAttachments.attachmentQueue)})};factory.GetAttachmentSizeUnit=function(bytes){if(bytes>=1048576){bytes=Math.floor(bytes*10/1048576)/10+" MB"}else if(bytes>=1024){bytes=Math.floor(bytes*10/1024)/10+" KB"}else if(bytes>1){bytes=bytes+" bytes"}else if(bytes===1){bytes=bytes+" byte"}else{bytes="0 byte"}return bytes};return factory}]);app.factory("ConfigFactory",["$http",function($http){var factory={};var chatConfig;var applicationConfig;chatConfig=ChatConfigurations;applicationConfig=$http.get(applicationDefaults.eGainContextPath+"application/application-config.json").then(function(configresponse){return configresponse.data.Settings});factory.GetChatConfigurations=function(){return chatConfig};factory.GetApplicationConfigurations=function(){return applicationConfig};return factory}]);app.factory("ConnectionFactory",["$timeout","$rootScope","$q","$window","$state","ApplicationFactory","ConfigFactory","SessionFactory","MessageFactory","TranscriptFactory","VAFactory","ChatService",function($timeout,$rootScope,$q,$window,$state,ApplicationFactory,ConfigFactory,SessionFactory,MessageFactory,TranscriptFactory,VAFactory,ChatService){var factory={};var connection={connected:false,sessionID:0};var egainChatLibrary=ApplicationFactory.GetEgainChatLibrary();var egainChat=ApplicationFactory.GetEgainChat();var appCallbacks=ApplicationFactory.GetEgainChatCallbacks();var entryPointId=ApplicationFactory.GetUrlParameter("entryPointId");var chatInitializationDataDeferred=$q.defer();var errorMessageAdded=false;var queueDepthRequired=false;var networkDisconnected=false;if("QUEUE_POSITION"===ConfigFactory.GetChatConfigurations().DisplayForChatWaitingSatus){queueDepthRequired=true}appCallbacks.OnConnectionInitialized=function(ChatInitializedEventArgs){var chatInitializationData=ChatInitializedEventArgs;if(chatInitializationData){chatInitializationDataDeferred.resolve(chatInitializationData)}if(chatInitializationData.XEgainSession){ApplicationFactory.SetXEgainSessionIDOnInitialised(chatInitializationData.XEgainSession)}egainChatLibrary.SetVisitorHistoryInformation(ApplicationFactory.GetUrlParameter("aId"),ApplicationFactory.GetUrlParameter("uId"),ApplicationFactory.GetUrlParameter("sId"));$rootScope.$broadcast("application_service_chat_initialized_success_event",ChatInitializedEventArgs)};appCallbacks.OnMessagePropertyLoad=function(ChatMessagePropertyLoadEventArgs){eGainOneTagUtil.parseMessages(ChatMessagePropertyLoadEventArgs);$rootScope.messagingProperty=parseMessages(ChatMessagePropertyLoadEventArgs);function parseMessages(messagingPropertyStr){var messagingPropertyObj={};if(messagingPropertyStr){var mesagingPropertyVariables=messagingPropertyStr.split("\n");for(i=0;i<mesagingPropertyVariables.length;i++){var keyValuePair=mesagingPropertyVariables[i].split("=");if(keyValuePair.constructor===Array&&keyValuePair.length>1){var key=keyValuePair[0].trim();var value=keyValuePair[1].trim();messagingPropertyObj[key]=value}}}return messagingPropertyObj}};appCallbacks.OnConnectSuccess=function(ChatConnectSuccessEventArgs){connection.connected=true;connection.sessionID=ChatConnectSuccessEventArgs.SessionID;ApplicationFactory.PersistToParentStorage("egSessionId",connection.sessionID);ApplicationFactory.PersistToParentStorage("egChatInProgress","true");ApplicationFactory.PersistToParentStorage("egChatInProgress","true","session");if(ApplicationFactory.IsUndocked()){ApplicationFactory.PersistToStorage("egSessionId",connection.sessionID);ApplicationFactory.PersistToStorage("isUnDockedChatInProgress",true);ApplicationFactory.PersistToStorage("isUnDockedChatInProgress",true,"session")}if(ApplicationFactory.IsDocked()){ApplicationFactory.PersistToParentStorage("egFetchFromStorage",true)}TranscriptFactory.GetTranscriptTemplate().then(function(response){TranscriptFactory.CheckTranscriptFileVersion(response)});if(MobileInterface){MobileInterface.SetSID(connection.sessionID)}$rootScope.$broadcast("application_service_chat_connect_success_event",ChatConnectSuccessEventArgs)};appCallbacks.OnConnectionComplete=function(){};appCallbacks.OnCustTerminateSuccess=function(){SessionFactory.ClearSessionState();if(ApplicationFactory.IsUndocked()){$window.sessionStorage.setItem("isUnDockedChatInProgress",false)}connection.connected=false;eGainOneTagUtil.pushChatEvent("aac",{EventName:"ChatSurveyEntry"});if(typeof integWrapUpFlag==="undefined"||!integWrapUpFlag){$rootScope.$broadcast("application_service_chat_connection_completion_event");$state.go("chat.post-chat")}};appCallbacks.OnConnectionFailure=function(ChatConnectFailureEventArgs){connection.connected=false;SessionFactory.ClearSessionState();if(angular.equals("REMOTE_CONNECTION_FAILURE",ChatConnectFailureEventArgs.StatusCode)){$state.go("chat.error",{errorCode:ChatConnectFailureEventArgs.StatusMessage})}else if(angular.equals("CONNECT_FAIL",ChatConnectFailureEventArgs.StatusCode)){$rootScope.$broadcast("application_service_chat_connection_failure_event",ChatConnectFailureEventArgs)}};appCallbacks.OnNetworkDisconnect=function(){networkDisconnected=true;$timeout(function(){if(networkDisconnected){$rootScope.$broadcast("application_service_network_disconnect_event")}})};appCallbacks.OnNetworkReconnect=function(){networkDisconnected=false;errorMessageAdded=false;$timeout(function(){$rootScope.$broadcast("application_service_network_reconnect_event")})};appCallbacks.OnTimeToReconnectExpired=function(){connection.connected=false;SessionFactory.ClearSessionState();$rootScope.$broadcast("application_service_extended_timeout_expired")};appCallbacks.OnAgentJoined=function(AgentJoinedEventArgs){if(AgentJoinedEventArgs.AgentName){ApplicationFactory.SetAgentName(AgentJoinedEventArgs.AgentName)}$rootScope.$broadcast("application_service_agent_joined_event",AgentJoinedEventArgs)};appCallbacks.OnDuplicateSession=function(DuplicateSessionEventArgs){connection.connected=false;ApplicationFactory.PersistToParentStorage("egDuplicateSession","true","session");$state.go("chat.error",{errorCode:DuplicateSessionEventArgs.StatusCode})};appCallbacks.OnErrorOccurred=function(OnErrorOccurredEventArgs){factory.ErrorHandler(OnErrorOccurredEventArgs);$rootScope.$broadcast("application_service_chat_error_occurred_event",OnErrorOccurredEventArgs)};appCallbacks.OnAgentsNotAvailable=function(agentsNotAvailableEventArgs){eGainOneTagUtil.pushChatEvent("aac",{EventName:"ChatOutOfHours"});$state.go("chat.chat-unavailable")};appCallbacks.OnConnectionAttached=function(){connection.connected=true;var sessionData=SessionFactory.GetSessionState();if(sessionData){factory.GetChatInitializationData().then(function(chatInitializationData){eGainOneTagUtil.disableTracker();eGainOneTagUtil.loadOneTag(chatInitializationData)});connection.sessionID=sessionData.sessionID;MessageFactory.SetBadgeCount(ApplicationFactory.GetUrlParameter("egBadgeCount"));TranscriptFactory.GetTranscriptTemplate();ApplicationFactory.PersistToStorage("egSessionId",connection.sessionID);ApplicationFactory.PersistToParentStorage("egChatInProgress","true");ApplicationFactory.PersistToParentStorage("egChatInProgress","true","session");$state.go("chat.interaction",{attachedChat:true})}$rootScope.$broadcast("application_service_chat_attach_success_event");if(ApplicationFactory.IsUndocked()){ApplicationFactory.PersistToStorage("isUnDockedChatInProgress",true);ApplicationFactory.PersistToStorage("isUnDockedChatInProgress",true,"session")}};appCallbacks.OnConnectionAttachedFailure=function(responseStatus){connection.connected=false;SessionFactory.ClearSessionState();ApplicationFactory.ResetChat();if(!ApplicationFactory.IsDocked()&&responseStatus==400){$state.go("launch-chat",{launchChat:true})}};appCallbacks.OnChatTransfer=function(transType){SessionFactory.SetChatTransferredFlag(true);ApplicationFactory.PersistToParentStorage("isChatAttachmentEnabled",transType.ChatAttachmentEnabled);$rootScope.$broadcast("application_service_chat_transfer_event",transType)};var queueStatusPromise=null;var chatAwaitingEvtDone="true"===ApplicationFactory.GetParameterFromUrlOrStorage("egAwaitingEvtDone","session")?true:false;eGainOneTagUtil.chatAwaitingAgentCaptured=chatAwaitingEvtDone;appCallbacks.OnGetQueueCurrentStatus=function(getQueueLiveStatusArgs){if(eGainOneTagUtil.pushChatAwaitingMsg(getQueueLiveStatusArgs.WaitTime)){ApplicationFactory.PersistToParentStorage("egAwaitingEvtDone","true","session")}if(queueStatusPromise){queueStatusPromise.resolve(getQueueLiveStatusArgs)}};appCallbacks.OnApplicationFailOverSuccess=function(){console.log("Application failover success event called..");$rootScope.$broadcast("application_failover_success_event",{});
};ApplicationFactory.SetEgainChatCallbacks(appCallbacks);factory.GetConnection=function(){return connection};factory.GetChatInitializationData=function(){return chatInitializationDataDeferred.promise};factory.StartChat=function(oneTagCustomerInfo){var oneTagEventInfo={};oneTagEventInfo["EventName"]="ChatRequested";eGainOneTagUtil.pushChatEvent("aev",oneTagEventInfo);egainChat.Start()};factory.EndChat=function(){egainChat.End()};factory.SetDuplicateChat=function(){connection.connected=false;ApplicationFactory.PersistToParentStorage("egDuplicateSession","true","session");$state.go("chat.error",{errorCode:"DUPLICATE_SESSION"})};var isChatPaused=false;factory.PauseChat=function(){if(angular.isDefined(egainChat)&&angular.isDefined(egainChat.Pause)&&!isChatPaused){isChatPaused=true;egainChat.Pause()}};factory.AttachToChat=function(){if(VAFactory.IsVAActive()){var vaSessionId=SessionFactory.GetVASessionId();if(vaSessionId){$state.go("chat.interaction",{attachedChat:true})}return}var sessionData=SessionFactory.GetSessionState();if(sessionData){var templateName=ApplicationFactory.GetUrlParameter("templateName");var version=ApplicationFactory.GetUrlParameter("ver");var locale=ApplicationFactory.GetUrlParameter("locale");var video="1"===ApplicationFactory.GetUrlParameter("video");var avmode=ApplicationFactory.GetUrlParameter("avmode");var language=ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[0]?ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[0]:"en";var country=ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[1]?ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[1]:"US";if(VAFactory.GetVAChatServerURL()!==""){egainChat.Initialize(VAFactory.GetVAEntryPointId(),language,country,appCallbacks,templateName,version,VAFactory.GetVAChatServerURL(),video,avmode);factory.GetChatInitializationData().then(function(){egainChat.Attach(sessionData.sessionID,parseInt(sessionData.lastRequestId))})}else{egainChat.Initialize(ApplicationFactory.GetUrlParameter("entryPointId"),language,country,appCallbacks,templateName,version,null,video,avmode);factory.GetChatInitializationData().then(function(){egainChat.Attach(sessionData.sessionID,parseInt(sessionData.lastRequestId))})}}};factory.ResumeChat=function(){if(angular.isDefined(egainChat)&&angular.isDefined(egainChat)&&isChatPaused){isChatPaused=false;egainChat.Resume()}};factory.GetQueueCurrentStatus=function(){queueStatusPromise=$q.defer();egainChatLibrary.GetQueueCurrentStatus(queueDepthRequired);return queueStatusPromise.promise};factory.IsNetworkConnectionActive=function(){return ChatService.IsAgentAvailable(entryPointId,ApplicationFactory.GetXEgainSessionID()).then(function(response){if(true===response.isErrorPresent&&"CHAT-107"===response.errorObject.errorCode){return false}return true})};var errorMessage="";ApplicationFactory.Translate("APP.EG_ERROR_CONNECTION").then(function(result){errorMessage=result});factory.ErrorHandler=function(error){if(ApplicationFactory.GetMailLinkClicked()===true){return}if(true===factory.GetConnection().connected&&error&&!errorMessageAdded&&"string"===typeof error.status){$timeout(function(){if(networkDisconnected){factory.ShowConnectionErrorMessage()}},5e3)}};factory.ShowConnectionErrorMessage=function(){if(!errorMessageAdded){errorMessageAdded=true;MessageFactory.AddSystemMessageToTranscript(errorMessage);$rootScope.$broadcast("application_service_chat_error_message_published")}};if(egainChatLibrary&&ApplicationFactory.GetUrlParameter("debug")==="true"){var loggerMessageCount=0;var logs=[];ApplicationFactory.GetEgainChatLibrary().logger=function(msg){if(msg){var msgObject={data:{index:loggerMessageCount,from:"logger",message:msg,type:"logger"}}}logs.push(msgObject);MessageFactory.SetTranscript(MessageFactory.GetTranscript().concat(logs));loggerMessageCount++}}return factory}]);app.factory("CustomerFactory",["$rootScope","ApplicationFactory",function($rootScope,ApplicationFactory){var factory={};var customer;var customerScreenName;ApplicationFactory.Translate("APP.EG_CUSTOMER").then(function(result){customerScreenName=result});var egainChatLibrary=ApplicationFactory.GetEgainChatLibrary();factory.CreateCustomer=function(){if(!customer)customer=new egainChatLibrary.Datatype.CustomerObject;return customer};factory.SetCustomer=function(customerObj){if(!customerObj){customer=new egainChatLibrary.Datatype.CustomerObject}else{customer=customerObj}var locale=ApplicationFactory.GetUrlParameter("locale");customer.Locale.Language=ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[0]?ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[0]:"en";customer.Locale.Country=ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[1]?ApplicationFactory.GetCaseSensitiveLocale(locale).split("-")[1]:"US";egainChatLibrary.SetCustomer(customer);$rootScope.customer=customer};factory.SetSamlResponse=function(samlResponse){if(samlResponse)egainChatLibrary.SetSamlResponse(samlResponse)};factory.SetEscalationData=function(escalationData){if(escalationData){egainChatLibrary.SetEscalationData(escalationData)}};factory.GetCustomer=function(){return customer};factory.GetCustomerScreenName=function(){return customerScreenName};factory.SetCustomerScreenName=function(customerName){customerScreenName=customerName};return factory}]);app.factory("GHFactory",["$window","$rootScope","$injector","$q","ChatService","ApplicationFactory",function($window,$rootScope,$injector,$q,ChatService,ApplicationFactory){var factory={};var ghUrl=null;var ghDomain=null;var ghActive=null;var ghSolutionAcknowledged=false;var ghQuickPick=null;var VAFactory=null;var GH_EVENT_TRACKER={queue:[],processQ:function(){if(VAFactory===null){VAFactory=$injector.get("VAFactory")}var event=GH_EVENT_TRACKER.queue.pop();if(event.EventName==="GH_SOLUTION_ACCEPTED"||event.EventName==="GH_SOLUTION_REJECTED"){ghSolutionAcknowledged=true}VAFactory.SendVaMessage(null,event.EventName)},push:function(evt){GH_EVENT_TRACKER.queue.push(evt);GH_EVENT_TRACKER.processQ()}};factory.OpenGHWindow=function(url,type,logEvent){if(url){if("gh"===type){url=addParameterToURL(url,"vaInitiated=true");url=addParameterToURL(url,"ghReload=true")}ghUrl=url;ghDomain=getDomain(ghUrl);$rootScope.$broadcast("gh_url_update",{GHUrl:ghUrl,Reload:true});ghActive=true;ghSolutionAcknowledged=false;if(typeof logEvent==="undefined"){logEvent=true}if(logEvent){factory.LogEvent({EventName:"SLIDEOUT_MAXIMIZED"})}ApplicationFactory.PersistToParentStorage("egGHUrl",url,"session");var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_GH_ACTIVE","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize);ApplicationFactory.PersistToParentStorage("egGHActive",true,"session")}};factory.CloseGHWindow=function(logEvent){ghActive=null;if(typeof logEvent==="undefined"){logEvent=true}if(logEvent){GH_EVENT_TRACKER.push({EventName:"SLIDEOUT_EXITED"})}if(!ghSolutionAcknowledged){if(logEvent){GH_EVENT_TRACKER.push({EventName:"GH_SESSION_ABORTED"});ghSolutionAcknowledged=false}}var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_GH_CLOSED","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize);ApplicationFactory.RemoveFromParentStorage("egGHUrl","session");ApplicationFactory.RemoveFromParentStorage("egGHActive","session");postMessageToGH("EGLV_GH_WINDOW_CLOSED")};factory.ExpandGHWindow=function(logEvent){ghActive=true;if(typeof logEvent==="undefined"){logEvent=true}if(logEvent){factory.LogEvent({EventName:"SLIDEOUT_MAXIMIZED"})}var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_GH_ACTIVE","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize);ApplicationFactory.PersistToParentStorage("egGHActive",true,"session")};factory.CollapseGHWindow=function(logEvent){ghActive=false;if(typeof logEvent==="undefined"){logEvent=true}if(true===logEvent){factory.LogEvent({EventName:"SLIDEOUT_MINIMIZED"})}var resize=ApplicationFactory.CreatePayload("RESIZE_WINDOW","EG_GH_COLLAPSED","","EGLV_DOCK_CALLER_SET");ApplicationFactory.PostMessageToParent(resize);ApplicationFactory.PersistToParentStorage("egGHActive",false,"session")};factory.SetGHUrl=function(url){ghUrl=url;ghDomain=getDomain(ghUrl);$rootScope.$broadcast("gh_url_update",{GHUrl:ghUrl})};factory.GetGHUrl=function(){return ghUrl};factory.GetGHActive=function(){return ghActive};factory.SetGHActive=function(active){ghActive=active};factory.GetGHSessionData=function(){var ghSessionDataStr=null;var url=decodeURIComponent($window.location.href);if(url.indexOf("gh-data-start")>0){ghSessionDataStr=url.substring(url.indexOf("gh-data-start")+13,url.indexOf("gh-data-end"))}return ghSessionDataStr};factory.LogEvent=function(evt){if(evt&&evt.EventName){GH_EVENT_TRACKER.push(evt)}};factory.CreateQuickPick=function(){var deferred=$q.defer();var createQuickPickResponse={statusCode:"FAILURE",errorMessage:""};var quickPickQueryParams=null;var onGHSessionDataReceived=function(ghSessionData){if(ghSessionData===null||typeof ghSessionData==="undefined"||ghSessionData===""){createQuickPickResponse.errorMessage="Quickpick Query params is not available";console.info(createQuickPickResponse.errorMessage);deferred.resolve(createQuickPickResponse)}try{quickPickQueryParams=ghSessionData}catch(e){createQuickPickResponse.errorMessage="Quickpick Query params is not valid";console.info(createQuickPickResponse.errorMessage);deferred.resolve(createQuickPickResponse)}linkQuickpick()};var quickPickPortalData=null;var onQuickPickDataReceived=function(quickpickData){if(quickpickData===null||typeof quickpickData==="undefined"||quickpickData===""){createQuickPickResponse.errorMessage="Quickpick portal data is not available";console.info(createQuickPickResponse.errorMessage);deferred.resolve(createQuickPickResponse)}try{quickPickPortalData=JSON.parse(quickpickData)}catch(e){createQuickPickResponse.errorMessage="Quickpick portal data is not valid";console.info(createQuickPickResponse.errorMessage);deferred.resolve(createQuickPickResponse)}ApplicationFactory.RetrieveFromParentStorage("GH_SESSION_DATA",onGHSessionDataReceived,"session")};var linkQuickpick=function(){try{if(quickPickPortalData===null||quickPickQueryParams===null){return}if(quickPickPortalData===null&&quickPickQueryParams===null){createQuickPickResponse.errorMessage="Error in fetching quickpick data";console.info(createQuickPickResponse.errorMessage);deferred.resolve(createQuickPickResponse);return}var ghPortalID=quickPickPortalData.portalId;var ghCasebaseId=quickPickPortalData.casebaseId;if(ghPortalID&&ghCasebaseId&&quickPickQueryParams){ghQuickPick={};ghQuickPick.PortalId=ghPortalID;ghQuickPick.CasebaseId=ghCasebaseId;ghQuickPick.QueryParams=quickPickQueryParams;console.info("Quickpick created successfully");deferred.resolve(createQuickPickResponse)}else{createQuickPickResponse.errorMessage="Quickpick data is not valid";console.info(createQuickPickResponse.errorMessage);deferred.resolve(createQuickPickResponse)}}catch(e){createQuickPickResponse.errorMessage="Failed to create quick pick data";console.error(createQuickPickResponse.errorMessage+"::"+e);deferred.resolve(createQuickPickResponse)}};ApplicationFactory.RetrieveFromParentStorage("GH_QUICKPICK_DATA",onQuickPickDataReceived,"session");return deferred.promise};factory.GetQuickPick=function(){return ghQuickPick};var ghWindow=null;var windowMessageListeners=function(event){if(ghDomain&&event.origin===ghDomain){switch(event.data.action){case"SAVE_GH_SESSION_DATA":ghWindow=event.source;var key=event.data.content.key;var value=event.data.content.value;ApplicationFactory.PersistToParentStorage(key,value,"session");break;case"DELETE_GH_SESSION_DATA":ghWindow=event.source;var key=event.data.content.key;ApplicationFactory.RemoveFromParentStorage(key,"session");break;case"LOG_EVENT":ghWindow=event.source;var eventData=event.data.content.eventData;GH_EVENT_TRACKER.push(eventData);break;default:break}}};if($window.addEventListener){$window.addEventListener("message",windowMessageListeners,false)}else{$window.attachEvent("message",windowMessageListeners)}var postMessageToGH=function(action){if(ghWindow){var event={action:action};ghWindow.postMessage(event,"*")}};var addParameterToURL=function(url,param){var _url=url;_url+=(_url.split("?")[1]?"&":"?")+param;return _url};var domainRegex=/^((?:https?:\/\/)?(?:www\.)?([^\/]+))/i;var getDomain=function(serverURL){var domainResult=domainRegex.exec(serverURL);return domainResult!==null?domainResult[0]:$window.location.origin};return factory}]);app.factory("ChatHeaderFactory",["ApplicationFactory","VAFactory",function(ApplicationFactory,VAFactory){var factory={};var header="";var imageUrl=ApplicationFactory.GetUrlParameter("vaLastAvatar");if(imageUrl===null||imageUrl===""){imageUrl=VAFactory.GetLaunchImage()}factory.SetChatHeader=function(string,args,isTranslated){if(isTranslated){header=string}else{if(args){ApplicationFactory.Translate(string,args).then(function(result){header=result})}else{ApplicationFactory.Translate(string).then(function(result){header=result})}}};factory.SetChatHeaderImage=function(url,relative){if(relative){imageUrl=applicationDefaults.eGainContextPath+url}else{imageUrl=url}};factory.GetChatHeader=function(){return header};factory.GetChatHeaderImage=function(){return imageUrl};return factory}]);app.factory("HooksFactory",["$state",function($state){var factory={};factory.ShowError=function(errorMessage){if(errorMessage){$state.go("chat.error",{errorMsg:errorMessage})}else{return}};return factory}]);app.factory("HttpInterceptorFactory",["$q","$injector","$timeout",function($q,$injector,$timeout){var _502Map={};var myInterceptor={request:function(request){return request},response:function(response){if(_502Map[response.config.url]){var mapData=_502Map[response.config.url];delete _502Map[response.config.url];mapData.deferred.resolve(response)}return response},responseError:function(error){if(angular.equals(502,error.status)||angular.equals(503,error.status)||angular.equals(504,error.status)){var deferred=$q.defer();if(_502Map[error.config.url]){_502Map[error.config.url].count+=1}else{_502Map[error.config.url]={request:error.config,deferred:deferred,count:0}}if(_502Map[error.config.url].count>=applicationDefaults.retryCount){_502Map={};var $state=$injector.get("$state");$state.go("chat.error",{errorCode:"CONNECT_FAIL"})}else{var httpService=$injector.get("$http");$timeout(function(){httpService(error.config)},applicationDefaults.retryIntervalInSec*1e3);return deferred.promise}}return $q.reject(error)}};return myInterceptor}]);app.factory("MessageFactory",["$rootScope","$q","$window","$filter","ApplicationFactory","SessionFactory","ConfigFactory","VAFactory",function($rootScope,$q,$window,$filter,ApplicationFactory,SessionFactory,ConfigFactory,VAFactory){var factory={};var transcript;var messageBadge=0;var offRecordFlag=false;var egainChat=ApplicationFactory.GetEgainChat();var appCallbacks=ApplicationFactory.GetEgainChatCallbacks();var transcriptPromise;var messageBadge=ApplicationFactory.GetUrlParameter("egBadgeCount");if(messageBadge){messageBadge=parseInt(messageBadge);if(isNaN(messageBadge)){messageBadge=0}}else{messageBadge=0}appCallbacks.OnAgentMessageReceived=function(agentMessageReceivedEventArgs){$rootScope.$broadcast("application_service_agent_message_received_event",agentMessageReceivedEventArgs)};appCallbacks.OnAgentStartTyping=function(agentStartTypingEventArgs){$rootScope.$broadcast("application_service_agent_start_typing_event",agentStartTypingEventArgs)};appCallbacks.OnAgentStopTyping=function(agentStopTypingEventArgs){$rootScope.$broadcast("application_service_agent_stop_typing_event",agentStopTypingEventArgs)};appCallbacks.OnSystemMessageReceived=function(systemMessageReceivedEventArgs){$rootScope.$broadcast("application_service_system_message_received_event",systemMessageReceivedEventArgs)};appCallbacks.OnServerNotificationReceived=function(serverNotificationReceivedEntArgs){$rootScope.$broadcast("application_service_server_notification_received_event",serverNotificationReceivedEntArgs)};appCallbacks.OnCobrowseInviteReceived=function(cobrowseInviteReceivedEventArgs){$rootScope.$broadcast("application_service_cobrowse_invite_received_event",cobrowseInviteReceivedEventArgs)};appCallbacks.OnTranscriptFetched=function(transcriptArgs){if(transcriptArgs.isVAEscalated)transcript=null;else transcript=transcriptArgs;transcriptPromise.resolve(transcriptArgs)};ApplicationFactory.SetEgainChatCallbacks(appCallbacks);factory.SendSystemMessage=function(data,command,isHidden){if(!command){egainChat.SendSystemMessage(data)}else{egainChat.SendSystemMessage(data,command)}factory.AddSystemMessageToTranscript(data,isHidden)};factory.AddSystemMessageToTranscript=function(data,isHidden){$rootScope.$broadcast("application_service_send_system_message_event",data,isHidden)};factory.SendMessageToAgent=function(data,isOffRecord){var eventData={originalMessage:data};if(VAFactory.IsVAActive()){eventData.sentMessage=data;if(data.length>0){$rootScope.$broadcast("application_service_send_message_to_agent_event",eventData)}VAFactory.SendVaMessage(data)}else{var sentMessage=egainChat.SendMessageToAgent(data,offRecordFlag);eventData.sentMessage=sentMessage;if(!offRecordFlag){eGainOneTagUtil.pushChatCustomerMsg(sentMessage)}$rootScope.$broadcast("application_service_send_message_to_agent_event",eventData)}};factory.SendCustomerStartTypingStatus=function(){if(!VAFactory.IsVAActive()){egainChat.SendCustomerStartTyping()}};factory.SendCustomerStopTypingStatus=function(){if(!VAFactory.IsVAActive()){egainChat.SendCustomerStopTyping()}};factory.SetTranscript=function(chatTranscript){if(typeof transcript==="undefined"){transcript=chatTranscript}else{angular.forEach(Object.keys(chatTranscript),function(keyName,key){transcript[keyName]=chatTranscript[keyName]})}};factory.SetLastAVChatInvitationDetails=function(lastAVChatInvitationMedia,lastAVChatInvitationStatus){if(lastAVChatInvitationMedia){factory.lastAVChatInvitationMedia=lastAVChatInvitationMedia}if(lastAVChatInvitationStatus){factory.lastAVChatInvitationStatus=lastAVChatInvitationStatus}};factory.SetBadgeCount=function(badgeCount){if(typeof badgeCount!=="undefined"){messageBadge=badgeCount}ApplicationFactory.PersistToParentStorage("egBadgeCount",messageBadge)};factory.GetBadgeCount=function(){return messageBadge};factory.GetChatTranscript=function(forceAPICall){transcriptPromise=$q.defer();if(!forceAPICall&&typeof transcript!=="undefined"&&transcript!==null){transcriptPromise.resolve(transcript)}else{transcript={};egainChat.GetTranscript()}return transcriptPromise.promise};factory.SetOffRecordFlag=function(flag){offRecordFlag=flag};factory.GetOffRecordFlag=function(){return offRecordFlag};var agentMessageTypes=["agent","agent1","agent2","agent3"];var agentTemplate=[];factory.GetAgentMessageType=function(agentName){var agentMsgTemplate;if(!angular.isDefined(agentTemplate[agentName])){var size=0;for(t in agentTemplate){size++}agentMsgTemplate=agentMessageTypes[size%agentMessageTypes.length];agentTemplate[agentName]=agentMsgTemplate}else{agentMsgTemplate=agentTemplate[agentName]}return agentMsgTemplate};factory.GetFormattedTime=function(date,messageTimestamp){var currentTime=$filter("date")(new Date(date.toLocaleString()),ConfigFactory.GetChatConfigurations().ChatMessagesTimeFormat);var invalidDate=false;if(!(Object.prototype.toString.call(currentTime)==="[object String]")){invalidDate=true}if(invalidDate){if(date&&"function"===typeof date.getHours&&date.getHours()&&"function"===typeof date.getMinutes&&date.getMinutes()&&"function"===typeof date.getSeconds&&date.getSeconds()){var hours=date.getHours();var minutes=date.getMinutes();var seconds=date.getSeconds();var ampm=hours>=12?"PM":"AM";hours=hours%12;hours=hours?hours:12;minutes=minutes<10?"0"+minutes:minutes;seconds=seconds<10?"0"+seconds:seconds;var strTime=hours+":"+minutes+":"+seconds+" "+ampm;currentTime=strTime}else if(messageTimestamp){currentTime=messageTimestamp}else{currentTime=""}}return currentTime};return factory}]);var MobileInterfaceObj=function(){var MobileInstance;if(typeof AndroidInterface!=="undefined"){MobileInstance=new AndroidSDK}else if(typeof webkit!="undefined"&&webkit.messageHandlers&&webkit.messageHandlers.IOSInterface){MobileInstance=new IOS_SDK}this._getInstance=function(){return MobileInstance};this._sendCloseButtonClicked=function(){MobileInstance.SendCloseButtonClicked()};this._saveTranscript=function(data){MobileInstance.SaveTranscript(data)};this._closeChat=function(){MobileInstance.CloseChat()};this._getCustomerData=function(callback){MobileInstance.GetCustomerData(callback)};this._onCustomerDataReceived=function(data){if(MobileInstance.OnCustomerDataReceived){MobileInstance.OnCustomerDataReceived(data)}else{return false}};this._downloadAttachment=function(url){if(MobileInstance.DownloadAttachment){MobileInstance.DownloadAttachment(url)}};this._setSID=function(sid){MobileInstance.SetSID(sid)};this._showCloseButton=function(flag){MobileInstance.ShowCloseButton(flag)}};MobileInterfaceObj.prototype.GetInstance=function(){return this._getInstance()};MobileInterfaceObj.prototype.SendCloseButtonClicked=function(){this._sendCloseButtonClicked()};MobileInterfaceObj.prototype.CloseChat=function(){this._closeChat()};MobileInterfaceObj.prototype.SaveTranscript=function(data){this._saveTranscript(data)};MobileInterfaceObj.prototype.GetCustomerData=function(callback){this._getCustomerData(callback)};MobileInterfaceObj.prototype.OnCustomerDataReceived=function(data){this._onCustomerDataReceived(data)};MobileInterfaceObj.prototype.SetSID=function(sid){this._setSID(sid)};MobileInterfaceObj.prototype.DownloadAttachment=function(attachmentUrl){this._downloadAttachment(attachmentUrl)};MobileInterfaceObj.prototype.ShowCloseButton=function(flag){this._showCloseButton(flag)};MobileInterfaceObj.prototype.IsCloseButtonVisible=function(){this._isCloseButtonVisible()};var AndroidSDK=function(){this.SendCloseButtonClicked=function(){AndroidInterface.onChatClosed("Chat button clicked")};this.GetCustomerData=function(callback){var data={};try{data=JSON.parse(AndroidInterface.getCustomerData())}catch(e){console.log("Error in geting customer details from app")}if(typeof callback==="function"){callback(data)}};this.SaveTranscript=function(data){AndroidInterface.saveTranscript(data)};this.SetSID=function(sid){AndroidInterface.setSId(sid)};this.CloseChat=function(){document.getElementById("chat-close-btn").click()};this.ShowCloseButton=function(flag){if(flag===false){document.getElementById("chat-close-btn").style.display="none"}}};var IOS_SDK=function(){this.SendCloseButtonClicked=function(){webkit.messageHandlers.IOSChatClosed.postMessage("Chat button clicked")};var callbackFunc;this.GetCustomerData=function(callback){callbackFunc=callback;webkit.messageHandlers.IOSGetCustomerData.postMessage("Get customer data")};this.SaveTranscript=function(data){webkit.messageHandlers.IOSSaveTranscript.postMessage(data)};this.DownloadAttachment=function(url){webkit.messageHandlers.IOSDownloadAttachment.postMessage(url)};this.SetSID=function(sid){webkit.messageHandlers.IOSSetSessionId.postMessage(sid)};this.CloseChat=function(){document.getElementById("chat-close-btn").click()};this.OnCustomerDataReceived=function(data){if(callbackFunc){callbackFunc(JSON.parse(data))}};this.ShowCloseButton=function(flag){if(flag===false){document.getElementById("chat-close-btn").style.display="none"}}};var MobileInterface=(new MobileInterfaceObj).GetInstance();app.factory("SessionFactory",["ApplicationFactory",function(ApplicationFactory){var factory={};var session={};var cobrowseSession={};var vaSessionId="";var vaNodeId="";var isChatAttachmentEnabled=false;var isChatTransferred=false;factory.SetSessionState=function(chatSessionData,lastRequestId){if(session){session=chatSessionData}if(lastRequestId){session.lastRequestId=lastRequestId}};factory.SetVANodeId=function(nodeId){vaNodeId=nodeId};factory.GetVANodeId=function(){return vaNodeId};factory.SetVASessionId=function(sid){vaSessionId=sid};factory.GetVASessionId=function(){return vaSessionId};factory.GetSessionState=function(){return session};factory.ClearSessionState=function(){session.data={};var dataToremove=["egSessionId","egChatWindowState","egBadgeCount","EgainLastRequestId","egChatInProgress","egOffRecordBtnState","egChatStateBeforeUnload","egChatEngaged","egAgentMsg","egSystemMsg","egFetchFromStorage"];ApplicationFactory.RemoveFromParentStorage(dataToremove);var dataToremove=["egAwaitingEvtDone","egChatInProgress"];ApplicationFactory.RemoveFromParentStorage(dataToremove,"session");var dataToremove=["vaSessionId","vaActive","VAEnabled","vaChatServerURL","vaEscalated","vaChatEntryPointId"];ApplicationFactory.RemoveFromParentStorage(dataToremove,"session");var dataToremove=["EGAIN_AV_CHAT_STATE_DATA","egPopoutWindow","egPopoutUrl"];ApplicationFactory.RemoveFromParentStorage(dataToremove,"session");var dataToremove=["egGHActive","egGHUrl"];ApplicationFactory.RemoveFromParentStorage(dataToremove,"session");factory.SetVASessionId("");ApplicationFactory.RemoveFromStorage("egCobrowseSessionData","session")};factory.SaveCobrowseSessionState=function(cobrowseInvites){cobrowseSession.cobrowseInvites=cobrowseInvites;ApplicationFactory.PersistToStorage("egCobrowseSessionData",cobrowseSession,"session")};factory.GetCobrowseSessionState=function(){if(!cobrowseSession||!cobrowseSession.cobrowseInvites){var cobrowseSessionData=ApplicationFactory.RetrieveFromStorage("egCobrowseSessionData","session");if(cobrowseSessionData){cobrowseSession=JSON.parse(cobrowseSessionData)}else{cobrowseSession={};cobrowseSession.cobrowseInvites={}}}return cobrowseSession};factory.SetChatAttachmentEnabledFlag=function(flag){isChatAttachmentEnabled=flag};factory.GetChatAttachmentEnabledFlag=function(){return isChatAttachmentEnabled};factory.SetChatTransferredFlag=function(flag){isChatTransferred=flag};factory.GetChatTransferredFlag=function(){return isChatTransferred};return factory}]);app.factory("TranscriptFactory",["$q","$http","$rootScope","$translate","$filter","ApplicationFactory","MessageFactory","SessionFactory","VAFactory",function($q,$http,$rootScope,$translate,$filter,ApplicationFactory,MessageFactory,SessionFactory,VAFactory){var factory={};var template;var transcriptTemplate;var pendingAttachmentCount=0;var templateName=ApplicationFactory.GetUrlParameter("templateName");registerHandlebarsHelpers();factory.GetTranscriptTemplate=function(){if(transcriptTemplate){return $q.when(transcriptTemplate)}else{if(templateName){return $http.get(applicationDefaults.eGainContextPath+"transcript/transcript.properties").then(function(response){transcriptTemplate=response.data;template=Handlebars.compile(response.data);return response.data})}}};factory.CheckTranscriptFileVersion=function(data){var hash=CryptoJS.MD5(data);var chatServerURL=VAFactory.GetVAChatServerURL();chatServerURL=chatServerURL!=null&&chatServerURL!=""?chatServerURL:applicationDefaults.eGainChatApiPath;$http({method:"POST",url:chatServerURL+"/egain/chat/entrypoint/checktranscriptfileversion/"+templateName,headers:{"Content-Type":"application/x-www-form-urlencoded","X-egain-session":ApplicationFactory.GetXEgainSessionID()},data:postParams({md5:hash.toString()}),dataType:"text"}).then(function(response){if(response.data=="false"){factory.PostTranscriptTemplate(data,hash.toString())}})};factory.PostTranscriptTemplate=function(transcript,md5){var chatServerURL=VAFactory.GetVAChatServerURL();chatServerURL=chatServerURL!=null&&chatServerURL!=""?chatServerURL:applicationDefaults.eGainChatApiPath;$http({method:"POST",url:chatServerURL+"/egain/chat/entrypoint/posttranscripttemplate/"+templateName,headers:{"Content-Type":"application/x-www-form-urlencoded","X-egain-session":ApplicationFactory.GetXEgainSessionID()},data:postParams({transcript:transcript,md5:md5})})};factory.GetTranscript=function(){return $q.all([getChatTranscript(),getCobrowseTranscript()]).then(function(transcripts){return transcripts[0]+transcripts[1]})};function registerHandlebarsHelpers(){Handlebars.registerHelper("ifCustomer",function(options){if(!this.attributes){return options.inverse(this)}if(this.attributes.type=="Customer"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("ifAgent1",function(options){if(!this.attributes){return options.inverse(this)}if(this.attributes.type=="agent"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("ifAgent2",function(options){if(!this.attributes){return options.inverse(this)}if(this.attributes.type=="agent1"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("ifAgent3",function(options){if(!this.attributes){return options.inverse(this)}if(this.attributes.type=="agent2"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("ifAgent4",function(options){if(!this.attributes){return options.inverse(this)}if(this.attributes.type=="agent3"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("ifSystem",function(options){if(this.attributes==null){return options.fn(this)}else{return options.inverse(this)}})}function getChatTranscript(){var chatTranscript="";var title="";var footer="";var footerByEgain="";var offRecordMessage="";var printTitle="";var messages=[];return $translate(["APP.EG_TRANSCRIPT_HEADER","APP.EG_TRANSCRIPT_FOOTER","APP.EG_POWERED_BY_BRAND","APP.EG_OFF_RECORD_MESSAGE_REMOVED","APP.EG_PRINT"]).then(function(translations){title=translations["APP.EG_TRANSCRIPT_HEADER"];footer=translations["APP.EG_TRANSCRIPT_FOOTER"];footerByEgain=translations["APP.EG_POWERED_BY_BRAND"];offRecordMessage=translations["APP.EG_OFF_RECORD_MESSAGE_REMOVED"];printTitle=translations["APP.EG_PRINT"];return MessageFactory.GetChatTranscript().then(function(response){angular.forEach(response.Messages,function(messageObject){var newMessageObject={};if(messageObject.SenderType==="System"||messageObject.SenderType==="logger"){if(messageObject.Attachment){var args=new Array;args[1]=messageObject.Attachment.Name;args[0]=messageObject.SenderName;var agentInitiatedAttachmentMsg=decodeURIComponent(JSON.parse('"'+$rootScope.messagingProperty.attachment_to_chat_customer+'"'));agentInitiatedAttachmentMsg=ApplicationFactory.GetFormattedMessage(agentInitiatedAttachmentMsg,args);newMessageObject.body=agentInitiatedAttachmentMsg;newMessageObject.time=messageObject.Timestamp}else{newMessageObject.body=messageObject.Body;newMessageObject.time=messageObject.Timestamp}}else{if(messageObject.Attachment){var args=new Array;args[1]=messageObject.Attachment.Name;args[0]=messageObject.SenderName;var agentInitiatedAttachmentMsg=decodeURIComponent(JSON.parse('"'+$rootScope.messagingProperty.attachment_to_chat_customer+'"'));agentInitiatedAttachmentMsg=ApplicationFactory.GetFormattedMessage(agentInitiatedAttachmentMsg,args);newMessageObject.body=agentInitiatedAttachmentMsg;newMessageObject.time=messageObject.Timestamp}else{newMessageObject.attributes={author:messageObject.SenderName,type:messageObject.SenderType,time:messageObject.Timestamp};if(messageObject.OffRecord===true){newMessageObject.attributes.body=offRecordMessage}else{newMessageObject.attributes.body=messageObject.Body}}}messages.push(newMessageObject)});return $translate("APP.EG_TRANSCRIPT_START_TIME",{chatStartTime:$filter("date")(new Date(response.StartTime),"medium")}).then(function(result){var content={title:title,liveChat:title,transcript:"transcript",chatStartedAt:result,footerLiveChat:footer,footerByEgain:footerByEgain,isMailTranscript:false,messages:messages,isOffRecordMsgReplaced:false,imageUrl:[window.location.protocol,"//",window.location.host,applicationDefaults.eGainChatApiPath,"/templates/chat/",templateName,"/image"].join(""),printTitle:printTitle};chatTranscript=template(content);return chatTranscript})})})}var getCobrowseTranscript=function(){var cobrowseTranscript="";var promises=new Array;var tzone=ApplicationFactory.GetTimeZoneOffset();
var cobrowseSessionData=SessionFactory.GetCobrowseSessionState();if(cobrowseSessionData&&cobrowseSessionData.cobrowseInvites){for(var cbSessionId in cobrowseSessionData.cobrowseInvites){var cobrowseInvite=cobrowseSessionData.cobrowseInvites[cbSessionId];if(cobrowseInvite&&cobrowseInvite.status=="CLOSED"){var customerName=cobrowseInvite.customerName;var promise=$http.get(applicationDefaults.eGainChatApiPath+"/web/view/collaboration/agent/fetchTranscript.jsp?sessionId="+cbSessionId+"&consumer=CUSTOMER&custName="+customerName+"&tzone="+tzone,{cache:true});promises.push(promise)}}}if(promises.length>0){return $q.all(promises).then(function(cobrowseTranscriptData){angular.forEach(cobrowseTranscriptData,function(cobrowseTranscriptDataEle){if(cobrowseTranscriptDataEle&&cobrowseTranscriptDataEle.data){cobrowseTranscript+=cobrowseTranscriptDataEle.data}});return cobrowseTranscript},function(){return $q.when(cobrowseTranscript)})}else{return $q.when(cobrowseTranscript)}};var postParams=function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")};factory.IncreasePendingAttachmentCount=function(){pendingAttachmentCount++};factory.DecreasePendingAttachmentCount=function(){pendingAttachmentCount--};factory.GetPendingAttachmentCount=function(){return pendingAttachmentCount};return factory}]);app.factory("VAFactory",["$rootScope","$q","ApplicationFactory","SessionFactory","GHFactory",function($rootScope,$q,ApplicationFactory,SessionFactory,GHFactory){var factory={};var isVAEnabled=ApplicationFactory.GetUrlParameter("VAEnabled")==="true"?true:false;var isVAActive=ApplicationFactory.GetUrlParameter("VAActive")==="true"?true:false;var isVAEscalated=ApplicationFactory.GetUrlParameter("VAEscalated")==="true"?true:false;var transcript;var transcriptPromise;var VALibrary;var VAChatServerURL="";var VAEntryPointId="";var launchImage="";var imageNameLoadedDeferred=$q.defer();var customer;var chatServerURL=ApplicationFactory.GetUrlParameter("vaChatServerURL");if(chatServerURL!==null)VAChatServerURL=chatServerURL;var chatEntryPointId=ApplicationFactory.GetUrlParameter("vaChatEntryPointId");if(chatEntryPointId!==null)VAEntryPointId=chatEntryPointId;factory.initializeVALibrary=function(){var librarySettings=new eGainLibrarySettings;if(vaConfigurations.eGainVAApiPath===""){var domainRegex=/^((?:https?:\/\/)?(?:www\.)?([^\/]+))/i;var domainResult=domainRegex.exec(window.location.href);vaConfigurations.eGainVAApiPath=domainResult!=null?domainResult[0]:window.location.origin}librarySettings.CORSHost=vaConfigurations.eGainVAApiPath;VALibrary=new eGainVALibrary(librarySettings);var vaName=ApplicationFactory.GetUrlParameter("VAName");launchImage=vaConfigurations[vaName+"_launchImage"];if(typeof launchImage==="undefined"||launchImage===null||launchImage.trim()===""){VALibrary.GetLaunchImage(ApplicationFactory.GetUrlParameter("VATenantAccId"),ApplicationFactory.GetUrlParameter("VAName"),vaLaunchImageCallback)}else{imageNameLoadedDeferred.resolve(launchImage)}};factory.SetVAEnabled=function(isEnabled){isVAEnabled=isEnabled};factory.IsVAEnabled=function(){return isVAEnabled===true};factory.SetVAActive=function(vaActive){isVAActive=vaActive;ApplicationFactory.PersistToParentStorage("vaActive",isVAActive,"session")};factory.IsVAActive=function(){return isVAActive===true};factory.SetVAEscalated=function(isEscalated){isVAEscalated=isEscalated;ApplicationFactory.PersistToParentStorage("vaEscalated",isEscalated,"session")};factory.IsVAEscalated=function(){return isVAEscalated};factory.GetVALibrary=function(){return VALibrary};factory.SetVAChatServerURL=function(url){VAChatServerURL=url};factory.GetVAChatServerURL=function(){return VAChatServerURL};factory.SetVAEntryPointId=function(id){VAEntryPointId=id};factory.GetVAEntryPointId=function(){return VAEntryPointId};factory.GetShowPreChatOnEscalation=function(){return vaConfigurations.ShowPreChatOnEscalation};factory.SendVaMessage=function(data,action){var sid=SessionFactory.GetVASessionId();sendMessageToVa(data,action,sid)};factory.SetLaunchImage=function(path){launchImage=path;imageNameLoadedDeferred.resolve(path)};factory.GetLaunchImage=function(reload){return imageNameLoadedDeferred.promise};factory.GetVAHost=function(reload){return VALibrary.GetVAHost()};factory.GetVACustomer=function(){return customer};var vaLaunchImageCallback=function(data){if(data.launchImage.indexOf("http")==-1)data.launchImage=factory.GetVAHost()+"/assistantIMG/"+data.launchImage+"/Emotions/launchImage.gif";factory.SetLaunchImage(data.launchImage)};factory.GetVATranscript=function(isVAEscalated){transcriptPromise=$q.defer();var sid=SessionFactory.GetVASessionId();VALibrary.GetVATranscript(ApplicationFactory.GetUrlParameter("VATenantAccId"),sid,isVAEscalated,vaTranscriptCallback);return transcriptPromise.promise};var sendMessageToVa=function(data,action,sessionId){if(typeof data!=="undefined"&&data!==null){data=ApplicationFactory.htmlDecode(data)}VALibrary.SendMessageToVA(ApplicationFactory.GetUrlParameter("VATenantAccId"),ApplicationFactory.GetUrlParameter("VAName"),sessionId,data,action,vaExchangeCallback,SessionFactory.GetVANodeId())};var vaExchangeCallback=function(data){var postMessageDataObj=null;if(data.escalate){if(data.entryPointId&&data.entryPointId!=""){VAEntryPointId=data.entryPointId;if(postMessageDataObj===null){postMessageDataObj={}}postMessageDataObj["vaChatEntryPointId"]=data.entryPointId}if(data.chatServerURL&&data.chatServerURL!=""){VAChatServerURL=data.chatServerURL;if(postMessageDataObj===null){postMessageDataObj={}}postMessageDataObj["vaChatServerURL"]=data.chatServerURL}if(data.customer){var i=0;for(i=0;i<data.customer.length;i++){data.customer[i]=$("<textarea/>").html(data.customer[i]).text()}customer=data.customer}}if(data.avatar){if(postMessageDataObj===null){postMessageDataObj={}}postMessageDataObj["vaLastAvatar"]=data.avatar}if(postMessageDataObj!==null){ApplicationFactory.PersistToParentStorage("vaData",postMessageDataObj,"session")}if(SessionFactory.GetVASessionId()===""||SessionFactory.GetVASessionId()!==data.sid){SessionFactory.SetVASessionId(data.sid);ApplicationFactory.PersistToParentStorage("vaSessionId",data.sid,"session")}if(SessionFactory.GetVANodeId()==""||SessionFactory.GetVANodeId()!=data.nodeId){SessionFactory.SetVANodeId(data.nodeId);ApplicationFactory.PersistToParentStorage("VANodeId",data.nodeId,"session")}$rootScope.$broadcast("application_service_agent_message_received_event",data);if(data.slideouturl&&data.slideouturl.trim()!=""){GHFactory.OpenGHWindow(data.slideouturl,data.slideouttype,true)}};var vaTranscriptCallback=function(transcriptArgs){if(transcriptArgs.isVAEscalated)transcript=null;else transcript=transcriptArgs;transcriptPromise.resolve(transcriptArgs)};return factory}]);app.factory("VideoFactory",["$window","$rootScope","ApplicationFactory","ConfigFactory","MessageFactory","ConnectionFactory","CustomerFactory",function($window,$rootScope,ApplicationFactory,ConfigFactory,MessageFactory,ConnectionFactory,CustomerFactory){Number.isInteger=Number.isInteger||function(value){return typeof value==="number"&&isFinite(value)&&Math.floor(value)===value};var factory={AGENT_VIDEO_MODE:1,TWO_WAY_AUDIO_VIDEO_MODE:2,AGENT_AUDIO_MODE:3,TWO_WAY_AUDIO_MODE:4,TWO_WAY_AUDIO_AGENT_VIDEO_MODE:5,TWO_WAY_AUDIO_CUSTOMER_VIDEO_MODE:6,state:{agentInitiatedVideo:false,agentInvitationTime:0,audioCapable:false,audioPaused:false,AVinitialized:true,avmode:0,custInvitationTime:0,isAgentJoined:false,isDirectAudioChatEnabled:false,isDirectVideoChatEnabled:false,isVideoChatEnabled:false,isVideoChatLicensed:false,openTokParams:null,publisherInitialized:true,showVideoButton:false,subscriberInitialized:true,vendor:null,videoCapable:false,videochat:false,videoChatMaxEscalation:0,videoInitialized:false,videoPaused:false,videoShowing:false,videoStopped:false},showVideoChatButton:false,showAudioChatButton:false,avChatFrameMaximised:false,isChatTransferred:false};var _saveTop=-1;var _saveLeft=-1;var _saveHeight=-1;var _saveWidth=-1;var _popoutWindow=$window;factory.state.avmode=factory.TWO_WAY_AUDIO_VIDEO_MODE;var connection=ConnectionFactory.GetConnection();var egainChat=ApplicationFactory.GetEgainChat();var appCallbacks=ApplicationFactory.GetEgainChatCallbacks();$rootScope.$on("application_service_chat_initialized_success_event",function(evt,response){if(response){factory.state.isVideoChatLicensed="boolean"===typeof response.isVideoChatLicensed?response.isVideoChatLicensed:false;factory.state.isVideoChatEnabled="boolean"===typeof response.isVideoChatEnabled?response.isVideoChatEnabled:false;factory.state.videoChatMaxEscalation=response.videoChatMaxEscalation&&Number.isInteger(response.videoChatMaxEscalation)?response.videoChatMaxEscalation:5;factory.state.isDirectVideoChatEnabled=factory.state.videoChatMaxEscalation===3||factory.state.videoChatMaxEscalation>4;factory.state.isDirectAudioChatEnabled="boolean"===typeof response.isDirectAudioChatEnabled?response.isDirectAudioChatEnabled:false;factory.PersistStateData()}});appCallbacks.OnCustomerInitiateVideo=function(){factory.state.videochat=true;factory.PersistStateData()};appCallbacks.OnAgentInitiateVideo=function(){factory.state.agentInitiatedVideo=true;factory.state.agentInvitationTime=factory.state.videoStopped?Date.now():0;factory.PersistStateData()};appCallbacks.OnStartVideo=function(){};appCallbacks.OnStopVideo=function(){factory.state.custInvitationTime=0;if(factory.state.videoShowing){factory.Show()}else{factory.PersistStateData()}};appCallbacks.OnVideoChatTokenReceived=function(videoToken){factory.state.avmode=parseInt(videoToken.avmode);factory.state.vendor=videoToken.vendor;factory.state.openTokParams=videoToken.openTokParams;if(factory.IsWindowReadyForAVChat()){factory.InitiateAVChat()}else{factory.InitiatePopout()}};appCallbacks.OnAgentAutoRejectVideo=function(){factory.state.custInvitationTime=0;factory.PersistStateData()};appCallbacks.OnCustomerAutoRejectVideo=function(){factory.state.agentInitiatedVideo=false;factory.PersistStateData()};appCallbacks.OnVideoChatCapable=function(params){factory.state.isVideoChatEnabled="boolean"===typeof params.isVideoChatEnabled?params.isVideoChatEnabled:factory.state.isVideoChatEnabled;factory.state.showVideoButton="boolean"===typeof params.showVideoButton?params.showVideoButton:false;factory.CheckVideoAudioCapable(factory.state.showVideoButton)};appCallbacks.OnVideoChatMaxEscalation=function(params){factory.state.videoChatMaxEscalation=params.videoChatMaxEscalation&&Number.isInteger(params.videoChatMaxEscalation)?params.videoChatMaxEscalation:5;factory.state.isDirectVideoChatEnabled="boolean"===typeof params.isDirectVideoChatEnabled?params.isDirectVideoChatEnabled:false;factory.AdjustVideoAudioChatButtons()};appCallbacks.OnAudioChatEnabled=function(params){factory.state.isDirectAudioChatEnabled="boolean"===typeof params.isDirectAudioChatEnabled?params.isDirectAudioChatEnabled:false;factory.AdjustVideoAudioChatButtons()};appCallbacks.OnAcceptVideoChat=function(accepted){factory.state.agentInitiatedVideo=false;if(true===accepted){factory.state.videochat=true}else{ApplicationFactory.Translate("APP.EG_AV_INVITATION_BY_AGENT_EXPIRED").then(function(msg){MessageFactory.SendSystemMessage(msg)})}factory.PersistStateData()};appCallbacks.OnDeclineVideoChat=function(declined){factory.state.agentInitiatedVideo=false;if(true===declined){}else{ApplicationFactory.Translate("APP.EG_AV_INVITATION_BY_AGENT_EXPIRED").then(function(msg){MessageFactory.SendSystemMessage(msg)})}factory.PersistStateData()};appCallbacks.OnInitiateVideoChat=function(response){switch(response.statusCode){case 1:{factory.SendInviteMessage();break}case-1:case 0:default:{ApplicationFactory.Translate("APP."+response.statusText).then(function(msg){factory.Alert(msg)});break}}};ApplicationFactory.SetEgainChatCallbacks(appCallbacks);factory.IsPublishAudio=function(){var publish=true;var avmode=factory.GetAVMode();switch(avmode){case factory.AGENT_VIDEO_MODE:case factory.AGENT_AUDIO_MODE:{publish=false;break}}factory.state.audioPaused=!publish;return publish};factory.IsPublishVideo=function(){var publish=true;var avmode=factory.GetAVMode();switch(avmode){case factory.AGENT_VIDEO_MODE:case factory.AGENT_AUDIO_MODE:case factory.TWO_WAY_AUDIO_MODE:case factory.TWO_WAY_AUDIO_AGENT_VIDEO_MODE:{publish=false;break}}factory.state.videoPaused=!publish;return publish};factory.HideVideo=function(){var hidden=false;var videoChatMaxEscalation=factory.state.videoChatMaxEscalation;switch(videoChatMaxEscalation){case 2:case 4:{hidden=true;break}default:break}return hidden};factory.IsSubscribeAudio=function(){var subscribe=true;var avmode=factory.GetAVMode();switch(avmode){case factory.AGENT_VIDEO_MODE:{subscribe=false;break}}return subscribe};factory.IsSubscribeVideo=function(){var subscribe=true;var avmode=factory.GetAVMode();switch(avmode){case factory.AGENT_AUDIO_MODE:case factory.TWO_WAY_AUDIO_MODE:case factory.TWO_WAY_AUDIO_CUSTOMER_VIDEO_MODE:{subscribe=false;break}}return subscribe};factory.CheckVideoAudioCapable=function(usrLicence){factory.state.videoCapable=usrLicence&&ConfigFactory.GetChatConfigurations().ShowVideoButton&&factory.state.isVideoChatEnabled&&factory.state.isVideoChatLicensed;factory.state.audioCapable=usrLicence&&ConfigFactory.GetChatConfigurations().ShowAudioButton&&factory.state.isVideoChatEnabled&&factory.state.isVideoChatLicensed;if(true===factory.state.videoCapable||true===factory.state.audioCapable){factory.AdjustVideoAudioChatButtons()}else{factory.PersistStateData()}};factory.AdjustVideoAudioChatButtons=function(){factory.SaveButtonStateOnTransfer();var data=factory.GetAVChatButtonsState();$rootScope.$broadcast("application_service_adjust_video_audio_chat_buttons",data);factory.PersistStateData()};factory.GetAVChatButtonsStateWithoutTransferLogic=function(){var data={};data.showVideoChatButton=factory.state.isDirectVideoChatEnabled&&factory.state.videoCapable;data.showAudioChatButton=factory.state.isDirectAudioChatEnabled&&factory.state.audioCapable;factory.showVideoChatButton=data.showVideoChatButton;factory.showAudioChatButton=data.showAudioChatButton;return data};factory.GetAVChatButtonsState=function(){var data={};if(false===connection.connected||false===factory.state.isAgentJoined||true===factory.state.videoShowing){data.showVideoChatButton=false;data.showAudioChatButton=false}else if(factory.state.transfer&&factory.state.transfer.buttonState&&"boolean"===typeof factory.state.transfer.buttonState.showVideoChatButton&&"boolean"===typeof factory.state.transfer.buttonState.showAudioChatButton){data.showVideoChatButton=factory.state.transfer.buttonState.showVideoChatButton;data.showAudioChatButton=factory.state.transfer.buttonState.showAudioChatButton}else{data=factory.GetAVChatButtonsStateWithoutTransferLogic()}factory.showVideoChatButton=data.showVideoChatButton;factory.showAudioChatButton=data.showAudioChatButton;return data};factory.IsInvitationByAgentExpired=function(){var retVal=false;if(true===factory.state.videoShowing||factory.state.agentInvitationTime>0&&Date.now()-factory.state.agentInvitationTime>ConfigFactory.GetChatConfigurations().VideoReofferTimeout){ApplicationFactory.Translate("APP.EG_AV_INVITATION_BY_AGENT_EXPIRED").then(function(msg){MessageFactory.SendSystemMessage(msg)});retVal=true}else{factory.state.agentInvitationTime=Date.now()-ConfigFactory.GetChatConfigurations().VideoReofferTimeout;factory.PersistStateData()}return retVal};factory.AcceptVideoChat=function(userId,avmode){if(false===factory.IsInvitationByAgentExpired()){egainChat.AcceptVideoChat(connection.sessionID,userId,avmode)}};factory.DeclineVideoChat=function(userId,avmode){if(false===factory.IsInvitationByAgentExpired()){egainChat.DeclineVideoChat(connection.sessionID,userId,avmode)}};factory.Alert=function(msg,debugMsg){if(msg){alert(msg);debugMsg=debugMsg||msg;console.log(debugMsg)}};factory.VideoClick=function(){factory.PushOneTagEventForVideoClick();if(true===factory.state.isDirectVideoChatEnabled){if(true===factory.state.videoShowing){factory.ToggleVideo()}else{factory.state.avmode=factory.TWO_WAY_AUDIO_VIDEO_MODE;factory.Show()}}};factory.AudioClick=function(){factory.PushOneTagEventForAudioClick();if(true===factory.state.isDirectAudioChatEnabled){if(true===factory.state.videoShowing){factory.ToggleAudio()}else{factory.state.avmode=factory.TWO_WAY_AUDIO_MODE;factory.Show()}}};factory.VideoPausedState=function(videoPaused){if("boolean"===typeof videoPaused){factory.state.videoPaused=videoPaused;factory.PersistStateData()}return factory.state.videoPaused};factory.AudioPausedState=function(audioPaused){if("boolean"===typeof audioPaused){factory.state.audioPaused=audioPaused;factory.PersistStateData()}return factory.state.audioPaused};factory.ToggleVideo=function(publisherId){publisherId=publisherId||"eg-video-camera";if(true===factory.state.isDirectVideoChatEnabled&&true===factory.state.publisherInitialized){var videoFrame=factory.GetVideoChatFrame();if(videoFrame){videoFrame.contentWindow.webcam(factory.state.videoPaused)}factory.state.videoPaused=!factory.state.videoPaused;var notifyMsg="EG_VIDEO_RESUMED_BY_CUSTOMER";if(true===factory.state.videoPaused){notifyMsg="EG_VIDEO_PAUSED_BY_CUSTOMER"}ApplicationFactory.Translate("APP."+notifyMsg,{CustomerName:CustomerFactory.GetCustomerScreenName()}).then(function(msg){MessageFactory.SendSystemMessage(msg,"pauseresumevideo",true)})}};factory.ToggleAudio=function(publisherId){publisherId=publisherId||"eg-video-camera";if(true===factory.state.publisherInitialized){var videoFrame=factory.GetVideoChatFrame();if(videoFrame){videoFrame.contentWindow.mike(factory.state.audioPaused)}factory.state.audioPaused=!factory.state.audioPaused;var notifyMsg="EG_AV_AUDIO_UNMUTED_BY_CUSTOMER";if(true===factory.state.audioPaused){notifyMsg="EG_AV_AUDIO_MUTED_BY_CUSTOMER"}ApplicationFactory.Translate("APP."+notifyMsg,{CustomerName:CustomerFactory.GetCustomerScreenName()}).then(function(msg){MessageFactory.SendSystemMessage(msg,"muteunmuteaudio",true)})}};factory.Show=function(){if(connection.sessionID){if(true===factory.state.videoShowing){factory.EndAVChatByAgent()}else{if(factory.state.videoStopped){factory.ReInvite()}else if(factory.state.videoInitialized){factory.state.videoShowing=true;factory.AdjustVideoAudioChatButtons();ApplicationFactory.Translate("APP.EG_AV_CHAT_CONNECTED_WITH_CUSTOMER",{CustomerName:CustomerFactory.GetCustomerScreenName()}).then(function(msg){MessageFactory.SendSystemMessage(msg,"startVideo",true)});ApplicationFactory.Translate("APP.EG_AV_CHAT_CONNECTED_WITH_AGENT",{AgentName:ApplicationFactory.GetAgentName()}).then(function(msg){MessageFactory.AddSystemMessageToTranscript(msg)})}else{factory.InitiateVideoChat()}}}factory.PersistStateData()};factory.InitiateAVChat=function(){$rootScope.$broadcast("application_service_video_chat_token_received",factory.GetVideoToken())};factory.GetVideoToken=function(){var videoToken=null;if(factory.state&&factory.state.openTokParams&&factory.state.openTokParams["OT_apiKey"]&&factory.state.openTokParams["OT_sessionId"]&&factory.state.openTokParams["OT_token"]){videoToken={};videoToken.openTokParams={};videoToken.openTokParams["OT_apiKey"]=factory.state.openTokParams["OT_apiKey"];videoToken.openTokParams["OT_sessionId"]=factory.state.openTokParams["OT_sessionId"];videoToken.openTokParams["OT_token"]=factory.state.openTokParams["OT_token"]}return videoToken};factory.EndAVChatByCustomer=function(){factory.EndAVChat();factory.SendAVChatEndedMessageToAgent()};factory.EndAVChatByAgent=function(){factory.EndAVChat()};factory.AddAVChatIframe=function(wrapperId){if(wrapperId){var url=applicationDefaults.eGainContextPath+"libs/videochat/videochat.html";factory.videoWrapperElement=$("#"+wrapperId);if(factory.videoWrapperElement){factory.videoWrapperElement.html('<iframe style="width:100%;height:100%;border:0;" id="videoChatFrame" src="'+url+'">')}}};factory.GetVideoChatFrame=function(){var videoFrame=document.getElementById("videoChatFrame");return videoFrame};factory.RemoveAVChatIframe=function(){var videoFrame=factory.GetVideoChatFrame();if(videoFrame){videoFrame.contentWindow.stopVideoChat();$("iframe#videoChatFrame").load(function(){factory.videoShowing=false});videoFrame.style.display="none"}};factory.EndAVChat=function(){factory.state.videoStopped=true;factory.state.videoShowing=false;factory.state.openTokParams=null;factory.ToggleFrameMaximise(false);factory.AdjustVideoAudioChatButtons();factory.RemoveAVChatIframe();$rootScope.$broadcast("application_service_avchat_ended",true)};factory.OnChatCompletionHandler=function(){factory.EndAVChat();factory.RemoveStateData()};factory.SendAVChatEndedMessageToAgent=function(){var avmode=factory.GetAVMode();var isVideo=avmode===factory.TWO_WAY_AUDIO_VIDEO_MODE||avmode===factory.TWO_WAY_AUDIO_AGENT_VIDEO_MODE||avmode===factory.AGENT_VIDEO_MODE;var msg=isVideo?"EG_VIDEO_CHAT_ENDED_BY_CUSTOMER":"EG_AUDIO_CHAT_ENDED_BY_CUSTOMER";ApplicationFactory.Translate("APP."+msg,{CustomerName:CustomerFactory.GetCustomerScreenName()}).then(function(msg){MessageFactory.SendSystemMessage(msg,"stopVideo")})};factory.ReInvite=function(){if(factory.state.agentInvitationTime>0&&Date.now()-factory.state.agentInvitationTime<=ConfigFactory.GetChatConfigurations().VideoReofferTimeout){factory.AlertInvitedByAgent()}else{var awatingInviteResponse=factory.state.custInvitationTime>0&&Date.now()-factory.state.custInvitationTime<=ConfigFactory.GetChatConfigurations().VideoReofferTimeout;if(true===awatingInviteResponse){ApplicationFactory.Translate("APP.EG_VIDEO_INVITE_ALREADY_SENT").then(function(msg){factory.Alert(msg)})}else{factory.SendInviteMessage()}}};factory.AlertInvitedByAgent=function(){ApplicationFactory.Translate("APP.EG_VIDEO_ALREADY_INVITED_BY_AGENT",{AgentName:ApplicationFactory.GetAgentName()}).then(function(msg){factory.Alert(msg)})};factory.AlertL10N=function(l10nKey){if(l10nKey){ApplicationFactory.Translate("APP."+l10nKey).then(function(msg){factory.Alert(msg)})}};factory.InitiateVideoChat=function(){if(true===factory.state.agentInitiatedVideo){factory.AlertInvitedByAgent()}else{egainChat.InitiateVideoChat(connection.sessionID)}};factory.SendInviteMessage=function(){var msgToAgent="EG_AV_INVITE_FOR_TWO_WAY_AUDIO_CHAT_BY_CUSTOMER";var msgToCust="EG_AV_WAIT_MSG_FOR_AUDIO_CHAT_INVITED_BY_CUSTOMER";var command="custinitiateaudio";var customerName=CustomerFactory.GetCustomerScreenName();if(factory.TWO_WAY_AUDIO_VIDEO_MODE===factory.state.avmode){msgToAgent=5>factory.state.videoChatMaxEscalation?"EG_AV_INVITE_FOR_CUSTOMER_AV_CHAT_BY_CUSTOMER":"EG_AV_INVITE_FOR_TWO_WAY_AV_CHAT_BY_CUSTOMER";msgToCust="EG_AV_WAIT_MSG_FOR_VIDEO_CHAT_INVITED_BY_CUSTOMER";command="custinitiatevideo"}factory.state.custInvitationTime=Date.now();ApplicationFactory.Translate("APP."+msgToAgent,{CustomerName:customerName}).then(function(msg){MessageFactory.SendSystemMessage(msg,command,true)});ApplicationFactory.Translate("APP."+msgToCust).then(function(msg){MessageFactory.AddSystemMessageToTranscript(msg)});factory.PersistStateData()};factory.UpdateAVChatInvitation=function(){var status=MessageFactory.lastAVChatInvitationStatus;if(status){switch(status){case"expired":{factory.state.agentInvitationTime=Date.now()-ConfigFactory.GetChatConfigurations().VideoReofferTimeout;factory.state.custInvitationTime=Date.now()-ConfigFactory.GetChatConfigurations().VideoReofferTimeout;break}case"rejected":{factory.state.agentInvitationTime=0;factory.state.custInvitationTime=0;break}}}};factory.InitializeVideo=function(){window.location.hash="#startvideo";factory.state.videoStopped=false;factory.state.videoInitialized=true;factory.Show()};factory.PushOneTagEventForVideoClick=function(){eGainOneTagUtil.pushChatEvent("uac",{EventName:"ChatMenuButton",ButtonDesc:"Video"})};factory.PushOneTagEventForAudioClick=function(){eGainOneTagUtil.pushChatEvent("uac",{EventName:"ChatMenuButton",ButtonDesc:"Voice"})};factory.AVinitErrorHandler=function(error,session){if(error){factory.state.AVinitialized=false;var errorMsg="EG_AV_ERROR_UNABLE_TO_CONNECT";switch(error.code){case 1004:{errorMsg="EG_AV_ERROR_SESSION_AUTHENTICATION";break}case 1005:{errorMsg="EG_AV_ERROR_INVALID_SESSION_ID";break}case 1006:{errorMsg="EG_AV_ERROR_SESSION_CONNECTION_FAILED";break}default:{errorMsg="EG_AV_ERROR_UNABLE_TO_CONNECT"}}ApplicationFactory.Translate("APP."+errorMsg).then(function(msg){factory.Alert(msg,error.message)})}else{factory.state.AVinitialized=true}};factory.AVpublisherErrorHandler=function(error){if(error){factory.state.publisherInitialized=false;var errorMsg="EG_AV_ERROR_PUBLISHER_INITIALIZATION";switch(error.code){case 1004:{errorMsg="EG_AV_ERROR_PUBLISHER_AUTHENTICATION";break}case 1010:{errorMsg="EG_AV_ERROR_NOT_CONNECTED";break}case 1013:{errorMsg="EG_AV_ERROR_PUBLISH_CONNECTION_FAILED";break}case 1500:{if(true===factory.state.publisherInitialized){errorMsg="EG_AV_ERROR_PUBLISH_NOT_ALLOWED"}else if(-1<error.message.indexOf("Publisher Access Denied:")){errorMsg="EG_AV_ERROR_ALLOW_CAMERA_MIC_ACCESS"}else if(-1<error.message.indexOf("Publisher PeerConnection Error:")){errorMsg="EG_AV_ERROR_PUBLISHER_PEER_CONNECTION"}else{errorMsg="EG_AV_ERROR_CAMERA_MIC_ACCESS_FAILED"}break}case 1553:{errorMsg="EG_AV_ERROR_PUBLISHER_PEER_CONNECTION";break}case 1601:case 2e3:{errorMsg="EG_AV_ERROR_PUBLISH_INTERNAL";break}default:{errorMsg="EG_AV_ERROR_PUBLISHER_INITIALIZATION"}}ApplicationFactory.Translate("APP."+errorMsg).then(function(msg){factory.Alert(msg,error.message)})}else{factory.state.publisherInitialized=true}};factory.AVsubscriberErrorHandler=function(error){if(error){factory.state.subscriberInitialized=false;var errorMsg="EG_AV_ERROR_UNABLE_TO_SUBSCRIBE";switch(error.code){case 1600:case 2e3:{errorMsg="EG_AV_ERROR_SUBSCRIBE_INTERNAL";break}default:{errorMsg="EG_AV_ERROR_UNABLE_TO_SUBSCRIBE"}}ApplicationFactory.Translate("APP."+errorMsg).then(function(msg){factory.Alert(msg,error.message)})}else{factory.state.subscriberInitialized=true}};factory.InitiatePopout=function(){factory.PersistStateData();factory.TriggerPopout()};factory.PersistStateData=function(){ApplicationFactory.PersistToParentStorage("EGAIN_AV_CHAT_STATE_DATA",JSON.stringify(factory.StateData()),"session")};factory.RemoveStateData=function(){ApplicationFactory.RemoveFromParentStorage("EGAIN_AV_CHAT_STATE_DATA","session")};factory.TriggerPopout=function(){var p=ApplicationFactory.CreatePayload("POPOUT","POPOUT_START","","EGLV_DOCK_POPOUT");p.compatible={isRelayImplementedInTemplate:true};ApplicationFactory.PostMessageToParent(p,"*")};factory.StateData=function(stateData){if(stateData){factory.state=stateData}return factory.state};factory.SetVideoNotInProgressFlags=function(stateData){if(stateData){stateData.videoShowing=false}};factory.GetAVChatStateDataFromURL=function(){var stateData=ApplicationFactory.GetParameterFromUrlOrStorage("EGAIN_AV_CHAT_STATE_DATA","session");if(stateData){stateData=JSON.parse(decodeURIComponent(stateData));factory.SetVideoNotInProgressFlags(stateData);factory.StateData(stateData)}};factory.GetAVChatStateDataFromURL();$rootScope.$on("application_service_chat_connection_completion_event",function(event){factory.OnChatCompletionHandler()});$rootScope.$on("application_service_chat_transfer_event",function(event,data){if(data){factory.isChatTransferred=true;factory.onAgentJoinedHandler(false)}});factory.onAgentJoinedHandler=function(joined){factory.state.isAgentJoined=joined;factory.AdjustVideoAudioChatButtons()};$rootScope.$on("application_service_agent_joined_event",function(event,data){if(data){factory.onAgentJoinedHandler(true)}});factory.SaveButtonStateOnTransfer=function(){if(true===factory.isChatTransferred){var data=factory.GetAVChatButtonsStateWithoutTransferLogic();factory.state.transfer={};factory.SetTransferStateData(data);factory.PersistStateData()}};factory.SetTransferStateData=function(data){if(factory.state.transfer&&data){factory.state.transfer.buttonState={};factory.state.transfer.buttonState.showVideoChatButton=data.showVideoChatButton;factory.state.transfer.buttonState.showAudioChatButton=data.showAudioChatButton}};factory.GetAllL10Ns=function(){var l10nList=["APP.EG_AV_RESTORE_WINDOW","APP.EG_AV_MAXIMIZE_WINDOW","APP.EG_AV_PAUSE_VIDEO","APP.EG_AV_RESUME_VIDEO","APP.EG_AV_PAUSE_AUDIO","APP.EG_AV_RESUME_AUDIO","APP.EG_AV_END"];ApplicationFactory.Translate(l10nList).then(function(list){if(list){factory.l10n={};factory.l10n["EG_AV_RESTORE_WINDOW"]=list["APP.EG_AV_RESTORE_WINDOW"];factory.l10n["EG_AV_MAXIMIZE_WINDOW"]=list["APP.EG_AV_MAXIMIZE_WINDOW"];factory.l10n["EG_AV_PAUSE_VIDEO"]=list["APP.EG_AV_PAUSE_VIDEO"];factory.l10n["EG_AV_RESUME_VIDEO"]=list["APP.EG_AV_RESUME_VIDEO"];factory.l10n["EG_AV_PAUSE_AUDIO"]=list["APP.EG_AV_PAUSE_AUDIO"];factory.l10n["EG_AV_RESUME_AUDIO"]=list["APP.EG_AV_RESUME_AUDIO"];factory.l10n["EG_AV_END"]=list["APP.EG_AV_END"]}})};factory.GetAllL10Ns();factory.GetVideoChatFromURL=function(){var video=ApplicationFactory.GetUrlParameter("video");video=video?parseInt(video):video;factory.state.videochat=1===video};factory.GetVideoChatFromURL();factory.GetAVModeFromURL=function(){var avmode=ApplicationFactory.GetUrlParameter("avmode");factory.state.avmode=avmode?parseInt(avmode):factory.state.avmode};factory.GetAVModeFromURL();factory.GetAVMode=function(){var avmode=factory.state.avmode;if(4<factory.state.videoChatMaxEscalation){}else if(2===factory.state.videoChatMaxEscalation){if(0<factory.state.avmode){avmode=factory.TWO_WAY_AUDIO_MODE}}else if(3===factory.state.videoChatMaxEscalation){if(factory.state.avmode===factory.TWO_WAY_AUDIO_VIDEO_MODE){avmode=factory.TWO_WAY_AUDIO_CUSTOMER_VIDEO_MODE}else if(factory.state.avmode===factory.TWO_WAY_AUDIO_AGENT_VIDEO_MODE){avmode=factory.TWO_WAY_AUDIO_MODE}}else if(4===factory.state.videoChatMaxEscalation){if(factory.state.avmode===factory.TWO_WAY_AUDIO_VIDEO_MODE){avmode=factory.TWO_WAY_AUDIO_AGENT_VIDEO_MODE}else if(factory.state.avmode===factory.TWO_WAY_AUDIO_CUSTOMER_VIDEO_MODE){avmode=factory.TWO_WAY_AUDIO_MODE}}return avmode};factory.IsWindowReadyForAVChat=function(){var ready=true;ready=true===ApplicationFactory.isPoppedOut()||false===ApplicationFactory.IsDocked();return ready};factory.ToggleFrameMaximise=function(maximise){factory.avChatFrameMaximised="boolean"===typeof maximise?maximise:!factory.avChatFrameMaximised;toggleChatWindowMaximise(factory.avChatFrameMaximised);$rootScope.$broadcast("application_service_avchat_maximised",factory.avChatFrameMaximised);return factory.avChatFrameMaximised};var toggleChatWindowMaximise=function(maximise){var isWindowMaximised=false;try{if(_popoutWindow&&false===_popoutWindow.closed){if(true===maximise&&0>_saveWidth){_saveTop=_popoutWindow.screenTop?_popoutWindow.screenTop:_popoutWindow.screenY;_saveLeft=_popoutWindow.screenLeft?_popoutWindow.screenLeft:_popoutWindow.screenX;_saveHeight=_popoutWindow.outerHeight;_saveWidth=_popoutWindow.outerWidth;_popoutWindow.moveTo(_saveLeft,_saveTop);_saveTop=_saveTop+_saveTop-(_popoutWindow.screenTop?_popoutWindow.screenTop:_popoutWindow.screenY);_saveLeft=_saveLeft+_saveLeft-(_popoutWindow.screenLeft?_popoutWindow.screenLeft:_popoutWindow.screenX);_popoutWindow.moveTo(0,0);_popoutWindow.resizeTo($window.screen.availWidth,$window.screen.availHeight);isWindowMaximised=true}else if(0<_saveWidth){_popoutWindow.resizeTo(_saveWidth,_saveHeight);_popoutWindow.moveTo(_saveLeft,_saveTop);_saveTop=-1;_saveLeft=-1;_saveHeight=-1;_saveWidth=-1}}}catch(err){console.log("Failed to toggle window maximize.")}return isWindowMaximised};return factory}]);